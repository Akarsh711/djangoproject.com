{"parents": [{"link": "../../../../", "title": "Module code"}, {"link": "../../../", "title": "django"}], "title": "django.contrib.sessions.middleware", "body": "<h1>Source code for django.contrib.sessions.middleware</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">time</span>\n<span class=\"kn\">from</span> <span class=\"nn\">importlib</span> <span class=\"kn\">import</span> <span class=\"n\">import_module</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">django.conf</span> <span class=\"kn\">import</span> <span class=\"n\">settings</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.contrib.sessions.backends.base</span> <span class=\"kn\">import</span> <span class=\"n\">UpdateError</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.contrib.sessions.exceptions</span> <span class=\"kn\">import</span> <span class=\"n\">SessionInterrupted</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils.cache</span> <span class=\"kn\">import</span> <span class=\"n\">patch_vary_headers</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils.deprecation</span> <span class=\"kn\">import</span> <span class=\"n\">MiddlewareMixin</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils.http</span> <span class=\"kn\">import</span> <span class=\"n\">http_date</span>\n\n\n<div class=\"viewcode-block\" id=\"SessionMiddleware\"><a class=\"viewcode-back\" href=\"../../../../../ref/middleware/#django.contrib.sessions.middleware.SessionMiddleware\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">SessionMiddleware</span><span class=\"p\">(</span><span class=\"n\">MiddlewareMixin</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">get_response</span><span class=\"p\">):</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"n\">get_response</span><span class=\"p\">)</span>\n        <span class=\"n\">engine</span> <span class=\"o\">=</span> <span class=\"n\">import_module</span><span class=\"p\">(</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">SESSION_ENGINE</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">SessionStore</span> <span class=\"o\">=</span> <span class=\"n\">engine</span><span class=\"o\">.</span><span class=\"n\">SessionStore</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">process_request</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"p\">):</span>\n        <span class=\"n\">session_key</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">COOKIES</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">SESSION_COOKIE_NAME</span><span class=\"p\">)</span>\n        <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">session</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">SessionStore</span><span class=\"p\">(</span><span class=\"n\">session_key</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">process_response</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">response</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        If request.session was modified, or if the configuration is to save the</span>\n<span class=\"sd\">        session every time, save the changes and set a session cookie or delete</span>\n<span class=\"sd\">        the session cookie if the session has been emptied.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">accessed</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">session</span><span class=\"o\">.</span><span class=\"n\">accessed</span>\n            <span class=\"n\">modified</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">session</span><span class=\"o\">.</span><span class=\"n\">modified</span>\n            <span class=\"n\">empty</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">session</span><span class=\"o\">.</span><span class=\"n\">is_empty</span><span class=\"p\">()</span>\n        <span class=\"k\">except</span> <span class=\"ne\">AttributeError</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">response</span>\n        <span class=\"c1\"># First check if we need to delete this cookie.</span>\n        <span class=\"c1\"># The session should be deleted only if the session is entirely empty.</span>\n        <span class=\"k\">if</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">SESSION_COOKIE_NAME</span> <span class=\"ow\">in</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">COOKIES</span> <span class=\"ow\">and</span> <span class=\"n\">empty</span><span class=\"p\">:</span>\n            <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">delete_cookie</span><span class=\"p\">(</span>\n                <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">SESSION_COOKIE_NAME</span><span class=\"p\">,</span>\n                <span class=\"n\">path</span><span class=\"o\">=</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">SESSION_COOKIE_PATH</span><span class=\"p\">,</span>\n                <span class=\"n\">domain</span><span class=\"o\">=</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">SESSION_COOKIE_DOMAIN</span><span class=\"p\">,</span>\n                <span class=\"n\">samesite</span><span class=\"o\">=</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">SESSION_COOKIE_SAMESITE</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">patch_vary_headers</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"s2\">&quot;Cookie&quot;</span><span class=\"p\">,))</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">accessed</span><span class=\"p\">:</span>\n                <span class=\"n\">patch_vary_headers</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"s2\">&quot;Cookie&quot;</span><span class=\"p\">,))</span>\n            <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">modified</span> <span class=\"ow\">or</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">SESSION_SAVE_EVERY_REQUEST</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">empty</span><span class=\"p\">:</span>\n                <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">session</span><span class=\"o\">.</span><span class=\"n\">get_expire_at_browser_close</span><span class=\"p\">():</span>\n                    <span class=\"n\">max_age</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n                    <span class=\"n\">expires</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n                <span class=\"k\">else</span><span class=\"p\">:</span>\n                    <span class=\"n\">max_age</span> <span class=\"o\">=</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">session</span><span class=\"o\">.</span><span class=\"n\">get_expiry_age</span><span class=\"p\">()</span>\n                    <span class=\"n\">expires_time</span> <span class=\"o\">=</span> <span class=\"n\">time</span><span class=\"o\">.</span><span class=\"n\">time</span><span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"n\">max_age</span>\n                    <span class=\"n\">expires</span> <span class=\"o\">=</span> <span class=\"n\">http_date</span><span class=\"p\">(</span><span class=\"n\">expires_time</span><span class=\"p\">)</span>\n                <span class=\"c1\"># Save the session data and refresh the client cookie.</span>\n                <span class=\"c1\"># Skip session save for 5xx responses.</span>\n                <span class=\"k\">if</span> <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">status_code</span> <span class=\"o\">&lt;</span> <span class=\"mi\">500</span><span class=\"p\">:</span>\n                    <span class=\"k\">try</span><span class=\"p\">:</span>\n                        <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">session</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n                    <span class=\"k\">except</span> <span class=\"n\">UpdateError</span><span class=\"p\">:</span>\n                        <span class=\"k\">raise</span> <span class=\"n\">SessionInterrupted</span><span class=\"p\">(</span>\n                            <span class=\"s2\">&quot;The request&#39;s session was deleted before the &quot;</span>\n                            <span class=\"s2\">&quot;request completed. The user may have logged &quot;</span>\n                            <span class=\"s2\">&quot;out in a concurrent request, for example.&quot;</span>\n                        <span class=\"p\">)</span>\n                    <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">set_cookie</span><span class=\"p\">(</span>\n                        <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">SESSION_COOKIE_NAME</span><span class=\"p\">,</span>\n                        <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">session</span><span class=\"o\">.</span><span class=\"n\">session_key</span><span class=\"p\">,</span>\n                        <span class=\"n\">max_age</span><span class=\"o\">=</span><span class=\"n\">max_age</span><span class=\"p\">,</span>\n                        <span class=\"n\">expires</span><span class=\"o\">=</span><span class=\"n\">expires</span><span class=\"p\">,</span>\n                        <span class=\"n\">domain</span><span class=\"o\">=</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">SESSION_COOKIE_DOMAIN</span><span class=\"p\">,</span>\n                        <span class=\"n\">path</span><span class=\"o\">=</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">SESSION_COOKIE_PATH</span><span class=\"p\">,</span>\n                        <span class=\"n\">secure</span><span class=\"o\">=</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">SESSION_COOKIE_SECURE</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n                        <span class=\"n\">httponly</span><span class=\"o\">=</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">SESSION_COOKIE_HTTPONLY</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n                        <span class=\"n\">samesite</span><span class=\"o\">=</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">SESSION_COOKIE_SAMESITE</span><span class=\"p\">,</span>\n                    <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">response</span></div>\n</pre></div>", "current_page_name": "_modules/django/contrib/sessions/middleware", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "favicon_url": null, "logo_url": null, "alabaster_version": "0.7.13", "include_console_assets": false}