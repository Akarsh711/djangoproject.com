{"parents": [{"link": "../../../../../", "title": "Module code"}, {"link": "../../../../", "title": "django"}], "title": "django.db.models.functions.datetime", "body": "<h1>Source code for django.db.models.functions.datetime</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">from</span> <span class=\"nn\">datetime</span> <span class=\"kn\">import</span> <span class=\"n\">datetime</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">django.conf</span> <span class=\"kn\">import</span> <span class=\"n\">settings</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models.expressions</span> <span class=\"kn\">import</span> <span class=\"n\">Func</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models.fields</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">DateField</span><span class=\"p\">,</span>\n    <span class=\"n\">DateTimeField</span><span class=\"p\">,</span>\n    <span class=\"n\">DurationField</span><span class=\"p\">,</span>\n    <span class=\"n\">Field</span><span class=\"p\">,</span>\n    <span class=\"n\">IntegerField</span><span class=\"p\">,</span>\n    <span class=\"n\">TimeField</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models.lookups</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">Transform</span><span class=\"p\">,</span>\n    <span class=\"n\">YearExact</span><span class=\"p\">,</span>\n    <span class=\"n\">YearGt</span><span class=\"p\">,</span>\n    <span class=\"n\">YearGte</span><span class=\"p\">,</span>\n    <span class=\"n\">YearLt</span><span class=\"p\">,</span>\n    <span class=\"n\">YearLte</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils</span> <span class=\"kn\">import</span> <span class=\"n\">timezone</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">TimezoneMixin</span><span class=\"p\">:</span>\n    <span class=\"n\">tzinfo</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_tzname</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Timezone conversions must happen to the input datetime *before*</span>\n        <span class=\"c1\"># applying a function. 2015-12-31 23:00:00 -02:00 is stored in the</span>\n        <span class=\"c1\"># database as 2016-01-01 01:00:00 +00:00. Any results should be</span>\n        <span class=\"c1\"># based on the input datetime not the stored datetime.</span>\n        <span class=\"n\">tzname</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">if</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">USE_TZ</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">tzinfo</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"n\">tzname</span> <span class=\"o\">=</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">get_current_timezone_name</span><span class=\"p\">()</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">tzname</span> <span class=\"o\">=</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">_get_timezone_name</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">tzinfo</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">tzname</span>\n\n\n<div class=\"viewcode-block\" id=\"Extract\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.Extract\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">Extract</span><span class=\"p\">(</span><span class=\"n\">TimezoneMixin</span><span class=\"p\">,</span> <span class=\"n\">Transform</span><span class=\"p\">):</span>\n    <span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"n\">output_field</span> <span class=\"o\">=</span> <span class=\"n\">IntegerField</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">expression</span><span class=\"p\">,</span> <span class=\"n\">lookup_name</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">tzinfo</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">extra</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">lookup_name</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"n\">lookup_name</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">lookup_name</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;lookup_name must be provided&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">tzinfo</span> <span class=\"o\">=</span> <span class=\"n\">tzinfo</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"n\">expression</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">extra</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">as_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">compiler</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">):</span>\n        <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"n\">compiler</span><span class=\"o\">.</span><span class=\"n\">compile</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">lhs</span><span class=\"p\">)</span>\n        <span class=\"n\">lhs_output_field</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">lhs</span><span class=\"o\">.</span><span class=\"n\">output_field</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">lhs_output_field</span><span class=\"p\">,</span> <span class=\"n\">DateTimeField</span><span class=\"p\">):</span>\n            <span class=\"n\">tzname</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_tzname</span><span class=\"p\">()</span>\n            <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">datetime_extract_sql</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">lookup_name</span><span class=\"p\">,</span> <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">),</span> <span class=\"n\">tzname</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">tzinfo</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;tzinfo can only be used with DateTimeField.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">lhs_output_field</span><span class=\"p\">,</span> <span class=\"n\">DateField</span><span class=\"p\">):</span>\n            <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">date_extract_sql</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">lookup_name</span><span class=\"p\">,</span> <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">lhs_output_field</span><span class=\"p\">,</span> <span class=\"n\">TimeField</span><span class=\"p\">):</span>\n            <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">time_extract_sql</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">lookup_name</span><span class=\"p\">,</span> <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">lhs_output_field</span><span class=\"p\">,</span> <span class=\"n\">DurationField</span><span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">has_native_duration_field</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Extract requires native DurationField database support.&quot;</span>\n                <span class=\"p\">)</span>\n            <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">time_extract_sql</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">lookup_name</span><span class=\"p\">,</span> <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"c1\"># resolve_expression has already validated the output_field so this</span>\n            <span class=\"c1\"># assert should never be hit.</span>\n            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Tried to Extract from an invalid type.&quot;</span>\n        <span class=\"k\">return</span> <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">resolve_expression</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">allow_joins</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">reuse</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">summarize</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">for_save</span><span class=\"o\">=</span><span class=\"kc\">False</span>\n    <span class=\"p\">):</span>\n        <span class=\"n\">copy</span> <span class=\"o\">=</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">resolve_expression</span><span class=\"p\">(</span>\n            <span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"n\">allow_joins</span><span class=\"p\">,</span> <span class=\"n\">reuse</span><span class=\"p\">,</span> <span class=\"n\">summarize</span><span class=\"p\">,</span> <span class=\"n\">for_save</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">field</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">copy</span><span class=\"o\">.</span><span class=\"n\">lhs</span><span class=\"p\">,</span> <span class=\"s2\">&quot;output_field&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">field</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">copy</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"n\">DateField</span><span class=\"p\">,</span> <span class=\"n\">DateTimeField</span><span class=\"p\">,</span> <span class=\"n\">TimeField</span><span class=\"p\">,</span> <span class=\"n\">DurationField</span><span class=\"p\">)):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Extract input expression must be DateField, DateTimeField, &quot;</span>\n                <span class=\"s2\">&quot;TimeField, or DurationField.&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"c1\"># Passing dates to functions expecting datetimes is most likely a mistake.</span>\n        <span class=\"k\">if</span> <span class=\"nb\">type</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"n\">DateField</span> <span class=\"ow\">and</span> <span class=\"n\">copy</span><span class=\"o\">.</span><span class=\"n\">lookup_name</span> <span class=\"ow\">in</span> <span class=\"p\">(</span>\n            <span class=\"s2\">&quot;hour&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;minute&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;second&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Cannot extract time component &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; from DateField &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39;.&quot;</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">copy</span><span class=\"o\">.</span><span class=\"n\">lookup_name</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">DurationField</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">copy</span><span class=\"o\">.</span><span class=\"n\">lookup_name</span> <span class=\"ow\">in</span> <span class=\"p\">(</span>\n            <span class=\"s2\">&quot;year&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;iso_year&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;month&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;week&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;week_day&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;iso_week_day&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;quarter&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Cannot extract component &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; from DurationField &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39;.&quot;</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">copy</span><span class=\"o\">.</span><span class=\"n\">lookup_name</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">copy</span></div>\n\n\n<div class=\"viewcode-block\" id=\"ExtractYear\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.ExtractYear\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">ExtractYear</span><span class=\"p\">(</span><span class=\"n\">Extract</span><span class=\"p\">):</span>\n    <span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;year&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"ExtractIsoYear\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.ExtractIsoYear\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">ExtractIsoYear</span><span class=\"p\">(</span><span class=\"n\">Extract</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Return the ISO-8601 week-numbering year.&quot;&quot;&quot;</span>\n\n    <span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;iso_year&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"ExtractMonth\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.ExtractMonth\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">ExtractMonth</span><span class=\"p\">(</span><span class=\"n\">Extract</span><span class=\"p\">):</span>\n    <span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;month&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"ExtractDay\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.ExtractDay\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">ExtractDay</span><span class=\"p\">(</span><span class=\"n\">Extract</span><span class=\"p\">):</span>\n    <span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;day&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"ExtractWeek\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.ExtractWeek\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">ExtractWeek</span><span class=\"p\">(</span><span class=\"n\">Extract</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Return 1-52 or 53, based on ISO-8601, i.e., Monday is the first of the</span>\n<span class=\"sd\">    week.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;week&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"ExtractWeekDay\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.ExtractWeekDay\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">ExtractWeekDay</span><span class=\"p\">(</span><span class=\"n\">Extract</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Return Sunday=1 through Saturday=7.</span>\n\n<span class=\"sd\">    To replicate this in Python: (mydatetime.isoweekday() % 7) + 1</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;week_day&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"ExtractIsoWeekDay\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.ExtractIsoWeekDay\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">ExtractIsoWeekDay</span><span class=\"p\">(</span><span class=\"n\">Extract</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Return Monday=1 through Sunday=7, based on ISO-8601.&quot;&quot;&quot;</span>\n\n    <span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;iso_week_day&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"ExtractQuarter\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.ExtractQuarter\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">ExtractQuarter</span><span class=\"p\">(</span><span class=\"n\">Extract</span><span class=\"p\">):</span>\n    <span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;quarter&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"ExtractHour\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.ExtractHour\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">ExtractHour</span><span class=\"p\">(</span><span class=\"n\">Extract</span><span class=\"p\">):</span>\n    <span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;hour&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"ExtractMinute\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.ExtractMinute\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">ExtractMinute</span><span class=\"p\">(</span><span class=\"n\">Extract</span><span class=\"p\">):</span>\n    <span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;minute&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"ExtractSecond\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.ExtractSecond\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">ExtractSecond</span><span class=\"p\">(</span><span class=\"n\">Extract</span><span class=\"p\">):</span>\n    <span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;second&quot;</span></div>\n\n\n<span class=\"n\">DateField</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">ExtractYear</span><span class=\"p\">)</span>\n<span class=\"n\">DateField</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">ExtractMonth</span><span class=\"p\">)</span>\n<span class=\"n\">DateField</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">ExtractDay</span><span class=\"p\">)</span>\n<span class=\"n\">DateField</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">ExtractWeekDay</span><span class=\"p\">)</span>\n<span class=\"n\">DateField</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">ExtractIsoWeekDay</span><span class=\"p\">)</span>\n<span class=\"n\">DateField</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">ExtractWeek</span><span class=\"p\">)</span>\n<span class=\"n\">DateField</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">ExtractIsoYear</span><span class=\"p\">)</span>\n<span class=\"n\">DateField</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">ExtractQuarter</span><span class=\"p\">)</span>\n\n<span class=\"n\">TimeField</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">ExtractHour</span><span class=\"p\">)</span>\n<span class=\"n\">TimeField</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">ExtractMinute</span><span class=\"p\">)</span>\n<span class=\"n\">TimeField</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">ExtractSecond</span><span class=\"p\">)</span>\n\n<span class=\"n\">DateTimeField</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">ExtractHour</span><span class=\"p\">)</span>\n<span class=\"n\">DateTimeField</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">ExtractMinute</span><span class=\"p\">)</span>\n<span class=\"n\">DateTimeField</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">ExtractSecond</span><span class=\"p\">)</span>\n\n<span class=\"n\">ExtractYear</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">YearExact</span><span class=\"p\">)</span>\n<span class=\"n\">ExtractYear</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">YearGt</span><span class=\"p\">)</span>\n<span class=\"n\">ExtractYear</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">YearGte</span><span class=\"p\">)</span>\n<span class=\"n\">ExtractYear</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">YearLt</span><span class=\"p\">)</span>\n<span class=\"n\">ExtractYear</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">YearLte</span><span class=\"p\">)</span>\n\n<span class=\"n\">ExtractIsoYear</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">YearExact</span><span class=\"p\">)</span>\n<span class=\"n\">ExtractIsoYear</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">YearGt</span><span class=\"p\">)</span>\n<span class=\"n\">ExtractIsoYear</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">YearGte</span><span class=\"p\">)</span>\n<span class=\"n\">ExtractIsoYear</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">YearLt</span><span class=\"p\">)</span>\n<span class=\"n\">ExtractIsoYear</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">YearLte</span><span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"Now\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.Now\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">Now</span><span class=\"p\">(</span><span class=\"n\">Func</span><span class=\"p\">):</span>\n    <span class=\"n\">template</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;CURRENT_TIMESTAMP&quot;</span>\n    <span class=\"n\">output_field</span> <span class=\"o\">=</span> <span class=\"n\">DateTimeField</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">as_postgresql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">compiler</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">extra_context</span><span class=\"p\">):</span>\n        <span class=\"c1\"># PostgreSQL&#39;s CURRENT_TIMESTAMP means &quot;the time at the start of the</span>\n        <span class=\"c1\"># transaction&quot;. Use STATEMENT_TIMESTAMP to be cross-compatible with</span>\n        <span class=\"c1\"># other databases.</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">as_sql</span><span class=\"p\">(</span>\n            <span class=\"n\">compiler</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">,</span> <span class=\"n\">template</span><span class=\"o\">=</span><span class=\"s2\">&quot;STATEMENT_TIMESTAMP()&quot;</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">extra_context</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">as_mysql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">compiler</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">extra_context</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">as_sql</span><span class=\"p\">(</span>\n            <span class=\"n\">compiler</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">,</span> <span class=\"n\">template</span><span class=\"o\">=</span><span class=\"s2\">&quot;CURRENT_TIMESTAMP(6)&quot;</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">extra_context</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">as_sqlite</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">compiler</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">extra_context</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">as_sql</span><span class=\"p\">(</span>\n            <span class=\"n\">compiler</span><span class=\"p\">,</span>\n            <span class=\"n\">connection</span><span class=\"p\">,</span>\n            <span class=\"n\">template</span><span class=\"o\">=</span><span class=\"s2\">&quot;STRFTIME(&#39;</span><span class=\"si\">%%%%</span><span class=\"s2\">Y-</span><span class=\"si\">%%%%</span><span class=\"s2\">m-</span><span class=\"si\">%%%%</span><span class=\"s2\">d </span><span class=\"si\">%%%%</span><span class=\"s2\">H:</span><span class=\"si\">%%%%</span><span class=\"s2\">M:</span><span class=\"si\">%%%%</span><span class=\"s2\">f&#39;, &#39;NOW&#39;)&quot;</span><span class=\"p\">,</span>\n            <span class=\"o\">**</span><span class=\"n\">extra_context</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">as_oracle</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">compiler</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">extra_context</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">as_sql</span><span class=\"p\">(</span>\n            <span class=\"n\">compiler</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">,</span> <span class=\"n\">template</span><span class=\"o\">=</span><span class=\"s2\">&quot;LOCALTIMESTAMP&quot;</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">extra_context</span>\n        <span class=\"p\">)</span></div>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">TruncBase</span><span class=\"p\">(</span><span class=\"n\">TimezoneMixin</span><span class=\"p\">,</span> <span class=\"n\">Transform</span><span class=\"p\">):</span>\n    <span class=\"n\">kind</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"n\">tzinfo</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">expression</span><span class=\"p\">,</span>\n        <span class=\"n\">output_field</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">tzinfo</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"o\">**</span><span class=\"n\">extra</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">tzinfo</span> <span class=\"o\">=</span> <span class=\"n\">tzinfo</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"n\">expression</span><span class=\"p\">,</span> <span class=\"n\">output_field</span><span class=\"o\">=</span><span class=\"n\">output_field</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">extra</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">as_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">compiler</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">):</span>\n        <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"n\">compiler</span><span class=\"o\">.</span><span class=\"n\">compile</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">lhs</span><span class=\"p\">)</span>\n        <span class=\"n\">tzname</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">lhs</span><span class=\"o\">.</span><span class=\"n\">output_field</span><span class=\"p\">,</span> <span class=\"n\">DateTimeField</span><span class=\"p\">):</span>\n            <span class=\"n\">tzname</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_tzname</span><span class=\"p\">()</span>\n        <span class=\"k\">elif</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">tzinfo</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;tzinfo can only be used with DateTimeField.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">output_field</span><span class=\"p\">,</span> <span class=\"n\">DateTimeField</span><span class=\"p\">):</span>\n            <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">datetime_trunc_sql</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">kind</span><span class=\"p\">,</span> <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">),</span> <span class=\"n\">tzname</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">output_field</span><span class=\"p\">,</span> <span class=\"n\">DateField</span><span class=\"p\">):</span>\n            <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">date_trunc_sql</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">kind</span><span class=\"p\">,</span> <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">),</span> <span class=\"n\">tzname</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">output_field</span><span class=\"p\">,</span> <span class=\"n\">TimeField</span><span class=\"p\">):</span>\n            <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">time_trunc_sql</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">kind</span><span class=\"p\">,</span> <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">),</span> <span class=\"n\">tzname</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Trunc only valid on DateField, TimeField, or DateTimeField.&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">resolve_expression</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">allow_joins</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">reuse</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">summarize</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">for_save</span><span class=\"o\">=</span><span class=\"kc\">False</span>\n    <span class=\"p\">):</span>\n        <span class=\"n\">copy</span> <span class=\"o\">=</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">resolve_expression</span><span class=\"p\">(</span>\n            <span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"n\">allow_joins</span><span class=\"p\">,</span> <span class=\"n\">reuse</span><span class=\"p\">,</span> <span class=\"n\">summarize</span><span class=\"p\">,</span> <span class=\"n\">for_save</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">field</span> <span class=\"o\">=</span> <span class=\"n\">copy</span><span class=\"o\">.</span><span class=\"n\">lhs</span><span class=\"o\">.</span><span class=\"n\">output_field</span>\n        <span class=\"c1\"># DateTimeField is a subclass of DateField so this works for both.</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"n\">DateField</span><span class=\"p\">,</span> <span class=\"n\">TimeField</span><span class=\"p\">)):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;</span><span class=\"si\">%r</span><span class=\"s2\"> isn&#39;t a DateField, TimeField, or DateTimeField.&quot;</span> <span class=\"o\">%</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">name</span>\n            <span class=\"p\">)</span>\n        <span class=\"c1\"># If self.output_field was None, then accessing the field will trigger</span>\n        <span class=\"c1\"># the resolver to assign it to self.lhs.output_field.</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">copy</span><span class=\"o\">.</span><span class=\"n\">output_field</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"n\">DateField</span><span class=\"p\">,</span> <span class=\"n\">DateTimeField</span><span class=\"p\">,</span> <span class=\"n\">TimeField</span><span class=\"p\">)):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;output_field must be either DateField, TimeField, or DateTimeField&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"c1\"># Passing dates or times to functions expecting datetimes is most</span>\n        <span class=\"c1\"># likely a mistake.</span>\n        <span class=\"n\">class_output_field</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"n\">output_field</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"n\">output_field</span><span class=\"p\">,</span> <span class=\"n\">Field</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span> <span class=\"kc\">None</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">output_field</span> <span class=\"o\">=</span> <span class=\"n\">class_output_field</span> <span class=\"ow\">or</span> <span class=\"n\">copy</span><span class=\"o\">.</span><span class=\"n\">output_field</span>\n        <span class=\"n\">has_explicit_output_field</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">class_output_field</span> <span class=\"ow\">or</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"vm\">__class__</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"n\">copy</span><span class=\"o\">.</span><span class=\"n\">output_field</span><span class=\"o\">.</span><span class=\"vm\">__class__</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"nb\">type</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"n\">DateField</span> <span class=\"ow\">and</span> <span class=\"p\">(</span>\n            <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">output_field</span><span class=\"p\">,</span> <span class=\"n\">DateTimeField</span><span class=\"p\">)</span>\n            <span class=\"ow\">or</span> <span class=\"n\">copy</span><span class=\"o\">.</span><span class=\"n\">kind</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s2\">&quot;hour&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;minute&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;second&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;time&quot;</span><span class=\"p\">)</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Cannot truncate DateField &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; to </span><span class=\"si\">%s</span><span class=\"s2\">.&quot;</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span>\n                    <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n                    <span class=\"n\">output_field</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"vm\">__name__</span>\n                    <span class=\"k\">if</span> <span class=\"n\">has_explicit_output_field</span>\n                    <span class=\"k\">else</span> <span class=\"s2\">&quot;DateTimeField&quot;</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">TimeField</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"p\">(</span>\n            <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">output_field</span><span class=\"p\">,</span> <span class=\"n\">DateTimeField</span><span class=\"p\">)</span>\n            <span class=\"ow\">or</span> <span class=\"n\">copy</span><span class=\"o\">.</span><span class=\"n\">kind</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s2\">&quot;year&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;quarter&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;month&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;week&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;day&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;date&quot;</span><span class=\"p\">)</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Cannot truncate TimeField &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; to </span><span class=\"si\">%s</span><span class=\"s2\">.&quot;</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span>\n                    <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n                    <span class=\"n\">output_field</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"vm\">__name__</span>\n                    <span class=\"k\">if</span> <span class=\"n\">has_explicit_output_field</span>\n                    <span class=\"k\">else</span> <span class=\"s2\">&quot;DateTimeField&quot;</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">copy</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">convert_value</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">expression</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">output_field</span><span class=\"p\">,</span> <span class=\"n\">DateTimeField</span><span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">USE_TZ</span><span class=\"p\">:</span>\n                <span class=\"k\">pass</span>\n            <span class=\"k\">elif</span> <span class=\"n\">value</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"n\">tzinfo</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">)</span>\n                <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">make_aware</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">tzinfo</span><span class=\"p\">)</span>\n            <span class=\"k\">elif</span> <span class=\"ow\">not</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">has_zoneinfo_database</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Database returned an invalid datetime value. Are time &quot;</span>\n                    <span class=\"s2\">&quot;zone definitions for your database installed?&quot;</span>\n                <span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">datetime</span><span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"n\">value</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"k\">pass</span>\n            <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">output_field</span><span class=\"p\">,</span> <span class=\"n\">DateField</span><span class=\"p\">):</span>\n                <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">date</span><span class=\"p\">()</span>\n            <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">output_field</span><span class=\"p\">,</span> <span class=\"n\">TimeField</span><span class=\"p\">):</span>\n                <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">time</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">value</span>\n\n\n<div class=\"viewcode-block\" id=\"Trunc\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.Trunc\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">Trunc</span><span class=\"p\">(</span><span class=\"n\">TruncBase</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">expression</span><span class=\"p\">,</span>\n        <span class=\"n\">kind</span><span class=\"p\">,</span>\n        <span class=\"n\">output_field</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">tzinfo</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"o\">**</span><span class=\"n\">extra</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">kind</span> <span class=\"o\">=</span> <span class=\"n\">kind</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"n\">expression</span><span class=\"p\">,</span> <span class=\"n\">output_field</span><span class=\"o\">=</span><span class=\"n\">output_field</span><span class=\"p\">,</span> <span class=\"n\">tzinfo</span><span class=\"o\">=</span><span class=\"n\">tzinfo</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">extra</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"TruncYear\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.TruncYear\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">TruncYear</span><span class=\"p\">(</span><span class=\"n\">TruncBase</span><span class=\"p\">):</span>\n    <span class=\"n\">kind</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;year&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"TruncQuarter\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.TruncQuarter\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">TruncQuarter</span><span class=\"p\">(</span><span class=\"n\">TruncBase</span><span class=\"p\">):</span>\n    <span class=\"n\">kind</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;quarter&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"TruncMonth\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.TruncMonth\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">TruncMonth</span><span class=\"p\">(</span><span class=\"n\">TruncBase</span><span class=\"p\">):</span>\n    <span class=\"n\">kind</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;month&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"TruncWeek\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.TruncWeek\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">TruncWeek</span><span class=\"p\">(</span><span class=\"n\">TruncBase</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Truncate to midnight on the Monday of the week.&quot;&quot;&quot;</span>\n\n    <span class=\"n\">kind</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;week&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"TruncDay\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.TruncDay\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">TruncDay</span><span class=\"p\">(</span><span class=\"n\">TruncBase</span><span class=\"p\">):</span>\n    <span class=\"n\">kind</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;day&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"TruncDate\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.TruncDate\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">TruncDate</span><span class=\"p\">(</span><span class=\"n\">TruncBase</span><span class=\"p\">):</span>\n    <span class=\"n\">kind</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;date&quot;</span>\n    <span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;date&quot;</span>\n    <span class=\"n\">output_field</span> <span class=\"o\">=</span> <span class=\"n\">DateField</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">as_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">compiler</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Cast to date rather than truncate to date.</span>\n        <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"n\">compiler</span><span class=\"o\">.</span><span class=\"n\">compile</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">lhs</span><span class=\"p\">)</span>\n        <span class=\"n\">tzname</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_tzname</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">datetime_cast_date_sql</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">),</span> <span class=\"n\">tzname</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"TruncTime\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.TruncTime\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">TruncTime</span><span class=\"p\">(</span><span class=\"n\">TruncBase</span><span class=\"p\">):</span>\n    <span class=\"n\">kind</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;time&quot;</span>\n    <span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;time&quot;</span>\n    <span class=\"n\">output_field</span> <span class=\"o\">=</span> <span class=\"n\">TimeField</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">as_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">compiler</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Cast to time rather than truncate to time.</span>\n        <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"n\">compiler</span><span class=\"o\">.</span><span class=\"n\">compile</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">lhs</span><span class=\"p\">)</span>\n        <span class=\"n\">tzname</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_tzname</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">datetime_cast_time_sql</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">),</span> <span class=\"n\">tzname</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"TruncHour\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.TruncHour\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">TruncHour</span><span class=\"p\">(</span><span class=\"n\">TruncBase</span><span class=\"p\">):</span>\n    <span class=\"n\">kind</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;hour&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"TruncMinute\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.TruncMinute\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">TruncMinute</span><span class=\"p\">(</span><span class=\"n\">TruncBase</span><span class=\"p\">):</span>\n    <span class=\"n\">kind</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;minute&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"TruncSecond\"><a class=\"viewcode-back\" href=\"../../../../../../ref/models/database-functions/#django.db.models.functions.TruncSecond\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">TruncSecond</span><span class=\"p\">(</span><span class=\"n\">TruncBase</span><span class=\"p\">):</span>\n    <span class=\"n\">kind</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;second&quot;</span></div>\n\n\n<span class=\"n\">DateTimeField</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">TruncDate</span><span class=\"p\">)</span>\n<span class=\"n\">DateTimeField</span><span class=\"o\">.</span><span class=\"n\">register_lookup</span><span class=\"p\">(</span><span class=\"n\">TruncTime</span><span class=\"p\">)</span>\n</pre></div>", "current_page_name": "_modules/django/db/models/functions/datetime", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "favicon_url": null, "logo_url": null, "alabaster_version": "0.7.13", "include_console_assets": false}
