{"parents": [{"link": "../../../", "title": "Module code"}, {"link": "../../", "title": "django"}], "title": "django.utils.log", "body": "<h1>Source code for django.utils.log</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">logging</span>\n<span class=\"kn\">import</span> <span class=\"nn\">logging.config</span>  <span class=\"c1\"># needed when logging_config doesn&#39;t start with logging.config</span>\n<span class=\"kn\">from</span> <span class=\"nn\">copy</span> <span class=\"kn\">import</span> <span class=\"n\">copy</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">django.conf</span> <span class=\"kn\">import</span> <span class=\"n\">settings</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core</span> <span class=\"kn\">import</span> <span class=\"n\">mail</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.mail</span> <span class=\"kn\">import</span> <span class=\"n\">get_connection</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.management.color</span> <span class=\"kn\">import</span> <span class=\"n\">color_style</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils.module_loading</span> <span class=\"kn\">import</span> <span class=\"n\">import_string</span>\n\n<span class=\"n\">request_logger</span> <span class=\"o\">=</span> <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">getLogger</span><span class=\"p\">(</span><span class=\"s2\">&quot;django.request&quot;</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># Default logging for Django. This sends an email to the site admins on every</span>\n<span class=\"c1\"># HTTP 500 error. Depending on DEBUG, all other log records are either sent to</span>\n<span class=\"c1\"># the console (DEBUG=True) or discarded (DEBUG=False) by means of the</span>\n<span class=\"c1\"># require_debug_true filter. This configuration is quoted in</span>\n<span class=\"c1\"># docs/ref/logging.txt; please amend it there if edited here.</span>\n<span class=\"n\">DEFAULT_LOGGING</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n    <span class=\"s2\">&quot;version&quot;</span><span class=\"p\">:</span> <span class=\"mi\">1</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;disable_existing_loggers&quot;</span><span class=\"p\">:</span> <span class=\"kc\">False</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;filters&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n        <span class=\"s2\">&quot;require_debug_false&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;()&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;django.utils.log.RequireDebugFalse&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">},</span>\n        <span class=\"s2\">&quot;require_debug_true&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;()&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;django.utils.log.RequireDebugTrue&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">},</span>\n    <span class=\"p\">},</span>\n    <span class=\"s2\">&quot;formatters&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n        <span class=\"s2\">&quot;django.server&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;()&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;django.utils.log.ServerFormatter&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;format&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;[</span><span class=\"si\">{server_time}</span><span class=\"s2\">] </span><span class=\"si\">{message}</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;style&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;{&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">}</span>\n    <span class=\"p\">},</span>\n    <span class=\"s2\">&quot;handlers&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n        <span class=\"s2\">&quot;console&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;level&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;INFO&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;filters&quot;</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"s2\">&quot;require_debug_true&quot;</span><span class=\"p\">],</span>\n            <span class=\"s2\">&quot;class&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;logging.StreamHandler&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">},</span>\n        <span class=\"s2\">&quot;django.server&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;level&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;INFO&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;class&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;logging.StreamHandler&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;formatter&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;django.server&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">},</span>\n        <span class=\"s2\">&quot;mail_admins&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;level&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;ERROR&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;filters&quot;</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"s2\">&quot;require_debug_false&quot;</span><span class=\"p\">],</span>\n            <span class=\"s2\">&quot;class&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;django.utils.log.AdminEmailHandler&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">},</span>\n    <span class=\"p\">},</span>\n    <span class=\"s2\">&quot;loggers&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n        <span class=\"s2\">&quot;django&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;handlers&quot;</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"s2\">&quot;console&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;mail_admins&quot;</span><span class=\"p\">],</span>\n            <span class=\"s2\">&quot;level&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;INFO&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">},</span>\n        <span class=\"s2\">&quot;django.server&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;handlers&quot;</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"s2\">&quot;django.server&quot;</span><span class=\"p\">],</span>\n            <span class=\"s2\">&quot;level&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;INFO&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;propagate&quot;</span><span class=\"p\">:</span> <span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"p\">},</span>\n    <span class=\"p\">},</span>\n<span class=\"p\">}</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">configure_logging</span><span class=\"p\">(</span><span class=\"n\">logging_config</span><span class=\"p\">,</span> <span class=\"n\">logging_settings</span><span class=\"p\">):</span>\n    <span class=\"k\">if</span> <span class=\"n\">logging_config</span><span class=\"p\">:</span>\n        <span class=\"c1\"># First find the logging configuration function ...</span>\n        <span class=\"n\">logging_config_func</span> <span class=\"o\">=</span> <span class=\"n\">import_string</span><span class=\"p\">(</span><span class=\"n\">logging_config</span><span class=\"p\">)</span>\n\n        <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">config</span><span class=\"o\">.</span><span class=\"n\">dictConfig</span><span class=\"p\">(</span><span class=\"n\">DEFAULT_LOGGING</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># ... then invoke it with the logging settings</span>\n        <span class=\"k\">if</span> <span class=\"n\">logging_settings</span><span class=\"p\">:</span>\n            <span class=\"n\">logging_config_func</span><span class=\"p\">(</span><span class=\"n\">logging_settings</span><span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"AdminEmailHandler\"><a class=\"viewcode-back\" href=\"../../../../ref/logging/#django.utils.log.AdminEmailHandler\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">AdminEmailHandler</span><span class=\"p\">(</span><span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">Handler</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;An exception log handler that emails log entries to site admins.</span>\n\n<span class=\"sd\">    If the request is passed as the first argument to the log record,</span>\n<span class=\"sd\">    request data will be provided in the email report.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">include_html</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">email_backend</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">reporter_class</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">include_html</span> <span class=\"o\">=</span> <span class=\"n\">include_html</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">email_backend</span> <span class=\"o\">=</span> <span class=\"n\">email_backend</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">reporter_class</span> <span class=\"o\">=</span> <span class=\"n\">import_string</span><span class=\"p\">(</span>\n            <span class=\"n\">reporter_class</span> <span class=\"ow\">or</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">DEFAULT_EXCEPTION_REPORTER</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">emit</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">record</span><span class=\"p\">):</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">request</span> <span class=\"o\">=</span> <span class=\"n\">record</span><span class=\"o\">.</span><span class=\"n\">request</span>\n            <span class=\"n\">subject</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\"> (</span><span class=\"si\">%s</span><span class=\"s2\"> IP): </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span>\n                <span class=\"n\">record</span><span class=\"o\">.</span><span class=\"n\">levelname</span><span class=\"p\">,</span>\n                <span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;internal&quot;</span>\n                    <span class=\"k\">if</span> <span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">META</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;REMOTE_ADDR&quot;</span><span class=\"p\">)</span> <span class=\"ow\">in</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">INTERNAL_IPS</span>\n                    <span class=\"k\">else</span> <span class=\"s2\">&quot;EXTERNAL&quot;</span>\n                <span class=\"p\">),</span>\n                <span class=\"n\">record</span><span class=\"o\">.</span><span class=\"n\">getMessage</span><span class=\"p\">(),</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"ne\">Exception</span><span class=\"p\">:</span>\n            <span class=\"n\">subject</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\">: </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">record</span><span class=\"o\">.</span><span class=\"n\">levelname</span><span class=\"p\">,</span> <span class=\"n\">record</span><span class=\"o\">.</span><span class=\"n\">getMessage</span><span class=\"p\">())</span>\n            <span class=\"n\">request</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"n\">subject</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">format_subject</span><span class=\"p\">(</span><span class=\"n\">subject</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Since we add a nicely formatted traceback on our own, create a copy</span>\n        <span class=\"c1\"># of the log record without the exception data.</span>\n        <span class=\"n\">no_exc_record</span> <span class=\"o\">=</span> <span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">record</span><span class=\"p\">)</span>\n        <span class=\"n\">no_exc_record</span><span class=\"o\">.</span><span class=\"n\">exc_info</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"n\">no_exc_record</span><span class=\"o\">.</span><span class=\"n\">exc_text</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">record</span><span class=\"o\">.</span><span class=\"n\">exc_info</span><span class=\"p\">:</span>\n            <span class=\"n\">exc_info</span> <span class=\"o\">=</span> <span class=\"n\">record</span><span class=\"o\">.</span><span class=\"n\">exc_info</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">exc_info</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">record</span><span class=\"o\">.</span><span class=\"n\">getMessage</span><span class=\"p\">(),</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n\n        <span class=\"n\">reporter</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">reporter_class</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">is_email</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">exc_info</span><span class=\"p\">)</span>\n        <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"se\">\\n\\n</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">no_exc_record</span><span class=\"p\">),</span>\n            <span class=\"n\">reporter</span><span class=\"o\">.</span><span class=\"n\">get_traceback_text</span><span class=\"p\">(),</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">html_message</span> <span class=\"o\">=</span> <span class=\"n\">reporter</span><span class=\"o\">.</span><span class=\"n\">get_traceback_html</span><span class=\"p\">()</span> <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">include_html</span> <span class=\"k\">else</span> <span class=\"kc\">None</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">send_mail</span><span class=\"p\">(</span><span class=\"n\">subject</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"n\">fail_silently</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">html_message</span><span class=\"o\">=</span><span class=\"n\">html_message</span><span class=\"p\">)</span>\n\n<div class=\"viewcode-block\" id=\"AdminEmailHandler.send_mail\"><a class=\"viewcode-back\" href=\"../../../../ref/logging/#django.utils.log.AdminEmailHandler.send_mail\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">send_mail</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">subject</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"n\">mail</span><span class=\"o\">.</span><span class=\"n\">mail_admins</span><span class=\"p\">(</span>\n            <span class=\"n\">subject</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">(),</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span>\n        <span class=\"p\">)</span></div>\n\n    <span class=\"k\">def</span> <span class=\"nf\">connection</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">get_connection</span><span class=\"p\">(</span><span class=\"n\">backend</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">email_backend</span><span class=\"p\">,</span> <span class=\"n\">fail_silently</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">format_subject</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">subject</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Escape CR and LF characters.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"n\">subject</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;</span><span class=\"se\">\\\\</span><span class=\"s2\">n&quot;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s2\">&quot;</span><span class=\"se\">\\r</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;</span><span class=\"se\">\\\\</span><span class=\"s2\">r&quot;</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"CallbackFilter\"><a class=\"viewcode-back\" href=\"../../../../ref/logging/#django.utils.log.CallbackFilter\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">CallbackFilter</span><span class=\"p\">(</span><span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">Filter</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    A logging filter that checks the return value of a given callable (which</span>\n<span class=\"sd\">    takes the record-to-be-logged as its only parameter) to decide whether to</span>\n<span class=\"sd\">    log a record.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">callback</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">callback</span> <span class=\"o\">=</span> <span class=\"n\">callback</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">filter</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">record</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">callback</span><span class=\"p\">(</span><span class=\"n\">record</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"mi\">1</span>\n        <span class=\"k\">return</span> <span class=\"mi\">0</span></div>\n\n\n<div class=\"viewcode-block\" id=\"RequireDebugFalse\"><a class=\"viewcode-back\" href=\"../../../../ref/logging/#django.utils.log.RequireDebugFalse\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">RequireDebugFalse</span><span class=\"p\">(</span><span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">Filter</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"nf\">filter</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">record</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"ow\">not</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">DEBUG</span></div>\n\n\n<div class=\"viewcode-block\" id=\"RequireDebugTrue\"><a class=\"viewcode-back\" href=\"../../../../ref/logging/#django.utils.log.RequireDebugTrue\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">RequireDebugTrue</span><span class=\"p\">(</span><span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">Filter</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"nf\">filter</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">record</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">DEBUG</span></div>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">ServerFormatter</span><span class=\"p\">(</span><span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">Formatter</span><span class=\"p\">):</span>\n    <span class=\"n\">default_time_format</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%d</span><span class=\"s2\">/%b/%Y %H:%M:%S&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">style</span> <span class=\"o\">=</span> <span class=\"n\">color_style</span><span class=\"p\">()</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">format</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">record</span><span class=\"p\">):</span>\n        <span class=\"n\">msg</span> <span class=\"o\">=</span> <span class=\"n\">record</span><span class=\"o\">.</span><span class=\"n\">msg</span>\n        <span class=\"n\">status_code</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">record</span><span class=\"p\">,</span> <span class=\"s2\">&quot;status_code&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">status_code</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"mi\">200</span> <span class=\"o\">&lt;=</span> <span class=\"n\">status_code</span> <span class=\"o\">&lt;</span> <span class=\"mi\">300</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Put 2XX first, since it should be the common case</span>\n                <span class=\"n\">msg</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">style</span><span class=\"o\">.</span><span class=\"n\">HTTP_SUCCESS</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">)</span>\n            <span class=\"k\">elif</span> <span class=\"mi\">100</span> <span class=\"o\">&lt;=</span> <span class=\"n\">status_code</span> <span class=\"o\">&lt;</span> <span class=\"mi\">200</span><span class=\"p\">:</span>\n                <span class=\"n\">msg</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">style</span><span class=\"o\">.</span><span class=\"n\">HTTP_INFO</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">)</span>\n            <span class=\"k\">elif</span> <span class=\"n\">status_code</span> <span class=\"o\">==</span> <span class=\"mi\">304</span><span class=\"p\">:</span>\n                <span class=\"n\">msg</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">style</span><span class=\"o\">.</span><span class=\"n\">HTTP_NOT_MODIFIED</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">)</span>\n            <span class=\"k\">elif</span> <span class=\"mi\">300</span> <span class=\"o\">&lt;=</span> <span class=\"n\">status_code</span> <span class=\"o\">&lt;</span> <span class=\"mi\">400</span><span class=\"p\">:</span>\n                <span class=\"n\">msg</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">style</span><span class=\"o\">.</span><span class=\"n\">HTTP_REDIRECT</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">)</span>\n            <span class=\"k\">elif</span> <span class=\"n\">status_code</span> <span class=\"o\">==</span> <span class=\"mi\">404</span><span class=\"p\">:</span>\n                <span class=\"n\">msg</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">style</span><span class=\"o\">.</span><span class=\"n\">HTTP_NOT_FOUND</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">)</span>\n            <span class=\"k\">elif</span> <span class=\"mi\">400</span> <span class=\"o\">&lt;=</span> <span class=\"n\">status_code</span> <span class=\"o\">&lt;</span> <span class=\"mi\">500</span><span class=\"p\">:</span>\n                <span class=\"n\">msg</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">style</span><span class=\"o\">.</span><span class=\"n\">HTTP_BAD_REQUEST</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Any 5XX, or any other status code</span>\n                <span class=\"n\">msg</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">style</span><span class=\"o\">.</span><span class=\"n\">HTTP_SERVER_ERROR</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">uses_server_time</span><span class=\"p\">()</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">record</span><span class=\"p\">,</span> <span class=\"s2\">&quot;server_time&quot;</span><span class=\"p\">):</span>\n            <span class=\"n\">record</span><span class=\"o\">.</span><span class=\"n\">server_time</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">formatTime</span><span class=\"p\">(</span><span class=\"n\">record</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">datefmt</span><span class=\"p\">)</span>\n\n        <span class=\"n\">record</span><span class=\"o\">.</span><span class=\"n\">msg</span> <span class=\"o\">=</span> <span class=\"n\">msg</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">record</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">uses_server_time</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fmt</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"s2\">&quot;</span><span class=\"si\">{server_time}</span><span class=\"s2\">&quot;</span><span class=\"p\">)</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">0</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">log_response</span><span class=\"p\">(</span>\n    <span class=\"n\">message</span><span class=\"p\">,</span>\n    <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span>\n    <span class=\"n\">response</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">request</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">logger</span><span class=\"o\">=</span><span class=\"n\">request_logger</span><span class=\"p\">,</span>\n    <span class=\"n\">level</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">exception</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n<span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Log errors based on HttpResponse status.</span>\n\n<span class=\"sd\">    Log 5xx responses as errors and 4xx responses as warnings (unless a level</span>\n<span class=\"sd\">    is given as a keyword argument). The HttpResponse status_code and the</span>\n<span class=\"sd\">    request are passed to the logger&#39;s extra parameter.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"c1\"># Check if the response has already been logged. Multiple requests to log</span>\n    <span class=\"c1\"># the same response can be received in some cases, e.g., when the</span>\n    <span class=\"c1\"># response is the result of an exception and is logged when the exception</span>\n    <span class=\"c1\"># is caught, to record the exception.</span>\n    <span class=\"k\">if</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_has_been_logged&quot;</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">level</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"k\">if</span> <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">status_code</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">500</span><span class=\"p\">:</span>\n            <span class=\"n\">level</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;error&quot;</span>\n        <span class=\"k\">elif</span> <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">status_code</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">400</span><span class=\"p\">:</span>\n            <span class=\"n\">level</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;warning&quot;</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">level</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;info&quot;</span>\n\n    <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">logger</span><span class=\"p\">,</span> <span class=\"n\">level</span><span class=\"p\">)(</span>\n        <span class=\"n\">message</span><span class=\"p\">,</span>\n        <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span>\n        <span class=\"n\">extra</span><span class=\"o\">=</span><span class=\"p\">{</span>\n            <span class=\"s2\">&quot;status_code&quot;</span><span class=\"p\">:</span> <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">status_code</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;request&quot;</span><span class=\"p\">:</span> <span class=\"n\">request</span><span class=\"p\">,</span>\n        <span class=\"p\">},</span>\n        <span class=\"n\">exc_info</span><span class=\"o\">=</span><span class=\"n\">exception</span><span class=\"p\">,</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">_has_been_logged</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</pre></div>", "current_page_name": "_modules/django/utils/log", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "favicon_url": null, "logo_url": null, "alabaster_version": "0.7.13", "include_console_assets": false}