{"parents": [{"link": "../../../../../", "title": "Module code"}, {"link": "../../../../", "title": "django"}], "title": "django.db.backends.base.schema", "body": "<h1>Source code for django.db.backends.base.schema</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">logging</span>\n<span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n<span class=\"kn\">from</span> <span class=\"nn\">datetime</span> <span class=\"kn\">import</span> <span class=\"n\">datetime</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">django.conf</span> <span class=\"kn\">import</span> <span class=\"n\">settings</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.backends.ddl_references</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">Columns</span><span class=\"p\">,</span>\n    <span class=\"n\">Expressions</span><span class=\"p\">,</span>\n    <span class=\"n\">ForeignKeyName</span><span class=\"p\">,</span>\n    <span class=\"n\">IndexName</span><span class=\"p\">,</span>\n    <span class=\"n\">Statement</span><span class=\"p\">,</span>\n    <span class=\"n\">Table</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.backends.utils</span> <span class=\"kn\">import</span> <span class=\"n\">names_digest</span><span class=\"p\">,</span> <span class=\"n\">split_identifier</span><span class=\"p\">,</span> <span class=\"n\">truncate_name</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models</span> <span class=\"kn\">import</span> <span class=\"n\">NOT_PROVIDED</span><span class=\"p\">,</span> <span class=\"n\">Deferrable</span><span class=\"p\">,</span> <span class=\"n\">Index</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models.sql</span> <span class=\"kn\">import</span> <span class=\"n\">Query</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.transaction</span> <span class=\"kn\">import</span> <span class=\"n\">TransactionManagementError</span><span class=\"p\">,</span> <span class=\"n\">atomic</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils</span> <span class=\"kn\">import</span> <span class=\"n\">timezone</span>\n\n<span class=\"n\">logger</span> <span class=\"o\">=</span> <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">getLogger</span><span class=\"p\">(</span><span class=\"s2\">&quot;django.db.backends.schema&quot;</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_is_relevant_relation</span><span class=\"p\">(</span><span class=\"n\">relation</span><span class=\"p\">,</span> <span class=\"n\">altered_field</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    When altering the given field, must constraints on its model from the given</span>\n<span class=\"sd\">    relation be temporarily dropped?</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">field</span> <span class=\"o\">=</span> <span class=\"n\">relation</span><span class=\"o\">.</span><span class=\"n\">field</span>\n    <span class=\"k\">if</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">many_to_many</span><span class=\"p\">:</span>\n        <span class=\"c1\"># M2M reverse field</span>\n        <span class=\"k\">return</span> <span class=\"kc\">False</span>\n    <span class=\"k\">if</span> <span class=\"n\">altered_field</span><span class=\"o\">.</span><span class=\"n\">primary_key</span> <span class=\"ow\">and</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">to_fields</span> <span class=\"o\">==</span> <span class=\"p\">[</span><span class=\"kc\">None</span><span class=\"p\">]:</span>\n        <span class=\"c1\"># Foreign key constraint on the primary key, which is being altered.</span>\n        <span class=\"k\">return</span> <span class=\"kc\">True</span>\n    <span class=\"c1\"># Is the constraint targeting the field being altered?</span>\n    <span class=\"k\">return</span> <span class=\"n\">altered_field</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">to_fields</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_all_related_fields</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">):</span>\n    <span class=\"c1\"># Related fields must be returned in a deterministic order.</span>\n    <span class=\"k\">return</span> <span class=\"nb\">sorted</span><span class=\"p\">(</span>\n        <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">_get_fields</span><span class=\"p\">(</span>\n            <span class=\"n\">forward</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n            <span class=\"n\">reverse</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n            <span class=\"n\">include_hidden</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n            <span class=\"n\">include_parents</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"p\">),</span>\n        <span class=\"n\">key</span><span class=\"o\">=</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">attrgetter</span><span class=\"p\">(</span><span class=\"s2\">&quot;name&quot;</span><span class=\"p\">),</span>\n    <span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_related_non_m2m_objects</span><span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">):</span>\n    <span class=\"c1\"># Filter out m2m objects from reverse relations.</span>\n    <span class=\"c1\"># Return (old_relation, new_relation) tuples.</span>\n    <span class=\"n\">related_fields</span> <span class=\"o\">=</span> <span class=\"nb\">zip</span><span class=\"p\">(</span>\n        <span class=\"p\">(</span>\n            <span class=\"n\">obj</span>\n            <span class=\"k\">for</span> <span class=\"n\">obj</span> <span class=\"ow\">in</span> <span class=\"n\">_all_related_fields</span><span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">_is_relevant_relation</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">)</span>\n        <span class=\"p\">),</span>\n        <span class=\"p\">(</span>\n            <span class=\"n\">obj</span>\n            <span class=\"k\">for</span> <span class=\"n\">obj</span> <span class=\"ow\">in</span> <span class=\"n\">_all_related_fields</span><span class=\"p\">(</span><span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">_is_relevant_relation</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">)</span>\n        <span class=\"p\">),</span>\n    <span class=\"p\">)</span>\n    <span class=\"k\">for</span> <span class=\"n\">old_rel</span><span class=\"p\">,</span> <span class=\"n\">new_rel</span> <span class=\"ow\">in</span> <span class=\"n\">related_fields</span><span class=\"p\">:</span>\n        <span class=\"k\">yield</span> <span class=\"n\">old_rel</span><span class=\"p\">,</span> <span class=\"n\">new_rel</span>\n        <span class=\"k\">yield from</span> <span class=\"n\">_related_non_m2m_objects</span><span class=\"p\">(</span>\n            <span class=\"n\">old_rel</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"p\">,</span>\n            <span class=\"n\">new_rel</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"BaseDatabaseSchemaEditor\"><a class=\"viewcode-back\" href=\"../../../../../../ref/schema-editor/#django.db.backends.base.schema.BaseDatabaseSchemaEditor\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">BaseDatabaseSchemaEditor</span><span class=\"p\">:</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    This class and its subclasses are responsible for emitting schema-changing</span>\n<span class=\"sd\">    statements to the databases - model creation/removal/alteration, field</span>\n<span class=\"sd\">    renaming, index fiddling, and so on.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"c1\"># Overrideable SQL templates</span>\n    <span class=\"n\">sql_create_table</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;CREATE TABLE </span><span class=\"si\">%(table)s</span><span class=\"s2\"> (</span><span class=\"si\">%(definition)s</span><span class=\"s2\">)&quot;</span>\n    <span class=\"n\">sql_rename_table</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;ALTER TABLE </span><span class=\"si\">%(old_table)s</span><span class=\"s2\"> RENAME TO </span><span class=\"si\">%(new_table)s</span><span class=\"s2\">&quot;</span>\n    <span class=\"n\">sql_retablespace_table</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;ALTER TABLE </span><span class=\"si\">%(table)s</span><span class=\"s2\"> SET TABLESPACE </span><span class=\"si\">%(new_tablespace)s</span><span class=\"s2\">&quot;</span>\n    <span class=\"n\">sql_delete_table</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;DROP TABLE </span><span class=\"si\">%(table)s</span><span class=\"s2\"> CASCADE&quot;</span>\n\n    <span class=\"n\">sql_create_column</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;ALTER TABLE </span><span class=\"si\">%(table)s</span><span class=\"s2\"> ADD COLUMN </span><span class=\"si\">%(column)s</span><span class=\"s2\"> </span><span class=\"si\">%(definition)s</span><span class=\"s2\">&quot;</span>\n    <span class=\"n\">sql_alter_column</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;ALTER TABLE </span><span class=\"si\">%(table)s</span><span class=\"s2\"> </span><span class=\"si\">%(changes)s</span><span class=\"s2\">&quot;</span>\n    <span class=\"n\">sql_alter_column_type</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;ALTER COLUMN </span><span class=\"si\">%(column)s</span><span class=\"s2\"> TYPE </span><span class=\"si\">%(type)s%(collation)s</span><span class=\"s2\">&quot;</span>\n    <span class=\"n\">sql_alter_column_null</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;ALTER COLUMN </span><span class=\"si\">%(column)s</span><span class=\"s2\"> DROP NOT NULL&quot;</span>\n    <span class=\"n\">sql_alter_column_not_null</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;ALTER COLUMN </span><span class=\"si\">%(column)s</span><span class=\"s2\"> SET NOT NULL&quot;</span>\n    <span class=\"n\">sql_alter_column_default</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;ALTER COLUMN </span><span class=\"si\">%(column)s</span><span class=\"s2\"> SET DEFAULT </span><span class=\"si\">%(default)s</span><span class=\"s2\">&quot;</span>\n    <span class=\"n\">sql_alter_column_no_default</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;ALTER COLUMN </span><span class=\"si\">%(column)s</span><span class=\"s2\"> DROP DEFAULT&quot;</span>\n    <span class=\"n\">sql_alter_column_no_default_null</span> <span class=\"o\">=</span> <span class=\"n\">sql_alter_column_no_default</span>\n    <span class=\"n\">sql_delete_column</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;ALTER TABLE </span><span class=\"si\">%(table)s</span><span class=\"s2\"> DROP COLUMN </span><span class=\"si\">%(column)s</span><span class=\"s2\"> CASCADE&quot;</span>\n    <span class=\"n\">sql_rename_column</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n        <span class=\"s2\">&quot;ALTER TABLE </span><span class=\"si\">%(table)s</span><span class=\"s2\"> RENAME COLUMN </span><span class=\"si\">%(old_column)s</span><span class=\"s2\"> TO </span><span class=\"si\">%(new_column)s</span><span class=\"s2\">&quot;</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">sql_update_with_default</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n        <span class=\"s2\">&quot;UPDATE </span><span class=\"si\">%(table)s</span><span class=\"s2\"> SET </span><span class=\"si\">%(column)s</span><span class=\"s2\"> = </span><span class=\"si\">%(default)s</span><span class=\"s2\"> WHERE </span><span class=\"si\">%(column)s</span><span class=\"s2\"> IS NULL&quot;</span>\n    <span class=\"p\">)</span>\n\n    <span class=\"n\">sql_unique_constraint</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;UNIQUE (</span><span class=\"si\">%(columns)s</span><span class=\"s2\">)</span><span class=\"si\">%(deferrable)s</span><span class=\"s2\">&quot;</span>\n    <span class=\"n\">sql_check_constraint</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;CHECK (</span><span class=\"si\">%(check)s</span><span class=\"s2\">)&quot;</span>\n    <span class=\"n\">sql_delete_constraint</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;ALTER TABLE </span><span class=\"si\">%(table)s</span><span class=\"s2\"> DROP CONSTRAINT </span><span class=\"si\">%(name)s</span><span class=\"s2\">&quot;</span>\n    <span class=\"n\">sql_constraint</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;CONSTRAINT </span><span class=\"si\">%(name)s</span><span class=\"s2\"> </span><span class=\"si\">%(constraint)s</span><span class=\"s2\">&quot;</span>\n\n    <span class=\"n\">sql_create_check</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;ALTER TABLE </span><span class=\"si\">%(table)s</span><span class=\"s2\"> ADD CONSTRAINT </span><span class=\"si\">%(name)s</span><span class=\"s2\"> CHECK (</span><span class=\"si\">%(check)s</span><span class=\"s2\">)&quot;</span>\n    <span class=\"n\">sql_delete_check</span> <span class=\"o\">=</span> <span class=\"n\">sql_delete_constraint</span>\n\n    <span class=\"n\">sql_create_unique</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n        <span class=\"s2\">&quot;ALTER TABLE </span><span class=\"si\">%(table)s</span><span class=\"s2\"> ADD CONSTRAINT </span><span class=\"si\">%(name)s</span><span class=\"s2\"> &quot;</span>\n        <span class=\"s2\">&quot;UNIQUE (</span><span class=\"si\">%(columns)s</span><span class=\"s2\">)</span><span class=\"si\">%(deferrable)s</span><span class=\"s2\">&quot;</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">sql_delete_unique</span> <span class=\"o\">=</span> <span class=\"n\">sql_delete_constraint</span>\n\n    <span class=\"n\">sql_create_fk</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n        <span class=\"s2\">&quot;ALTER TABLE </span><span class=\"si\">%(table)s</span><span class=\"s2\"> ADD CONSTRAINT </span><span class=\"si\">%(name)s</span><span class=\"s2\"> FOREIGN KEY (</span><span class=\"si\">%(column)s</span><span class=\"s2\">) &quot;</span>\n        <span class=\"s2\">&quot;REFERENCES </span><span class=\"si\">%(to_table)s</span><span class=\"s2\"> (</span><span class=\"si\">%(to_column)s</span><span class=\"s2\">)</span><span class=\"si\">%(deferrable)s</span><span class=\"s2\">&quot;</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">sql_create_inline_fk</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"n\">sql_create_column_inline_fk</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"n\">sql_delete_fk</span> <span class=\"o\">=</span> <span class=\"n\">sql_delete_constraint</span>\n\n    <span class=\"n\">sql_create_index</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n        <span class=\"s2\">&quot;CREATE INDEX </span><span class=\"si\">%(name)s</span><span class=\"s2\"> ON </span><span class=\"si\">%(table)s</span><span class=\"s2\"> &quot;</span>\n        <span class=\"s2\">&quot;(</span><span class=\"si\">%(columns)s</span><span class=\"s2\">)</span><span class=\"si\">%(include)s%(extra)s%(condition)s</span><span class=\"s2\">&quot;</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">sql_create_unique_index</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n        <span class=\"s2\">&quot;CREATE UNIQUE INDEX </span><span class=\"si\">%(name)s</span><span class=\"s2\"> ON </span><span class=\"si\">%(table)s</span><span class=\"s2\"> &quot;</span>\n        <span class=\"s2\">&quot;(</span><span class=\"si\">%(columns)s</span><span class=\"s2\">)</span><span class=\"si\">%(include)s%(condition)s</span><span class=\"s2\">&quot;</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">sql_rename_index</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;ALTER INDEX </span><span class=\"si\">%(old_name)s</span><span class=\"s2\"> RENAME TO </span><span class=\"si\">%(new_name)s</span><span class=\"s2\">&quot;</span>\n    <span class=\"n\">sql_delete_index</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;DROP INDEX </span><span class=\"si\">%(name)s</span><span class=\"s2\">&quot;</span>\n\n    <span class=\"n\">sql_create_pk</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n        <span class=\"s2\">&quot;ALTER TABLE </span><span class=\"si\">%(table)s</span><span class=\"s2\"> ADD CONSTRAINT </span><span class=\"si\">%(name)s</span><span class=\"s2\"> PRIMARY KEY (</span><span class=\"si\">%(columns)s</span><span class=\"s2\">)&quot;</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">sql_delete_pk</span> <span class=\"o\">=</span> <span class=\"n\">sql_delete_constraint</span>\n\n    <span class=\"n\">sql_delete_procedure</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;DROP PROCEDURE </span><span class=\"si\">%(procedure)s</span><span class=\"s2\">&quot;</span>\n\n    <span class=\"n\">sql_alter_table_comment</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;COMMENT ON TABLE </span><span class=\"si\">%(table)s</span><span class=\"s2\"> IS </span><span class=\"si\">%(comment)s</span><span class=\"s2\">&quot;</span>\n    <span class=\"n\">sql_alter_column_comment</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;COMMENT ON COLUMN </span><span class=\"si\">%(table)s</span><span class=\"s2\">.</span><span class=\"si\">%(column)s</span><span class=\"s2\"> IS </span><span class=\"si\">%(comment)s</span><span class=\"s2\">&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">,</span> <span class=\"n\">collect_sql</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">atomic</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"n\">connection</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">collect_sql</span> <span class=\"o\">=</span> <span class=\"n\">collect_sql</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">collect_sql</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">collected_sql</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">atomic_migration</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">can_rollback_ddl</span> <span class=\"ow\">and</span> <span class=\"n\">atomic</span>\n\n    <span class=\"c1\"># State-managing methods</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__enter__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deferred_sql</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">atomic_migration</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">atomic</span> <span class=\"o\">=</span> <span class=\"n\">atomic</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">alias</span><span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">atomic</span><span class=\"o\">.</span><span class=\"fm\">__enter__</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__exit__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">exc_type</span><span class=\"p\">,</span> <span class=\"n\">exc_value</span><span class=\"p\">,</span> <span class=\"n\">traceback</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">exc_type</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">for</span> <span class=\"n\">sql</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deferred_sql</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">atomic_migration</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">atomic</span><span class=\"o\">.</span><span class=\"fm\">__exit__</span><span class=\"p\">(</span><span class=\"n\">exc_type</span><span class=\"p\">,</span> <span class=\"n\">exc_value</span><span class=\"p\">,</span> <span class=\"n\">traceback</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># Core utility functions</span>\n\n<div class=\"viewcode-block\" id=\"BaseDatabaseSchemaEditor.execute\"><a class=\"viewcode-back\" href=\"../../../../../../ref/schema-editor/#django.db.backends.base.schema.BaseDatabaseSchemaEditor.execute\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">execute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"o\">=</span><span class=\"p\">()):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Execute the given SQL statement, with optional parameters.&quot;&quot;&quot;</span>\n        <span class=\"c1\"># Don&#39;t perform the transactional DDL check if SQL is being collected</span>\n        <span class=\"c1\"># as it&#39;s not going to be executed anyway.</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">collect_sql</span>\n            <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">in_atomic_block</span>\n            <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">can_rollback_ddl</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"n\">TransactionManagementError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Executing DDL statements while in a transaction on databases &quot;</span>\n                <span class=\"s2\">&quot;that can&#39;t perform a rollback is prohibited.&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"c1\"># Account for non-string statement objects.</span>\n        <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Log the command we&#39;re running, then run it</span>\n        <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">debug</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\">; (params </span><span class=\"si\">%r</span><span class=\"s2\">)&quot;</span><span class=\"p\">,</span> <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">,</span> <span class=\"n\">extra</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;params&quot;</span><span class=\"p\">:</span> <span class=\"n\">params</span><span class=\"p\">,</span> <span class=\"s2\">&quot;sql&quot;</span><span class=\"p\">:</span> <span class=\"n\">sql</span><span class=\"p\">}</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">collect_sql</span><span class=\"p\">:</span>\n            <span class=\"n\">ending</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;&quot;</span> <span class=\"k\">if</span> <span class=\"n\">sql</span><span class=\"o\">.</span><span class=\"n\">rstrip</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">endswith</span><span class=\"p\">(</span><span class=\"s2\">&quot;;&quot;</span><span class=\"p\">)</span> <span class=\"k\">else</span> <span class=\"s2\">&quot;;&quot;</span>\n            <span class=\"k\">if</span> <span class=\"n\">params</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">collected_sql</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span>\n                    <span class=\"p\">(</span><span class=\"n\">sql</span> <span class=\"o\">%</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"nb\">map</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_value</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">)))</span> <span class=\"o\">+</span> <span class=\"n\">ending</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">collected_sql</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">sql</span> <span class=\"o\">+</span> <span class=\"n\">ending</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">cursor</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">cursor</span><span class=\"p\">:</span>\n                <span class=\"n\">cursor</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">)</span></div>\n\n    <span class=\"k\">def</span> <span class=\"nf\">quote_name</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">table_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Take a model and return its table definition.&quot;&quot;&quot;</span>\n        <span class=\"c1\"># Add any unique_togethers (always deferred, as some fields might be</span>\n        <span class=\"c1\"># created afterward, like geometry fields with some backends).</span>\n        <span class=\"k\">for</span> <span class=\"n\">field_names</span> <span class=\"ow\">in</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">unique_together</span><span class=\"p\">:</span>\n            <span class=\"n\">fields</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">field_names</span><span class=\"p\">]</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deferred_sql</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_unique_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">fields</span><span class=\"p\">))</span>\n        <span class=\"c1\"># Create column SQL, add FK deferreds if needed.</span>\n        <span class=\"n\">column_sqls</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">local_fields</span><span class=\"p\">:</span>\n            <span class=\"c1\"># SQL.</span>\n            <span class=\"n\">definition</span><span class=\"p\">,</span> <span class=\"n\">extra_params</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">column_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">definition</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"k\">continue</span>\n            <span class=\"c1\"># Check constraints can go on the column SQL here.</span>\n            <span class=\"n\">db_params</span> <span class=\"o\">=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_parameters</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">db_params</span><span class=\"p\">[</span><span class=\"s2\">&quot;check&quot;</span><span class=\"p\">]:</span>\n                <span class=\"n\">definition</span> <span class=\"o\">+=</span> <span class=\"s2\">&quot; &quot;</span> <span class=\"o\">+</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_check_constraint</span> <span class=\"o\">%</span> <span class=\"n\">db_params</span>\n            <span class=\"c1\"># Autoincrement SQL (for backends with inline variant).</span>\n            <span class=\"n\">col_type_suffix</span> <span class=\"o\">=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_type_suffix</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">col_type_suffix</span><span class=\"p\">:</span>\n                <span class=\"n\">definition</span> <span class=\"o\">+=</span> <span class=\"s2\">&quot; </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"n\">col_type_suffix</span>\n            <span class=\"n\">params</span><span class=\"o\">.</span><span class=\"n\">extend</span><span class=\"p\">(</span><span class=\"n\">extra_params</span><span class=\"p\">)</span>\n            <span class=\"c1\"># FK.</span>\n            <span class=\"k\">if</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span> <span class=\"ow\">and</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_constraint</span><span class=\"p\">:</span>\n                <span class=\"n\">to_table</span> <span class=\"o\">=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span>\n                <span class=\"n\">to_column</span> <span class=\"o\">=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span>\n                    <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">field_name</span>\n                <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">column</span>\n                <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_create_inline_fk</span><span class=\"p\">:</span>\n                    <span class=\"n\">definition</span> <span class=\"o\">+=</span> <span class=\"s2\">&quot; &quot;</span> <span class=\"o\">+</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_create_inline_fk</span> <span class=\"o\">%</span> <span class=\"p\">{</span>\n                        <span class=\"s2\">&quot;to_table&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">to_table</span><span class=\"p\">),</span>\n                        <span class=\"s2\">&quot;to_column&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">to_column</span><span class=\"p\">),</span>\n                    <span class=\"p\">}</span>\n                <span class=\"k\">elif</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_foreign_keys</span><span class=\"p\">:</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deferred_sql</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span>\n                        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_fk_sql</span><span class=\"p\">(</span>\n                            <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_fk_</span><span class=\"si\">%(to_table)s</span><span class=\"s2\">_</span><span class=\"si\">%(to_column)s</span><span class=\"s2\">&quot;</span>\n                        <span class=\"p\">)</span>\n                    <span class=\"p\">)</span>\n            <span class=\"c1\"># Add the SQL to our big list.</span>\n            <span class=\"n\">column_sqls</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\"> </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">),</span>\n                    <span class=\"n\">definition</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n            <span class=\"c1\"># Autoincrement SQL (for backends with post table definition</span>\n            <span class=\"c1\"># variant).</span>\n            <span class=\"k\">if</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">get_internal_type</span><span class=\"p\">()</span> <span class=\"ow\">in</span> <span class=\"p\">(</span>\n                <span class=\"s2\">&quot;AutoField&quot;</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;BigAutoField&quot;</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;SmallAutoField&quot;</span><span class=\"p\">,</span>\n            <span class=\"p\">):</span>\n                <span class=\"n\">autoinc_sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">autoinc_sql</span><span class=\"p\">(</span>\n                    <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">column</span>\n                <span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"n\">autoinc_sql</span><span class=\"p\">:</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deferred_sql</span><span class=\"o\">.</span><span class=\"n\">extend</span><span class=\"p\">(</span><span class=\"n\">autoinc_sql</span><span class=\"p\">)</span>\n        <span class=\"n\">constraints</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n            <span class=\"n\">constraint</span><span class=\"o\">.</span><span class=\"n\">constraint_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">constraint</span> <span class=\"ow\">in</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">constraints</span>\n        <span class=\"p\">]</span>\n        <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_create_table</span> <span class=\"o\">%</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;table&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">),</span>\n            <span class=\"s2\">&quot;definition&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span>\n                <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">constraint</span><span class=\"p\">)</span>\n                <span class=\"k\">for</span> <span class=\"n\">constraint</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">column_sqls</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">constraints</span><span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"n\">constraint</span>\n            <span class=\"p\">),</span>\n        <span class=\"p\">}</span>\n        <span class=\"k\">if</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_tablespace</span><span class=\"p\">:</span>\n            <span class=\"n\">tablespace_sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">tablespace_sql</span><span class=\"p\">(</span>\n                <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_tablespace</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">tablespace_sql</span><span class=\"p\">:</span>\n                <span class=\"n\">sql</span> <span class=\"o\">+=</span> <span class=\"s2\">&quot; &quot;</span> <span class=\"o\">+</span> <span class=\"n\">tablespace_sql</span>\n        <span class=\"k\">return</span> <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span>\n\n    <span class=\"c1\"># Field &lt;-&gt; database mapping functions</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_iter_column_sql</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">column_db_type</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">field_db_params</span><span class=\"p\">,</span> <span class=\"n\">include_default</span>\n    <span class=\"p\">):</span>\n        <span class=\"k\">yield</span> <span class=\"n\">column_db_type</span>\n        <span class=\"k\">if</span> <span class=\"n\">collation</span> <span class=\"o\">:=</span> <span class=\"n\">field_db_params</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;collation&quot;</span><span class=\"p\">):</span>\n            <span class=\"k\">yield</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_collate_sql</span><span class=\"p\">(</span><span class=\"n\">collation</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_comments_inline</span> <span class=\"ow\">and</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_comment</span><span class=\"p\">:</span>\n            <span class=\"k\">yield</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_comment_sql</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_comment</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Work out nullability.</span>\n        <span class=\"n\">null</span> <span class=\"o\">=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">null</span>\n        <span class=\"c1\"># Add database default.</span>\n        <span class=\"k\">if</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_default</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"n\">NOT_PROVIDED</span><span class=\"p\">:</span>\n            <span class=\"n\">default_sql</span><span class=\"p\">,</span> <span class=\"n\">default_params</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db_default_sql</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">)</span>\n            <span class=\"k\">yield</span> <span class=\"sa\">f</span><span class=\"s2\">&quot;DEFAULT </span><span class=\"si\">{</span><span class=\"n\">default_sql</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span>\n            <span class=\"n\">params</span><span class=\"o\">.</span><span class=\"n\">extend</span><span class=\"p\">(</span><span class=\"n\">default_params</span><span class=\"p\">)</span>\n            <span class=\"n\">include_default</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"c1\"># Include a default value, if requested.</span>\n        <span class=\"n\">include_default</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">include_default</span>\n            <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">skip_default</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">)</span>\n            <span class=\"ow\">and</span>\n            <span class=\"c1\"># Don&#39;t include a default value if it&#39;s a nullable field and the</span>\n            <span class=\"c1\"># default cannot be dropped in the ALTER COLUMN statement (e.g.</span>\n            <span class=\"c1\"># MySQL longtext and longblob).</span>\n            <span class=\"ow\">not</span> <span class=\"p\">(</span><span class=\"n\">null</span> <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">skip_default_on_alter</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">))</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">include_default</span><span class=\"p\">:</span>\n            <span class=\"n\">default_value</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">effective_default</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">default_value</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"n\">column_default</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;DEFAULT &quot;</span> <span class=\"o\">+</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_column_default_sql</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">requires_literal_defaults</span><span class=\"p\">:</span>\n                    <span class=\"c1\"># Some databases can&#39;t take defaults as a parameter (Oracle).</span>\n                    <span class=\"c1\"># If this is the case, the individual schema backend should</span>\n                    <span class=\"c1\"># implement prepare_default().</span>\n                    <span class=\"k\">yield</span> <span class=\"n\">column_default</span> <span class=\"o\">%</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prepare_default</span><span class=\"p\">(</span><span class=\"n\">default_value</span><span class=\"p\">)</span>\n                <span class=\"k\">else</span><span class=\"p\">:</span>\n                    <span class=\"k\">yield</span> <span class=\"n\">column_default</span>\n                    <span class=\"n\">params</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">default_value</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Oracle treats the empty string (&#39;&#39;) as null, so coerce the null</span>\n        <span class=\"c1\"># option whenever &#39;&#39; is a possible value.</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">empty_strings_allowed</span>\n            <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">primary_key</span>\n            <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">interprets_empty_strings_as_nulls</span>\n        <span class=\"p\">):</span>\n            <span class=\"n\">null</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">null</span><span class=\"p\">:</span>\n            <span class=\"k\">yield</span> <span class=\"s2\">&quot;NOT NULL&quot;</span>\n        <span class=\"k\">elif</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">implied_column_null</span><span class=\"p\">:</span>\n            <span class=\"k\">yield</span> <span class=\"s2\">&quot;NULL&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">primary_key</span><span class=\"p\">:</span>\n            <span class=\"k\">yield</span> <span class=\"s2\">&quot;PRIMARY KEY&quot;</span>\n        <span class=\"k\">elif</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">unique</span><span class=\"p\">:</span>\n            <span class=\"k\">yield</span> <span class=\"s2\">&quot;UNIQUE&quot;</span>\n        <span class=\"c1\"># Optionally add the tablespace if it&#39;s an implicitly indexed column.</span>\n        <span class=\"n\">tablespace</span> <span class=\"o\">=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_tablespace</span> <span class=\"ow\">or</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_tablespace</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"n\">tablespace</span>\n            <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_tablespaces</span>\n            <span class=\"ow\">and</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">unique</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">yield</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">tablespace_sql</span><span class=\"p\">(</span><span class=\"n\">tablespace</span><span class=\"p\">,</span> <span class=\"n\">inline</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">column_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">include_default</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return the column definition for a field. The field must already have</span>\n<span class=\"sd\">        had set_attributes_from_name() called.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"c1\"># Get the column&#39;s type and use that as the basis of the SQL.</span>\n        <span class=\"n\">field_db_params</span> <span class=\"o\">=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_parameters</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">)</span>\n        <span class=\"n\">column_db_type</span> <span class=\"o\">=</span> <span class=\"n\">field_db_params</span><span class=\"p\">[</span><span class=\"s2\">&quot;type&quot;</span><span class=\"p\">]</span>\n        <span class=\"c1\"># Check for fields that aren&#39;t actually columns (e.g. M2M).</span>\n        <span class=\"k\">if</span> <span class=\"n\">column_db_type</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"kc\">None</span>\n        <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">return</span> <span class=\"p\">(</span>\n            <span class=\"s2\">&quot; &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span>\n                <span class=\"c1\"># This appends to the params being returned.</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_iter_column_sql</span><span class=\"p\">(</span>\n                    <span class=\"n\">column_db_type</span><span class=\"p\">,</span>\n                    <span class=\"n\">params</span><span class=\"p\">,</span>\n                    <span class=\"n\">model</span><span class=\"p\">,</span>\n                    <span class=\"n\">field</span><span class=\"p\">,</span>\n                    <span class=\"n\">field_db_params</span><span class=\"p\">,</span>\n                    <span class=\"n\">include_default</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">),</span>\n            <span class=\"n\">params</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">skip_default</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Some backends don&#39;t accept default values for certain columns types</span>\n<span class=\"sd\">        (i.e. MySQL longtext and longblob).</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">skip_default_on_alter</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Some backends don&#39;t accept default values for certain columns types</span>\n<span class=\"sd\">        (i.e. MySQL longtext and longblob) in the ALTER COLUMN statement.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">prepare_default</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Only used for backends which have requires_literal_defaults feature</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">raise</span> <span class=\"ne\">NotImplementedError</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;subclasses of BaseDatabaseSchemaEditor for backends which have &quot;</span>\n            <span class=\"s2\">&quot;requires_literal_defaults must provide a prepare_default() method&quot;</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_column_default_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return the SQL to use in a DEFAULT clause. The resulting string should</span>\n<span class=\"sd\">        contain a &#39;%s&#39; placeholder for a default value.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">db_default_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Return the sql and params for the field&#39;s database default.&quot;&quot;&quot;</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">django.db.models.expressions</span> <span class=\"kn\">import</span> <span class=\"n\">Value</span>\n\n        <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_default</span><span class=\"p\">,</span> <span class=\"n\">Value</span><span class=\"p\">)</span> <span class=\"k\">else</span> <span class=\"s2\">&quot;(</span><span class=\"si\">%s</span><span class=\"s2\">)&quot;</span>\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">Query</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">=</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">)</span>\n        <span class=\"n\">compiler</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">get_compiler</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">)</span>\n        <span class=\"n\">default_sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"n\">compiler</span><span class=\"o\">.</span><span class=\"n\">compile</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_default</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">requires_literal_defaults</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Some databases doesn&#39;t support parameterized defaults (Oracle,</span>\n            <span class=\"c1\"># SQLite). If this is the case, the individual schema backend</span>\n            <span class=\"c1\"># should implement prepare_default().</span>\n            <span class=\"n\">default_sql</span> <span class=\"o\">%=</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prepare_default</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">p</span> <span class=\"ow\">in</span> <span class=\"n\">params</span><span class=\"p\">)</span>\n            <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">return</span> <span class=\"n\">sql</span> <span class=\"o\">%</span> <span class=\"n\">default_sql</span><span class=\"p\">,</span> <span class=\"n\">params</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_effective_default</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">):</span>\n        <span class=\"c1\"># This method allows testing its logic without a connection.</span>\n        <span class=\"k\">if</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">has_default</span><span class=\"p\">():</span>\n            <span class=\"n\">default</span> <span class=\"o\">=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">get_default</span><span class=\"p\">()</span>\n        <span class=\"k\">elif</span> <span class=\"ow\">not</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">null</span> <span class=\"ow\">and</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">blank</span> <span class=\"ow\">and</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">empty_strings_allowed</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">get_internal_type</span><span class=\"p\">()</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;BinaryField&quot;</span><span class=\"p\">:</span>\n                <span class=\"n\">default</span> <span class=\"o\">=</span> <span class=\"sa\">b</span><span class=\"s2\">&quot;&quot;</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">default</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;&quot;</span>\n        <span class=\"k\">elif</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"s2\">&quot;auto_now&quot;</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"s2\">&quot;auto_now_add&quot;</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">):</span>\n            <span class=\"n\">internal_type</span> <span class=\"o\">=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">get_internal_type</span><span class=\"p\">()</span>\n            <span class=\"k\">if</span> <span class=\"n\">internal_type</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;DateTimeField&quot;</span><span class=\"p\">:</span>\n                <span class=\"n\">default</span> <span class=\"o\">=</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">default</span> <span class=\"o\">=</span> <span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">()</span>\n                <span class=\"k\">if</span> <span class=\"n\">internal_type</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;DateField&quot;</span><span class=\"p\">:</span>\n                    <span class=\"n\">default</span> <span class=\"o\">=</span> <span class=\"n\">default</span><span class=\"o\">.</span><span class=\"n\">date</span><span class=\"p\">()</span>\n                <span class=\"k\">elif</span> <span class=\"n\">internal_type</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;TimeField&quot;</span><span class=\"p\">:</span>\n                    <span class=\"n\">default</span> <span class=\"o\">=</span> <span class=\"n\">default</span><span class=\"o\">.</span><span class=\"n\">time</span><span class=\"p\">()</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">default</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">return</span> <span class=\"n\">default</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">effective_default</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Return a field&#39;s effective database default value.&quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">get_db_prep_save</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_effective_default</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">),</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">quote_value</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a quoted version of the value so it&#39;s safe to use in an SQL</span>\n<span class=\"sd\">        string. This is not safe against injection from user code; it is</span>\n<span class=\"sd\">        intended only for use in making SQL scripts or preparing default values</span>\n<span class=\"sd\">        for particularly tricky backends (defaults are not user-defined, though,</span>\n<span class=\"sd\">        so this is safe).</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">raise</span> <span class=\"ne\">NotImplementedError</span><span class=\"p\">()</span>\n\n    <span class=\"c1\"># Actions</span>\n\n<div class=\"viewcode-block\" id=\"BaseDatabaseSchemaEditor.create_model\"><a class=\"viewcode-back\" href=\"../../../../../../ref/schema-editor/#django.db.backends.base.schema.BaseDatabaseSchemaEditor.create_model\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">create_model</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Create a table and any accompanying indexes or unique constraints for</span>\n<span class=\"sd\">        the given `model`.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">table_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Prevent using [] as params, in the case a literal &#39;%&#39; is used in the</span>\n        <span class=\"c1\"># definition.</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"ow\">or</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_comments</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Add table comment.</span>\n            <span class=\"k\">if</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table_comment</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">alter_db_table_comment</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table_comment</span><span class=\"p\">)</span>\n            <span class=\"c1\"># Add column comments.</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_comments_inline</span><span class=\"p\">:</span>\n                <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">local_fields</span><span class=\"p\">:</span>\n                    <span class=\"k\">if</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_comment</span><span class=\"p\">:</span>\n                        <span class=\"n\">field_db_params</span> <span class=\"o\">=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_parameters</span><span class=\"p\">(</span>\n                            <span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span>\n                        <span class=\"p\">)</span>\n                        <span class=\"n\">field_type</span> <span class=\"o\">=</span> <span class=\"n\">field_db_params</span><span class=\"p\">[</span><span class=\"s2\">&quot;type&quot;</span><span class=\"p\">]</span>\n                        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                            <span class=\"o\">*</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_alter_column_comment_sql</span><span class=\"p\">(</span>\n                                <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">field_type</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_comment</span>\n                            <span class=\"p\">)</span>\n                        <span class=\"p\">)</span>\n        <span class=\"c1\"># Add any field index and index_together&#39;s (deferred as SQLite</span>\n        <span class=\"c1\"># _remake_table needs it).</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deferred_sql</span><span class=\"o\">.</span><span class=\"n\">extend</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_model_indexes_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">))</span>\n\n        <span class=\"c1\"># Make M2M tables</span>\n        <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">local_many_to_many</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">auto_created</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">create_model</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"BaseDatabaseSchemaEditor.delete_model\"><a class=\"viewcode-back\" href=\"../../../../../../ref/schema-editor/#django.db.backends.base.schema.BaseDatabaseSchemaEditor.delete_model\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">delete_model</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Delete a model from the database.&quot;&quot;&quot;</span>\n        <span class=\"c1\"># Handle auto-created intermediary models</span>\n        <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">local_many_to_many</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">auto_created</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">delete_model</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Delete the table</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_delete_table</span>\n            <span class=\"o\">%</span> <span class=\"p\">{</span>\n                <span class=\"s2\">&quot;table&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">),</span>\n            <span class=\"p\">}</span>\n        <span class=\"p\">)</span>\n        <span class=\"c1\"># Remove all deferred statements referencing the deleted table.</span>\n        <span class=\"k\">for</span> <span class=\"n\">sql</span> <span class=\"ow\">in</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deferred_sql</span><span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">Statement</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">sql</span><span class=\"o\">.</span><span class=\"n\">references_table</span><span class=\"p\">(</span>\n                <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span>\n            <span class=\"p\">):</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deferred_sql</span><span class=\"o\">.</span><span class=\"n\">remove</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"BaseDatabaseSchemaEditor.add_index\"><a class=\"viewcode-back\" href=\"../../../../../../ref/schema-editor/#django.db.backends.base.schema.BaseDatabaseSchemaEditor.add_index\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">add_index</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">index</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Add an index on a model.&quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">contains_expressions</span>\n            <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_expression_indexes</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n        <span class=\"c1\"># Index.create_sql returns interpolated SQL which makes params=None a</span>\n        <span class=\"c1\"># necessity to avoid escaping attempts on execution.</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">create_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">),</span> <span class=\"n\">params</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"BaseDatabaseSchemaEditor.remove_index\"><a class=\"viewcode-back\" href=\"../../../../../../ref/schema-editor/#django.db.backends.base.schema.BaseDatabaseSchemaEditor.remove_index\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">remove_index</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">index</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Remove an index from a model.&quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">contains_expressions</span>\n            <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_expression_indexes</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">remove_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">))</span></div>\n\n<div class=\"viewcode-block\" id=\"BaseDatabaseSchemaEditor.rename_index\"><a class=\"viewcode-back\" href=\"../../../../../../ref/schema-editor/#django.db.backends.base.schema.BaseDatabaseSchemaEditor.rename_index\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">rename_index</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_index</span><span class=\"p\">,</span> <span class=\"n\">new_index</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">can_rename_index</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_rename_index_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_index</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">new_index</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">),</span>\n                <span class=\"n\">params</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">remove_index</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_index</span><span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">add_index</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">new_index</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"BaseDatabaseSchemaEditor.add_constraint\"><a class=\"viewcode-back\" href=\"../../../../../../ref/schema-editor/#django.db.backends.base.schema.BaseDatabaseSchemaEditor.add_constraint\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">add_constraint</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">constraint</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Add a constraint to a model.&quot;&quot;&quot;</span>\n        <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"n\">constraint</span><span class=\"o\">.</span><span class=\"n\">create_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">sql</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Constraint.create_sql returns interpolated SQL which makes</span>\n            <span class=\"c1\"># params=None a necessity to avoid escaping attempts on execution.</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"BaseDatabaseSchemaEditor.remove_constraint\"><a class=\"viewcode-back\" href=\"../../../../../../ref/schema-editor/#django.db.backends.base.schema.BaseDatabaseSchemaEditor.remove_constraint\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">remove_constraint</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">constraint</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Remove a constraint from a model.&quot;&quot;&quot;</span>\n        <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"n\">constraint</span><span class=\"o\">.</span><span class=\"n\">remove_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">sql</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"BaseDatabaseSchemaEditor.alter_unique_together\"><a class=\"viewcode-back\" href=\"../../../../../../ref/schema-editor/#django.db.backends.base.schema.BaseDatabaseSchemaEditor.alter_unique_together\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">alter_unique_together</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_unique_together</span><span class=\"p\">,</span> <span class=\"n\">new_unique_together</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Deal with a model changing its unique_together. The input</span>\n<span class=\"sd\">        unique_togethers must be doubly-nested, not the single-nested</span>\n<span class=\"sd\">        [&quot;foo&quot;, &quot;bar&quot;] format.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">olds</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">fields</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">fields</span> <span class=\"ow\">in</span> <span class=\"n\">old_unique_together</span><span class=\"p\">}</span>\n        <span class=\"n\">news</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">fields</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">fields</span> <span class=\"ow\">in</span> <span class=\"n\">new_unique_together</span><span class=\"p\">}</span>\n        <span class=\"c1\"># Deleted uniques</span>\n        <span class=\"k\">for</span> <span class=\"n\">fields</span> <span class=\"ow\">in</span> <span class=\"n\">olds</span><span class=\"o\">.</span><span class=\"n\">difference</span><span class=\"p\">(</span><span class=\"n\">news</span><span class=\"p\">):</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_delete_composed_index</span><span class=\"p\">(</span>\n                <span class=\"n\">model</span><span class=\"p\">,</span>\n                <span class=\"n\">fields</span><span class=\"p\">,</span>\n                <span class=\"p\">{</span><span class=\"s2\">&quot;unique&quot;</span><span class=\"p\">:</span> <span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"s2\">&quot;primary_key&quot;</span><span class=\"p\">:</span> <span class=\"kc\">False</span><span class=\"p\">},</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_delete_unique</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n        <span class=\"c1\"># Created uniques</span>\n        <span class=\"k\">for</span> <span class=\"n\">field_names</span> <span class=\"ow\">in</span> <span class=\"n\">news</span><span class=\"o\">.</span><span class=\"n\">difference</span><span class=\"p\">(</span><span class=\"n\">olds</span><span class=\"p\">):</span>\n            <span class=\"n\">fields</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">field_names</span><span class=\"p\">]</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_unique_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">fields</span><span class=\"p\">))</span></div>\n\n<div class=\"viewcode-block\" id=\"BaseDatabaseSchemaEditor.alter_index_together\"><a class=\"viewcode-back\" href=\"../../../../../../ref/schema-editor/#django.db.backends.base.schema.BaseDatabaseSchemaEditor.alter_index_together\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">alter_index_together</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_index_together</span><span class=\"p\">,</span> <span class=\"n\">new_index_together</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Deal with a model changing its index_together. The input</span>\n<span class=\"sd\">        index_togethers must be doubly-nested, not the single-nested</span>\n<span class=\"sd\">        [&quot;foo&quot;, &quot;bar&quot;] format.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">olds</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">fields</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">fields</span> <span class=\"ow\">in</span> <span class=\"n\">old_index_together</span><span class=\"p\">}</span>\n        <span class=\"n\">news</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">fields</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">fields</span> <span class=\"ow\">in</span> <span class=\"n\">new_index_together</span><span class=\"p\">}</span>\n        <span class=\"c1\"># Deleted indexes</span>\n        <span class=\"k\">for</span> <span class=\"n\">fields</span> <span class=\"ow\">in</span> <span class=\"n\">olds</span><span class=\"o\">.</span><span class=\"n\">difference</span><span class=\"p\">(</span><span class=\"n\">news</span><span class=\"p\">):</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_delete_composed_index</span><span class=\"p\">(</span>\n                <span class=\"n\">model</span><span class=\"p\">,</span>\n                <span class=\"n\">fields</span><span class=\"p\">,</span>\n                <span class=\"p\">{</span><span class=\"s2\">&quot;index&quot;</span><span class=\"p\">:</span> <span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"s2\">&quot;unique&quot;</span><span class=\"p\">:</span> <span class=\"kc\">False</span><span class=\"p\">},</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_delete_index</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n        <span class=\"c1\"># Created indexes</span>\n        <span class=\"k\">for</span> <span class=\"n\">field_names</span> <span class=\"ow\">in</span> <span class=\"n\">news</span><span class=\"o\">.</span><span class=\"n\">difference</span><span class=\"p\">(</span><span class=\"n\">olds</span><span class=\"p\">):</span>\n            <span class=\"n\">fields</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">field_names</span><span class=\"p\">]</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_index_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">fields</span><span class=\"o\">=</span><span class=\"n\">fields</span><span class=\"p\">,</span> <span class=\"n\">suffix</span><span class=\"o\">=</span><span class=\"s2\">&quot;_idx&quot;</span><span class=\"p\">))</span></div>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_delete_composed_index</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">fields</span><span class=\"p\">,</span> <span class=\"n\">constraint_kwargs</span><span class=\"p\">,</span> <span class=\"n\">sql</span><span class=\"p\">):</span>\n        <span class=\"n\">meta_constraint_names</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"n\">constraint</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"k\">for</span> <span class=\"n\">constraint</span> <span class=\"ow\">in</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">constraints</span>\n        <span class=\"p\">}</span>\n        <span class=\"n\">meta_index_names</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"n\">constraint</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"k\">for</span> <span class=\"n\">constraint</span> <span class=\"ow\">in</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">indexes</span><span class=\"p\">}</span>\n        <span class=\"n\">columns</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">column</span> <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span><span class=\"p\">]</span>\n        <span class=\"n\">constraint_names</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_constraint_names</span><span class=\"p\">(</span>\n            <span class=\"n\">model</span><span class=\"p\">,</span>\n            <span class=\"n\">columns</span><span class=\"p\">,</span>\n            <span class=\"n\">exclude</span><span class=\"o\">=</span><span class=\"n\">meta_constraint_names</span> <span class=\"o\">|</span> <span class=\"n\">meta_index_names</span><span class=\"p\">,</span>\n            <span class=\"o\">**</span><span class=\"n\">constraint_kwargs</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"n\">constraint_kwargs</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;unique&quot;</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"kc\">True</span>\n            <span class=\"ow\">and</span> <span class=\"n\">constraint_names</span>\n            <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">allows_multiple_constraints_on_same_fields</span>\n        <span class=\"p\">):</span>\n            <span class=\"c1\"># Constraint matching the unique_together name.</span>\n            <span class=\"n\">default_name</span> <span class=\"o\">=</span> <span class=\"nb\">str</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_unique_constraint_name</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span> <span class=\"n\">columns</span><span class=\"p\">,</span> <span class=\"n\">quote</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">default_name</span> <span class=\"ow\">in</span> <span class=\"n\">constraint_names</span><span class=\"p\">:</span>\n                <span class=\"n\">constraint_names</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">default_name</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">constraint_names</span><span class=\"p\">)</span> <span class=\"o\">!=</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Found wrong number (</span><span class=\"si\">%s</span><span class=\"s2\">) of constraints for </span><span class=\"si\">%s</span><span class=\"s2\">(</span><span class=\"si\">%s</span><span class=\"s2\">)&quot;</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span>\n                    <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">constraint_names</span><span class=\"p\">),</span>\n                    <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">columns</span><span class=\"p\">),</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_delete_constraint_sql</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">constraint_names</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]))</span>\n\n<div class=\"viewcode-block\" id=\"BaseDatabaseSchemaEditor.alter_db_table\"><a class=\"viewcode-back\" href=\"../../../../../../ref/schema-editor/#django.db.backends.base.schema.BaseDatabaseSchemaEditor.alter_db_table\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">alter_db_table</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_db_table</span><span class=\"p\">,</span> <span class=\"n\">new_db_table</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Rename the table a model points to.&quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">old_db_table</span> <span class=\"o\">==</span> <span class=\"n\">new_db_table</span> <span class=\"ow\">or</span> <span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">ignores_table_name_case</span>\n            <span class=\"ow\">and</span> <span class=\"n\">old_db_table</span><span class=\"o\">.</span><span class=\"n\">lower</span><span class=\"p\">()</span> <span class=\"o\">==</span> <span class=\"n\">new_db_table</span><span class=\"o\">.</span><span class=\"n\">lower</span><span class=\"p\">()</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">return</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_rename_table</span>\n            <span class=\"o\">%</span> <span class=\"p\">{</span>\n                <span class=\"s2\">&quot;old_table&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">old_db_table</span><span class=\"p\">),</span>\n                <span class=\"s2\">&quot;new_table&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">new_db_table</span><span class=\"p\">),</span>\n            <span class=\"p\">}</span>\n        <span class=\"p\">)</span>\n        <span class=\"c1\"># Rename all references to the old table name.</span>\n        <span class=\"k\">for</span> <span class=\"n\">sql</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deferred_sql</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">Statement</span><span class=\"p\">):</span>\n                <span class=\"n\">sql</span><span class=\"o\">.</span><span class=\"n\">rename_table_references</span><span class=\"p\">(</span><span class=\"n\">old_db_table</span><span class=\"p\">,</span> <span class=\"n\">new_db_table</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"BaseDatabaseSchemaEditor.alter_db_table_comment\"><a class=\"viewcode-back\" href=\"../../../../../../ref/schema-editor/#django.db.backends.base.schema.BaseDatabaseSchemaEditor.alter_db_table_comment\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">alter_db_table_comment</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_db_table_comment</span><span class=\"p\">,</span> <span class=\"n\">new_db_table_comment</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_alter_table_comment</span>\n            <span class=\"o\">%</span> <span class=\"p\">{</span>\n                <span class=\"s2\">&quot;table&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">),</span>\n                <span class=\"s2\">&quot;comment&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_value</span><span class=\"p\">(</span><span class=\"n\">new_db_table_comment</span> <span class=\"ow\">or</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">),</span>\n            <span class=\"p\">}</span>\n        <span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"BaseDatabaseSchemaEditor.alter_db_tablespace\"><a class=\"viewcode-back\" href=\"../../../../../../ref/schema-editor/#django.db.backends.base.schema.BaseDatabaseSchemaEditor.alter_db_tablespace\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">alter_db_tablespace</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_db_tablespace</span><span class=\"p\">,</span> <span class=\"n\">new_db_tablespace</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Move a model&#39;s table between tablespaces.&quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_retablespace_table</span>\n            <span class=\"o\">%</span> <span class=\"p\">{</span>\n                <span class=\"s2\">&quot;table&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">),</span>\n                <span class=\"s2\">&quot;old_tablespace&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">old_db_tablespace</span><span class=\"p\">),</span>\n                <span class=\"s2\">&quot;new_tablespace&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">new_db_tablespace</span><span class=\"p\">),</span>\n            <span class=\"p\">}</span>\n        <span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"BaseDatabaseSchemaEditor.add_field\"><a class=\"viewcode-back\" href=\"../../../../../../ref/schema-editor/#django.db.backends.base.schema.BaseDatabaseSchemaEditor.add_field\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">add_field</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Create a field on a model. Usually involves adding a column, but may</span>\n<span class=\"sd\">        involve adding a table instead (for M2M fields).</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"c1\"># Special-case implicit M2M tables</span>\n        <span class=\"k\">if</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">many_to_many</span> <span class=\"ow\">and</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">auto_created</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">create_model</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Get the column&#39;s definition</span>\n        <span class=\"n\">definition</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">column_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">include_default</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n        <span class=\"c1\"># It might not actually have a column behind it</span>\n        <span class=\"k\">if</span> <span class=\"n\">definition</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span>\n        <span class=\"k\">if</span> <span class=\"n\">col_type_suffix</span> <span class=\"o\">:=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_type_suffix</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">):</span>\n            <span class=\"n\">definition</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s2\">&quot; </span><span class=\"si\">{</span><span class=\"n\">col_type_suffix</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span>\n        <span class=\"c1\"># Check constraints can go on the column SQL here</span>\n        <span class=\"n\">db_params</span> <span class=\"o\">=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_parameters</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">db_params</span><span class=\"p\">[</span><span class=\"s2\">&quot;check&quot;</span><span class=\"p\">]:</span>\n            <span class=\"n\">definition</span> <span class=\"o\">+=</span> <span class=\"s2\">&quot; &quot;</span> <span class=\"o\">+</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_check_constraint</span> <span class=\"o\">%</span> <span class=\"n\">db_params</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span>\n            <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_foreign_keys</span>\n            <span class=\"ow\">and</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_constraint</span>\n        <span class=\"p\">):</span>\n            <span class=\"n\">constraint_suffix</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;_fk_</span><span class=\"si\">%(to_table)s</span><span class=\"s2\">_</span><span class=\"si\">%(to_column)s</span><span class=\"s2\">&quot;</span>\n            <span class=\"c1\"># Add FK constraint inline, if supported.</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_create_column_inline_fk</span><span class=\"p\">:</span>\n                <span class=\"n\">to_table</span> <span class=\"o\">=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span>\n                <span class=\"n\">to_column</span> <span class=\"o\">=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span>\n                    <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">field_name</span>\n                <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">column</span>\n                <span class=\"n\">namespace</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"o\">=</span> <span class=\"n\">split_identifier</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">)</span>\n                <span class=\"n\">definition</span> <span class=\"o\">+=</span> <span class=\"s2\">&quot; &quot;</span> <span class=\"o\">+</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_create_column_inline_fk</span> <span class=\"o\">%</span> <span class=\"p\">{</span>\n                    <span class=\"s2\">&quot;name&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fk_constraint_name</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">constraint_suffix</span><span class=\"p\">),</span>\n                    <span class=\"s2\">&quot;namespace&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\">.&quot;</span> <span class=\"o\">%</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">namespace</span><span class=\"p\">)</span>\n                    <span class=\"k\">if</span> <span class=\"n\">namespace</span>\n                    <span class=\"k\">else</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;column&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">),</span>\n                    <span class=\"s2\">&quot;to_table&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">to_table</span><span class=\"p\">),</span>\n                    <span class=\"s2\">&quot;to_column&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">to_column</span><span class=\"p\">),</span>\n                    <span class=\"s2\">&quot;deferrable&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">deferrable_sql</span><span class=\"p\">(),</span>\n                <span class=\"p\">}</span>\n            <span class=\"c1\"># Otherwise, add FK constraints later.</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deferred_sql</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_fk_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">constraint_suffix</span><span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n        <span class=\"c1\"># Build the SQL and run it</span>\n        <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_create_column</span> <span class=\"o\">%</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;table&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">),</span>\n            <span class=\"s2\">&quot;column&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">),</span>\n            <span class=\"s2\">&quot;definition&quot;</span><span class=\"p\">:</span> <span class=\"n\">definition</span><span class=\"p\">,</span>\n        <span class=\"p\">}</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Drop the default if we need to</span>\n        <span class=\"c1\"># (Django usually does not use in-database defaults)</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">skip_default_on_alter</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">)</span>\n            <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">effective_default</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n        <span class=\"p\">):</span>\n            <span class=\"n\">changes_sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_alter_column_default_sql</span><span class=\"p\">(</span>\n                <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">drop</span><span class=\"o\">=</span><span class=\"kc\">True</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_alter_column</span> <span class=\"o\">%</span> <span class=\"p\">{</span>\n                <span class=\"s2\">&quot;table&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">),</span>\n                <span class=\"s2\">&quot;changes&quot;</span><span class=\"p\">:</span> <span class=\"n\">changes_sql</span><span class=\"p\">,</span>\n            <span class=\"p\">}</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Add field comment, if required.</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_comment</span>\n            <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_comments</span>\n            <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_comments_inline</span>\n        <span class=\"p\">):</span>\n            <span class=\"n\">field_type</span> <span class=\"o\">=</span> <span class=\"n\">db_params</span><span class=\"p\">[</span><span class=\"s2\">&quot;type&quot;</span><span class=\"p\">]</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                <span class=\"o\">*</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_alter_column_comment_sql</span><span class=\"p\">(</span>\n                    <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">field_type</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_comment</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"c1\"># Add an index, if required</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deferred_sql</span><span class=\"o\">.</span><span class=\"n\">extend</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_field_indexes_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">))</span>\n        <span class=\"c1\"># Reset connection if required</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">connection_persists_old_columns</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span></div>\n\n<div class=\"viewcode-block\" id=\"BaseDatabaseSchemaEditor.remove_field\"><a class=\"viewcode-back\" href=\"../../../../../../ref/schema-editor/#django.db.backends.base.schema.BaseDatabaseSchemaEditor.remove_field\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">remove_field</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Remove a field from a model. Usually involves deleting a column,</span>\n<span class=\"sd\">        but for M2Ms may involve deleting a table.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"c1\"># Special-case implicit M2M tables</span>\n        <span class=\"k\">if</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">many_to_many</span> <span class=\"ow\">and</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">auto_created</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">delete_model</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"p\">)</span>\n        <span class=\"c1\"># It might not actually have a column behind it</span>\n        <span class=\"k\">if</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_parameters</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">)[</span><span class=\"s2\">&quot;type&quot;</span><span class=\"p\">]</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span>\n        <span class=\"c1\"># Drop any FK constraints, MySQL requires explicit deletion</span>\n        <span class=\"k\">if</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"p\">:</span>\n            <span class=\"n\">fk_names</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_constraint_names</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">],</span> <span class=\"n\">foreign_key</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">fk_name</span> <span class=\"ow\">in</span> <span class=\"n\">fk_names</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_delete_fk_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">fk_name</span><span class=\"p\">))</span>\n        <span class=\"c1\"># Delete the column</span>\n        <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_delete_column</span> <span class=\"o\">%</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;table&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">),</span>\n            <span class=\"s2\">&quot;column&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">),</span>\n        <span class=\"p\">}</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Reset connection if required</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">connection_persists_old_columns</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n        <span class=\"c1\"># Remove all deferred statements referencing the deleted column.</span>\n        <span class=\"k\">for</span> <span class=\"n\">sql</span> <span class=\"ow\">in</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deferred_sql</span><span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">Statement</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">sql</span><span class=\"o\">.</span><span class=\"n\">references_column</span><span class=\"p\">(</span>\n                <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">column</span>\n            <span class=\"p\">):</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deferred_sql</span><span class=\"o\">.</span><span class=\"n\">remove</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"BaseDatabaseSchemaEditor.alter_field\"><a class=\"viewcode-back\" href=\"../../../../../../ref/schema-editor/#django.db.backends.base.schema.BaseDatabaseSchemaEditor.alter_field\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">alter_field</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">,</span> <span class=\"n\">strict</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Allow a field&#39;s type, uniqueness, nullability, default, column,</span>\n<span class=\"sd\">        constraints, etc. to be modified.</span>\n<span class=\"sd\">        `old_field` is required to compute the necessary changes.</span>\n<span class=\"sd\">        If `strict` is True, raise errors if the old column does not match</span>\n<span class=\"sd\">        `old_field` precisely.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_field_should_be_altered</span><span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span>\n        <span class=\"c1\"># Ensure this field is even column-based</span>\n        <span class=\"n\">old_db_params</span> <span class=\"o\">=</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">db_parameters</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">)</span>\n        <span class=\"n\">old_type</span> <span class=\"o\">=</span> <span class=\"n\">old_db_params</span><span class=\"p\">[</span><span class=\"s2\">&quot;type&quot;</span><span class=\"p\">]</span>\n        <span class=\"n\">new_db_params</span> <span class=\"o\">=</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">db_parameters</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">)</span>\n        <span class=\"n\">new_type</span> <span class=\"o\">=</span> <span class=\"n\">new_db_params</span><span class=\"p\">[</span><span class=\"s2\">&quot;type&quot;</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">old_type</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"p\">(</span>\n            <span class=\"n\">new_type</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Cannot alter field </span><span class=\"si\">%s</span><span class=\"s2\"> into </span><span class=\"si\">%s</span><span class=\"s2\"> - they do not properly define &quot;</span>\n                <span class=\"s2\">&quot;db_type (are you using a badly-written custom field?)&quot;</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">),</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"p\">(</span>\n            <span class=\"n\">old_type</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span>\n            <span class=\"ow\">and</span> <span class=\"n\">new_type</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span>\n            <span class=\"ow\">and</span> <span class=\"p\">(</span>\n                <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span>\n                <span class=\"ow\">and</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span>\n                <span class=\"ow\">and</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">auto_created</span>\n                <span class=\"ow\">and</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">auto_created</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_alter_many_to_many</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">,</span> <span class=\"n\">strict</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"p\">(</span>\n            <span class=\"n\">old_type</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span>\n            <span class=\"ow\">and</span> <span class=\"n\">new_type</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span>\n            <span class=\"ow\">and</span> <span class=\"p\">(</span>\n                <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span>\n                <span class=\"ow\">and</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span>\n                <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">auto_created</span>\n                <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">auto_created</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">):</span>\n            <span class=\"c1\"># Both sides have through models; this is a no-op.</span>\n            <span class=\"k\">return</span>\n        <span class=\"k\">elif</span> <span class=\"n\">old_type</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">or</span> <span class=\"n\">new_type</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Cannot alter field </span><span class=\"si\">%s</span><span class=\"s2\"> into </span><span class=\"si\">%s</span><span class=\"s2\"> - they are not compatible types &quot;</span>\n                <span class=\"s2\">&quot;(you cannot alter to or from M2M fields, or add or remove &quot;</span>\n                <span class=\"s2\">&quot;through= on M2M fields)&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_alter_field</span><span class=\"p\">(</span>\n            <span class=\"n\">model</span><span class=\"p\">,</span>\n            <span class=\"n\">old_field</span><span class=\"p\">,</span>\n            <span class=\"n\">new_field</span><span class=\"p\">,</span>\n            <span class=\"n\">old_type</span><span class=\"p\">,</span>\n            <span class=\"n\">new_type</span><span class=\"p\">,</span>\n            <span class=\"n\">old_db_params</span><span class=\"p\">,</span>\n            <span class=\"n\">new_db_params</span><span class=\"p\">,</span>\n            <span class=\"n\">strict</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span></div>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_field_db_check</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">field_db_params</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Always check constraints with the same mocked column name to avoid</span>\n        <span class=\"c1\"># recreating constrains when the column is renamed.</span>\n        <span class=\"n\">check_constraints</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">data_type_check_constraints</span>\n        <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_type_parameters</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">)</span>\n        <span class=\"n\">data</span><span class=\"p\">[</span><span class=\"s2\">&quot;column&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;__column_name__&quot;</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">check_constraints</span><span class=\"p\">[</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">get_internal_type</span><span class=\"p\">()]</span> <span class=\"o\">%</span> <span class=\"n\">data</span>\n        <span class=\"k\">except</span> <span class=\"ne\">KeyError</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_alter_field</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">model</span><span class=\"p\">,</span>\n        <span class=\"n\">old_field</span><span class=\"p\">,</span>\n        <span class=\"n\">new_field</span><span class=\"p\">,</span>\n        <span class=\"n\">old_type</span><span class=\"p\">,</span>\n        <span class=\"n\">new_type</span><span class=\"p\">,</span>\n        <span class=\"n\">old_db_params</span><span class=\"p\">,</span>\n        <span class=\"n\">new_db_params</span><span class=\"p\">,</span>\n        <span class=\"n\">strict</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Perform a &quot;physical&quot; (non-ManyToMany) field update.&quot;&quot;&quot;</span>\n        <span class=\"c1\"># Drop any FK constraints, we&#39;ll remake them later</span>\n        <span class=\"n\">fks_dropped</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_foreign_keys</span>\n            <span class=\"ow\">and</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span>\n            <span class=\"ow\">and</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">db_constraint</span>\n            <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_field_should_be_altered</span><span class=\"p\">(</span>\n                <span class=\"n\">old_field</span><span class=\"p\">,</span>\n                <span class=\"n\">new_field</span><span class=\"p\">,</span>\n                <span class=\"n\">ignore</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;db_comment&quot;</span><span class=\"p\">},</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">):</span>\n            <span class=\"n\">fk_names</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_constraint_names</span><span class=\"p\">(</span>\n                <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">],</span> <span class=\"n\">foreign_key</span><span class=\"o\">=</span><span class=\"kc\">True</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">strict</span> <span class=\"ow\">and</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">fk_names</span><span class=\"p\">)</span> <span class=\"o\">!=</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Found wrong number (</span><span class=\"si\">%s</span><span class=\"s2\">) of foreign key constraints for </span><span class=\"si\">%s</span><span class=\"s2\">.</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span>\n                    <span class=\"o\">%</span> <span class=\"p\">(</span>\n                        <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">fk_names</span><span class=\"p\">),</span>\n                        <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span>\n                        <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">,</span>\n                    <span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">fk_name</span> <span class=\"ow\">in</span> <span class=\"n\">fk_names</span><span class=\"p\">:</span>\n                <span class=\"n\">fks_dropped</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">((</span><span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">,))</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_delete_fk_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">fk_name</span><span class=\"p\">))</span>\n        <span class=\"c1\"># Has unique been removed?</span>\n        <span class=\"k\">if</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">unique</span> <span class=\"ow\">and</span> <span class=\"p\">(</span>\n            <span class=\"ow\">not</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">unique</span> <span class=\"ow\">or</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_field_became_primary_key</span><span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">)</span>\n        <span class=\"p\">):</span>\n            <span class=\"c1\"># Find the unique constraint for this field</span>\n            <span class=\"n\">meta_constraint_names</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n                <span class=\"n\">constraint</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"k\">for</span> <span class=\"n\">constraint</span> <span class=\"ow\">in</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">constraints</span>\n            <span class=\"p\">}</span>\n            <span class=\"n\">constraint_names</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_constraint_names</span><span class=\"p\">(</span>\n                <span class=\"n\">model</span><span class=\"p\">,</span>\n                <span class=\"p\">[</span><span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">],</span>\n                <span class=\"n\">unique</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n                <span class=\"n\">primary_key</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n                <span class=\"n\">exclude</span><span class=\"o\">=</span><span class=\"n\">meta_constraint_names</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">strict</span> <span class=\"ow\">and</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">constraint_names</span><span class=\"p\">)</span> <span class=\"o\">!=</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Found wrong number (</span><span class=\"si\">%s</span><span class=\"s2\">) of unique constraints for </span><span class=\"si\">%s</span><span class=\"s2\">.</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span>\n                    <span class=\"o\">%</span> <span class=\"p\">(</span>\n                        <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">constraint_names</span><span class=\"p\">),</span>\n                        <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span>\n                        <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">,</span>\n                    <span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">constraint_name</span> <span class=\"ow\">in</span> <span class=\"n\">constraint_names</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_delete_unique_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">constraint_name</span><span class=\"p\">))</span>\n        <span class=\"c1\"># Drop incoming FK constraints if the field is a primary key or unique,</span>\n        <span class=\"c1\"># which might be a to_field target, and things are going to change.</span>\n        <span class=\"n\">old_collation</span> <span class=\"o\">=</span> <span class=\"n\">old_db_params</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;collation&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">new_collation</span> <span class=\"o\">=</span> <span class=\"n\">new_db_params</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;collation&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">drop_foreign_keys</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_foreign_keys</span>\n            <span class=\"ow\">and</span> <span class=\"p\">(</span>\n                <span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">primary_key</span> <span class=\"ow\">and</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">primary_key</span><span class=\"p\">)</span>\n                <span class=\"ow\">or</span> <span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">unique</span> <span class=\"ow\">and</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">unique</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n            <span class=\"ow\">and</span> <span class=\"p\">((</span><span class=\"n\">old_type</span> <span class=\"o\">!=</span> <span class=\"n\">new_type</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"p\">(</span><span class=\"n\">old_collation</span> <span class=\"o\">!=</span> <span class=\"n\">new_collation</span><span class=\"p\">))</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">drop_foreign_keys</span><span class=\"p\">:</span>\n            <span class=\"c1\"># &#39;_meta.related_field&#39; also contains M2M reverse fields, these</span>\n            <span class=\"c1\"># will be filtered out</span>\n            <span class=\"k\">for</span> <span class=\"n\">_old_rel</span><span class=\"p\">,</span> <span class=\"n\">new_rel</span> <span class=\"ow\">in</span> <span class=\"n\">_related_non_m2m_objects</span><span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">):</span>\n                <span class=\"n\">rel_fk_names</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_constraint_names</span><span class=\"p\">(</span>\n                    <span class=\"n\">new_rel</span><span class=\"o\">.</span><span class=\"n\">related_model</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"n\">new_rel</span><span class=\"o\">.</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">],</span> <span class=\"n\">foreign_key</span><span class=\"o\">=</span><span class=\"kc\">True</span>\n                <span class=\"p\">)</span>\n                <span class=\"k\">for</span> <span class=\"n\">fk_name</span> <span class=\"ow\">in</span> <span class=\"n\">rel_fk_names</span><span class=\"p\">:</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_delete_fk_sql</span><span class=\"p\">(</span><span class=\"n\">new_rel</span><span class=\"o\">.</span><span class=\"n\">related_model</span><span class=\"p\">,</span> <span class=\"n\">fk_name</span><span class=\"p\">))</span>\n        <span class=\"c1\"># Removed an index? (no strict check, as multiple indexes are possible)</span>\n        <span class=\"c1\"># Remove indexes if db_index switched to False or a unique constraint</span>\n        <span class=\"c1\"># will now be used in lieu of an index. The following lines from the</span>\n        <span class=\"c1\"># truth table show all True cases; the rest are False:</span>\n        <span class=\"c1\">#</span>\n        <span class=\"c1\"># old_field.db_index | old_field.unique | new_field.db_index | new_field.unique</span>\n        <span class=\"c1\"># ------------------------------------------------------------------------------</span>\n        <span class=\"c1\"># True               | False            | False              | False</span>\n        <span class=\"c1\"># True               | False            | False              | True</span>\n        <span class=\"c1\"># True               | False            | True               | True</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">db_index</span>\n            <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">unique</span>\n            <span class=\"ow\">and</span> <span class=\"p\">(</span><span class=\"ow\">not</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">db_index</span> <span class=\"ow\">or</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">unique</span><span class=\"p\">)</span>\n        <span class=\"p\">):</span>\n            <span class=\"c1\"># Find the index for this field</span>\n            <span class=\"n\">meta_index_names</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"k\">for</span> <span class=\"n\">index</span> <span class=\"ow\">in</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">indexes</span><span class=\"p\">}</span>\n            <span class=\"c1\"># Retrieve only BTREE indexes since this is what&#39;s created with</span>\n            <span class=\"c1\"># db_index=True.</span>\n            <span class=\"n\">index_names</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_constraint_names</span><span class=\"p\">(</span>\n                <span class=\"n\">model</span><span class=\"p\">,</span>\n                <span class=\"p\">[</span><span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">],</span>\n                <span class=\"n\">index</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n                <span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"n\">Index</span><span class=\"o\">.</span><span class=\"n\">suffix</span><span class=\"p\">,</span>\n                <span class=\"n\">exclude</span><span class=\"o\">=</span><span class=\"n\">meta_index_names</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">index_name</span> <span class=\"ow\">in</span> <span class=\"n\">index_names</span><span class=\"p\">:</span>\n                <span class=\"c1\"># The only way to check if an index was created with</span>\n                <span class=\"c1\"># db_index=True or with Index([&#39;field&#39;], name=&#39;foo&#39;)</span>\n                <span class=\"c1\"># is to look at its name (refs #28053).</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_delete_index_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">index_name</span><span class=\"p\">))</span>\n        <span class=\"c1\"># Change check constraints?</span>\n        <span class=\"n\">old_db_check</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_field_db_check</span><span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">old_db_params</span><span class=\"p\">)</span>\n        <span class=\"n\">new_db_check</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_field_db_check</span><span class=\"p\">(</span><span class=\"n\">new_field</span><span class=\"p\">,</span> <span class=\"n\">new_db_params</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">old_db_check</span> <span class=\"o\">!=</span> <span class=\"n\">new_db_check</span> <span class=\"ow\">and</span> <span class=\"n\">old_db_check</span><span class=\"p\">:</span>\n            <span class=\"n\">meta_constraint_names</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n                <span class=\"n\">constraint</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"k\">for</span> <span class=\"n\">constraint</span> <span class=\"ow\">in</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">constraints</span>\n            <span class=\"p\">}</span>\n            <span class=\"n\">constraint_names</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_constraint_names</span><span class=\"p\">(</span>\n                <span class=\"n\">model</span><span class=\"p\">,</span>\n                <span class=\"p\">[</span><span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">],</span>\n                <span class=\"n\">check</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n                <span class=\"n\">exclude</span><span class=\"o\">=</span><span class=\"n\">meta_constraint_names</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">strict</span> <span class=\"ow\">and</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">constraint_names</span><span class=\"p\">)</span> <span class=\"o\">!=</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Found wrong number (</span><span class=\"si\">%s</span><span class=\"s2\">) of check constraints for </span><span class=\"si\">%s</span><span class=\"s2\">.</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span>\n                    <span class=\"o\">%</span> <span class=\"p\">(</span>\n                        <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">constraint_names</span><span class=\"p\">),</span>\n                        <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span>\n                        <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">,</span>\n                    <span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">constraint_name</span> <span class=\"ow\">in</span> <span class=\"n\">constraint_names</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_delete_check_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">constraint_name</span><span class=\"p\">))</span>\n        <span class=\"c1\"># Have they renamed the column?</span>\n        <span class=\"k\">if</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">column</span> <span class=\"o\">!=</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_rename_field_sql</span><span class=\"p\">(</span>\n                    <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">,</span> <span class=\"n\">new_type</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n            <span class=\"c1\"># Rename all references to the renamed column.</span>\n            <span class=\"k\">for</span> <span class=\"n\">sql</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deferred_sql</span><span class=\"p\">:</span>\n                <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">Statement</span><span class=\"p\">):</span>\n                    <span class=\"n\">sql</span><span class=\"o\">.</span><span class=\"n\">rename_column_references</span><span class=\"p\">(</span>\n                        <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">column</span>\n                    <span class=\"p\">)</span>\n        <span class=\"c1\"># Next, start accumulating actions to do</span>\n        <span class=\"n\">actions</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"n\">null_actions</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"n\">post_actions</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"c1\"># Type suffix change? (e.g. auto increment).</span>\n        <span class=\"n\">old_type_suffix</span> <span class=\"o\">=</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">db_type_suffix</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">)</span>\n        <span class=\"n\">new_type_suffix</span> <span class=\"o\">=</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">db_type_suffix</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Type, collation, or comment change?</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"n\">old_type</span> <span class=\"o\">!=</span> <span class=\"n\">new_type</span>\n            <span class=\"ow\">or</span> <span class=\"n\">old_type_suffix</span> <span class=\"o\">!=</span> <span class=\"n\">new_type_suffix</span>\n            <span class=\"ow\">or</span> <span class=\"n\">old_collation</span> <span class=\"o\">!=</span> <span class=\"n\">new_collation</span>\n            <span class=\"ow\">or</span> <span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_comments</span>\n                <span class=\"ow\">and</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">db_comment</span> <span class=\"o\">!=</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">db_comment</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">):</span>\n            <span class=\"n\">fragment</span><span class=\"p\">,</span> <span class=\"n\">other_actions</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_alter_column_type_sql</span><span class=\"p\">(</span>\n                <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">,</span> <span class=\"n\">new_type</span><span class=\"p\">,</span> <span class=\"n\">old_collation</span><span class=\"p\">,</span> <span class=\"n\">new_collation</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">actions</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">fragment</span><span class=\"p\">)</span>\n            <span class=\"n\">post_actions</span><span class=\"o\">.</span><span class=\"n\">extend</span><span class=\"p\">(</span><span class=\"n\">other_actions</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">db_default</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"n\">NOT_PROVIDED</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"p\">(</span>\n                <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">db_default</span> <span class=\"ow\">is</span> <span class=\"n\">NOT_PROVIDED</span>\n                <span class=\"ow\">or</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">db_default</span> <span class=\"o\">!=</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">db_default</span>\n            <span class=\"p\">):</span>\n                <span class=\"n\">actions</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_alter_column_database_default_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">db_default</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"n\">NOT_PROVIDED</span><span class=\"p\">:</span>\n            <span class=\"n\">actions</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_alter_column_database_default_sql</span><span class=\"p\">(</span>\n                    <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">,</span> <span class=\"n\">drop</span><span class=\"o\">=</span><span class=\"kc\">True</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"c1\"># When changing a column NULL constraint to NOT NULL with a given</span>\n        <span class=\"c1\"># default value, we need to perform 4 steps:</span>\n        <span class=\"c1\">#  1. Add a default for new incoming writes</span>\n        <span class=\"c1\">#  2. Update existing NULL rows with new default</span>\n        <span class=\"c1\">#  3. Replace NULL constraint with NOT NULL</span>\n        <span class=\"c1\">#  4. Drop the default again.</span>\n        <span class=\"c1\"># Default change?</span>\n        <span class=\"n\">needs_database_default</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">null</span>\n            <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">null</span>\n            <span class=\"ow\">and</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">db_default</span> <span class=\"ow\">is</span> <span class=\"n\">NOT_PROVIDED</span>\n        <span class=\"p\">):</span>\n            <span class=\"n\">old_default</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">effective_default</span><span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"p\">)</span>\n            <span class=\"n\">new_default</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">effective_default</span><span class=\"p\">(</span><span class=\"n\">new_field</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"p\">(</span>\n                <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">skip_default_on_alter</span><span class=\"p\">(</span><span class=\"n\">new_field</span><span class=\"p\">)</span>\n                <span class=\"ow\">and</span> <span class=\"n\">old_default</span> <span class=\"o\">!=</span> <span class=\"n\">new_default</span>\n                <span class=\"ow\">and</span> <span class=\"n\">new_default</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n            <span class=\"p\">):</span>\n                <span class=\"n\">needs_database_default</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n                <span class=\"n\">actions</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_alter_column_default_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n        <span class=\"c1\"># Nullability change?</span>\n        <span class=\"k\">if</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">null</span> <span class=\"o\">!=</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">null</span><span class=\"p\">:</span>\n            <span class=\"n\">fragment</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_alter_column_null_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">fragment</span><span class=\"p\">:</span>\n                <span class=\"n\">null_actions</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">fragment</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Only if we have a default and there is a change from NULL to NOT NULL</span>\n        <span class=\"n\">four_way_default_alteration</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">has_default</span><span class=\"p\">()</span> <span class=\"ow\">or</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">db_default</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"n\">NOT_PROVIDED</span>\n        <span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">null</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">null</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">actions</span> <span class=\"ow\">or</span> <span class=\"n\">null_actions</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">four_way_default_alteration</span><span class=\"p\">:</span>\n                <span class=\"c1\"># If we don&#39;t have to do a 4-way default alteration we can</span>\n                <span class=\"c1\"># directly run a (NOT) NULL alteration</span>\n                <span class=\"n\">actions</span> <span class=\"o\">+=</span> <span class=\"n\">null_actions</span>\n            <span class=\"c1\"># Combine actions together if we can (e.g. postgres)</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_combined_alters</span> <span class=\"ow\">and</span> <span class=\"n\">actions</span><span class=\"p\">:</span>\n                <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"nb\">zip</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">actions</span><span class=\"p\">))</span>\n                <span class=\"n\">actions</span> <span class=\"o\">=</span> <span class=\"p\">[(</span><span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">),</span> <span class=\"nb\">sum</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">,</span> <span class=\"p\">[]))]</span>\n            <span class=\"c1\"># Apply those actions</span>\n            <span class=\"k\">for</span> <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"ow\">in</span> <span class=\"n\">actions</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_alter_column</span>\n                    <span class=\"o\">%</span> <span class=\"p\">{</span>\n                        <span class=\"s2\">&quot;table&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">),</span>\n                        <span class=\"s2\">&quot;changes&quot;</span><span class=\"p\">:</span> <span class=\"n\">sql</span><span class=\"p\">,</span>\n                    <span class=\"p\">},</span>\n                    <span class=\"n\">params</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">four_way_default_alteration</span><span class=\"p\">:</span>\n                <span class=\"k\">if</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">db_default</span> <span class=\"ow\">is</span> <span class=\"n\">NOT_PROVIDED</span><span class=\"p\">:</span>\n                    <span class=\"n\">default_sql</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span>\n                    <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">new_default</span><span class=\"p\">]</span>\n                <span class=\"k\">else</span><span class=\"p\">:</span>\n                    <span class=\"n\">default_sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db_default_sql</span><span class=\"p\">(</span><span class=\"n\">new_field</span><span class=\"p\">)</span>\n                <span class=\"c1\"># Update existing rows with default value</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_update_with_default</span>\n                    <span class=\"o\">%</span> <span class=\"p\">{</span>\n                        <span class=\"s2\">&quot;table&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">),</span>\n                        <span class=\"s2\">&quot;column&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">),</span>\n                        <span class=\"s2\">&quot;default&quot;</span><span class=\"p\">:</span> <span class=\"n\">default_sql</span><span class=\"p\">,</span>\n                    <span class=\"p\">},</span>\n                    <span class=\"n\">params</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n                <span class=\"c1\"># Since we didn&#39;t run a NOT NULL change before we need to do it</span>\n                <span class=\"c1\"># now</span>\n                <span class=\"k\">for</span> <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"ow\">in</span> <span class=\"n\">null_actions</span><span class=\"p\">:</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_alter_column</span>\n                        <span class=\"o\">%</span> <span class=\"p\">{</span>\n                            <span class=\"s2\">&quot;table&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">),</span>\n                            <span class=\"s2\">&quot;changes&quot;</span><span class=\"p\">:</span> <span class=\"n\">sql</span><span class=\"p\">,</span>\n                        <span class=\"p\">},</span>\n                        <span class=\"n\">params</span><span class=\"p\">,</span>\n                    <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">post_actions</span><span class=\"p\">:</span>\n            <span class=\"k\">for</span> <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"ow\">in</span> <span class=\"n\">post_actions</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">)</span>\n        <span class=\"c1\"># If primary_key changed to False, delete the primary key constraint.</span>\n        <span class=\"k\">if</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">primary_key</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">primary_key</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_delete_primary_key</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">strict</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Added a unique?</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_unique_should_be_added</span><span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">):</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_unique_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"n\">new_field</span><span class=\"p\">]))</span>\n        <span class=\"c1\"># Added an index? Add an index if db_index switched to True or a unique</span>\n        <span class=\"c1\"># constraint will no longer be used in lieu of an index. The following</span>\n        <span class=\"c1\"># lines from the truth table show all True cases; the rest are False:</span>\n        <span class=\"c1\">#</span>\n        <span class=\"c1\"># old_field.db_index | old_field.unique | new_field.db_index | new_field.unique</span>\n        <span class=\"c1\"># ------------------------------------------------------------------------------</span>\n        <span class=\"c1\"># False              | False            | True               | False</span>\n        <span class=\"c1\"># False              | True             | True               | False</span>\n        <span class=\"c1\"># True               | True             | True               | False</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"p\">(</span><span class=\"ow\">not</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">db_index</span> <span class=\"ow\">or</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">unique</span><span class=\"p\">)</span>\n            <span class=\"ow\">and</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">db_index</span>\n            <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">unique</span>\n        <span class=\"p\">):</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_index_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">fields</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">new_field</span><span class=\"p\">]))</span>\n        <span class=\"c1\"># Type alteration on primary key? Then we need to alter the column</span>\n        <span class=\"c1\"># referring to us.</span>\n        <span class=\"n\">rels_to_update</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">if</span> <span class=\"n\">drop_foreign_keys</span><span class=\"p\">:</span>\n            <span class=\"n\">rels_to_update</span><span class=\"o\">.</span><span class=\"n\">extend</span><span class=\"p\">(</span><span class=\"n\">_related_non_m2m_objects</span><span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">))</span>\n        <span class=\"c1\"># Changed to become primary key?</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_field_became_primary_key</span><span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">):</span>\n            <span class=\"c1\"># Make the new one</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_primary_key_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">))</span>\n            <span class=\"c1\"># Update all referencing columns</span>\n            <span class=\"n\">rels_to_update</span><span class=\"o\">.</span><span class=\"n\">extend</span><span class=\"p\">(</span><span class=\"n\">_related_non_m2m_objects</span><span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">))</span>\n        <span class=\"c1\"># Handle our type alters on the other end of rels from the PK stuff above</span>\n        <span class=\"k\">for</span> <span class=\"n\">old_rel</span><span class=\"p\">,</span> <span class=\"n\">new_rel</span> <span class=\"ow\">in</span> <span class=\"n\">rels_to_update</span><span class=\"p\">:</span>\n            <span class=\"n\">rel_db_params</span> <span class=\"o\">=</span> <span class=\"n\">new_rel</span><span class=\"o\">.</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_parameters</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">)</span>\n            <span class=\"n\">rel_type</span> <span class=\"o\">=</span> <span class=\"n\">rel_db_params</span><span class=\"p\">[</span><span class=\"s2\">&quot;type&quot;</span><span class=\"p\">]</span>\n            <span class=\"n\">rel_collation</span> <span class=\"o\">=</span> <span class=\"n\">rel_db_params</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;collation&quot;</span><span class=\"p\">)</span>\n            <span class=\"n\">old_rel_db_params</span> <span class=\"o\">=</span> <span class=\"n\">old_rel</span><span class=\"o\">.</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_parameters</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">)</span>\n            <span class=\"n\">old_rel_collation</span> <span class=\"o\">=</span> <span class=\"n\">old_rel_db_params</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;collation&quot;</span><span class=\"p\">)</span>\n            <span class=\"n\">fragment</span><span class=\"p\">,</span> <span class=\"n\">other_actions</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_alter_column_type_sql</span><span class=\"p\">(</span>\n                <span class=\"n\">new_rel</span><span class=\"o\">.</span><span class=\"n\">related_model</span><span class=\"p\">,</span>\n                <span class=\"n\">old_rel</span><span class=\"o\">.</span><span class=\"n\">field</span><span class=\"p\">,</span>\n                <span class=\"n\">new_rel</span><span class=\"o\">.</span><span class=\"n\">field</span><span class=\"p\">,</span>\n                <span class=\"n\">rel_type</span><span class=\"p\">,</span>\n                <span class=\"n\">old_rel_collation</span><span class=\"p\">,</span>\n                <span class=\"n\">rel_collation</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_alter_column</span>\n                <span class=\"o\">%</span> <span class=\"p\">{</span>\n                    <span class=\"s2\">&quot;table&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">new_rel</span><span class=\"o\">.</span><span class=\"n\">related_model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">),</span>\n                    <span class=\"s2\">&quot;changes&quot;</span><span class=\"p\">:</span> <span class=\"n\">fragment</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">],</span>\n                <span class=\"p\">},</span>\n                <span class=\"n\">fragment</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">],</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"ow\">in</span> <span class=\"n\">other_actions</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Does it have a foreign key?</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_foreign_keys</span>\n            <span class=\"ow\">and</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span>\n            <span class=\"ow\">and</span> <span class=\"p\">(</span>\n                <span class=\"n\">fks_dropped</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">db_constraint</span>\n            <span class=\"p\">)</span>\n            <span class=\"ow\">and</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">db_constraint</span>\n        <span class=\"p\">):</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_fk_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_fk_</span><span class=\"si\">%(to_table)s</span><span class=\"s2\">_</span><span class=\"si\">%(to_column)s</span><span class=\"s2\">&quot;</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"c1\"># Rebuild FKs that pointed to us if we previously had to drop them</span>\n        <span class=\"k\">if</span> <span class=\"n\">drop_foreign_keys</span><span class=\"p\">:</span>\n            <span class=\"k\">for</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">rel</span> <span class=\"ow\">in</span> <span class=\"n\">rels_to_update</span><span class=\"p\">:</span>\n                <span class=\"k\">if</span> <span class=\"n\">rel</span><span class=\"o\">.</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_constraint</span><span class=\"p\">:</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_fk_sql</span><span class=\"p\">(</span><span class=\"n\">rel</span><span class=\"o\">.</span><span class=\"n\">related_model</span><span class=\"p\">,</span> <span class=\"n\">rel</span><span class=\"o\">.</span><span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_fk&quot;</span><span class=\"p\">)</span>\n                    <span class=\"p\">)</span>\n        <span class=\"c1\"># Does it have check constraints we need to add?</span>\n        <span class=\"k\">if</span> <span class=\"n\">old_db_check</span> <span class=\"o\">!=</span> <span class=\"n\">new_db_check</span> <span class=\"ow\">and</span> <span class=\"n\">new_db_check</span><span class=\"p\">:</span>\n            <span class=\"n\">constraint_name</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_index_name</span><span class=\"p\">(</span>\n                <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">],</span> <span class=\"n\">suffix</span><span class=\"o\">=</span><span class=\"s2\">&quot;_check&quot;</span>\n            <span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_check_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">constraint_name</span><span class=\"p\">,</span> <span class=\"n\">new_db_params</span><span class=\"p\">[</span><span class=\"s2\">&quot;check&quot;</span><span class=\"p\">])</span>\n            <span class=\"p\">)</span>\n        <span class=\"c1\"># Drop the default if we need to</span>\n        <span class=\"c1\"># (Django usually does not use in-database defaults)</span>\n        <span class=\"k\">if</span> <span class=\"n\">needs_database_default</span><span class=\"p\">:</span>\n            <span class=\"n\">changes_sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_alter_column_default_sql</span><span class=\"p\">(</span>\n                <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">,</span> <span class=\"n\">drop</span><span class=\"o\">=</span><span class=\"kc\">True</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_alter_column</span> <span class=\"o\">%</span> <span class=\"p\">{</span>\n                <span class=\"s2\">&quot;table&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">),</span>\n                <span class=\"s2\">&quot;changes&quot;</span><span class=\"p\">:</span> <span class=\"n\">changes_sql</span><span class=\"p\">,</span>\n            <span class=\"p\">}</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Reset connection if required</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">connection_persists_old_columns</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_alter_column_null_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Hook to specialize column null alteration.</span>\n\n<span class=\"sd\">        Return a (sql, params) fragment to set a column to null or non-null</span>\n<span class=\"sd\">        as required by new_field, or None if no changes are required.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">interprets_empty_strings_as_nulls</span>\n            <span class=\"ow\">and</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">empty_strings_allowed</span>\n        <span class=\"p\">):</span>\n            <span class=\"c1\"># The field is nullable in the database anyway, leave it alone.</span>\n            <span class=\"k\">return</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">new_db_params</span> <span class=\"o\">=</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">db_parameters</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">)</span>\n            <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_alter_column_null</span>\n                <span class=\"k\">if</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">null</span>\n                <span class=\"k\">else</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_alter_column_not_null</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"p\">(</span>\n                <span class=\"n\">sql</span>\n                <span class=\"o\">%</span> <span class=\"p\">{</span>\n                    <span class=\"s2\">&quot;column&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">),</span>\n                    <span class=\"s2\">&quot;type&quot;</span><span class=\"p\">:</span> <span class=\"n\">new_db_params</span><span class=\"p\">[</span><span class=\"s2\">&quot;type&quot;</span><span class=\"p\">],</span>\n                <span class=\"p\">},</span>\n                <span class=\"p\">[],</span>\n            <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_alter_column_default_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">,</span> <span class=\"n\">drop</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Hook to specialize column default alteration.</span>\n\n<span class=\"sd\">        Return a (sql, params) fragment to add or drop (depending on the drop</span>\n<span class=\"sd\">        argument) a default to new_field&#39;s column.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">new_default</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">effective_default</span><span class=\"p\">(</span><span class=\"n\">new_field</span><span class=\"p\">)</span>\n        <span class=\"n\">default</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_column_default_sql</span><span class=\"p\">(</span><span class=\"n\">new_field</span><span class=\"p\">)</span>\n        <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">new_default</span><span class=\"p\">]</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">drop</span><span class=\"p\">:</span>\n            <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">elif</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">requires_literal_defaults</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Some databases (Oracle) can&#39;t take defaults as a parameter</span>\n            <span class=\"c1\"># If this is the case, the SchemaEditor for that database should</span>\n            <span class=\"c1\"># implement prepare_default().</span>\n            <span class=\"n\">default</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prepare_default</span><span class=\"p\">(</span><span class=\"n\">new_default</span><span class=\"p\">)</span>\n            <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n\n        <span class=\"n\">new_db_params</span> <span class=\"o\">=</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">db_parameters</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">drop</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">null</span><span class=\"p\">:</span>\n                <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_alter_column_no_default_null</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_alter_column_no_default</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_alter_column_default</span>\n        <span class=\"k\">return</span> <span class=\"p\">(</span>\n            <span class=\"n\">sql</span>\n            <span class=\"o\">%</span> <span class=\"p\">{</span>\n                <span class=\"s2\">&quot;column&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">),</span>\n                <span class=\"s2\">&quot;type&quot;</span><span class=\"p\">:</span> <span class=\"n\">new_db_params</span><span class=\"p\">[</span><span class=\"s2\">&quot;type&quot;</span><span class=\"p\">],</span>\n                <span class=\"s2\">&quot;default&quot;</span><span class=\"p\">:</span> <span class=\"n\">default</span><span class=\"p\">,</span>\n            <span class=\"p\">},</span>\n            <span class=\"n\">params</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_alter_column_database_default_sql</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">,</span> <span class=\"n\">drop</span><span class=\"o\">=</span><span class=\"kc\">False</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Hook to specialize column database default alteration.</span>\n\n<span class=\"sd\">        Return a (sql, params) fragment to add or drop (depending on the drop</span>\n<span class=\"sd\">        argument) a default to new_field&#39;s column.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">drop</span><span class=\"p\">:</span>\n            <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_alter_column_no_default</span>\n            <span class=\"n\">default_sql</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;&quot;</span>\n            <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_alter_column_default</span>\n            <span class=\"n\">default_sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db_default_sql</span><span class=\"p\">(</span><span class=\"n\">new_field</span><span class=\"p\">)</span>\n\n        <span class=\"n\">new_db_params</span> <span class=\"o\">=</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">db_parameters</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"p\">(</span>\n            <span class=\"n\">sql</span>\n            <span class=\"o\">%</span> <span class=\"p\">{</span>\n                <span class=\"s2\">&quot;column&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">),</span>\n                <span class=\"s2\">&quot;type&quot;</span><span class=\"p\">:</span> <span class=\"n\">new_db_params</span><span class=\"p\">[</span><span class=\"s2\">&quot;type&quot;</span><span class=\"p\">],</span>\n                <span class=\"s2\">&quot;default&quot;</span><span class=\"p\">:</span> <span class=\"n\">default_sql</span><span class=\"p\">,</span>\n            <span class=\"p\">},</span>\n            <span class=\"n\">params</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_alter_column_type_sql</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">,</span> <span class=\"n\">new_type</span><span class=\"p\">,</span> <span class=\"n\">old_collation</span><span class=\"p\">,</span> <span class=\"n\">new_collation</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Hook to specialize column type alteration for different backends,</span>\n<span class=\"sd\">        for cases when a creation type is different to an alteration type</span>\n<span class=\"sd\">        (e.g. SERIAL in PostgreSQL, PostGIS fields).</span>\n\n<span class=\"sd\">        Return a two-tuple of: an SQL fragment of (sql, params) to insert into</span>\n<span class=\"sd\">        an ALTER TABLE statement and a list of extra (sql, params) tuples to</span>\n<span class=\"sd\">        run once the field is altered.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">other_actions</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">if</span> <span class=\"n\">collate_sql</span> <span class=\"o\">:=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_collate_sql</span><span class=\"p\">(</span>\n            <span class=\"n\">new_collation</span><span class=\"p\">,</span> <span class=\"n\">old_collation</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span>\n        <span class=\"p\">):</span>\n            <span class=\"n\">collate_sql</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s2\">&quot; </span><span class=\"si\">{</span><span class=\"n\">collate_sql</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">collate_sql</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;&quot;</span>\n        <span class=\"c1\"># Comment change?</span>\n        <span class=\"n\">comment_sql</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_comments</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">many_to_many</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">db_comment</span> <span class=\"o\">!=</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">db_comment</span><span class=\"p\">:</span>\n                <span class=\"c1\"># PostgreSQL and Oracle can&#39;t execute &#39;ALTER COLUMN ...&#39; and</span>\n                <span class=\"c1\"># &#39;COMMENT ON ...&#39; at the same time.</span>\n                <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_alter_column_comment_sql</span><span class=\"p\">(</span>\n                    <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">,</span> <span class=\"n\">new_type</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">db_comment</span>\n                <span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"n\">sql</span><span class=\"p\">:</span>\n                    <span class=\"n\">other_actions</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">((</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">))</span>\n            <span class=\"k\">if</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">db_comment</span><span class=\"p\">:</span>\n                <span class=\"n\">comment_sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_comment_sql</span><span class=\"p\">(</span><span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">db_comment</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"p\">(</span>\n            <span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_alter_column_type</span>\n                <span class=\"o\">%</span> <span class=\"p\">{</span>\n                    <span class=\"s2\">&quot;column&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">),</span>\n                    <span class=\"s2\">&quot;type&quot;</span><span class=\"p\">:</span> <span class=\"n\">new_type</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;collation&quot;</span><span class=\"p\">:</span> <span class=\"n\">collate_sql</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;comment&quot;</span><span class=\"p\">:</span> <span class=\"n\">comment_sql</span><span class=\"p\">,</span>\n                <span class=\"p\">},</span>\n                <span class=\"p\">[],</span>\n            <span class=\"p\">),</span>\n            <span class=\"n\">other_actions</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_alter_column_comment_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">,</span> <span class=\"n\">new_type</span><span class=\"p\">,</span> <span class=\"n\">new_db_comment</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_alter_column_comment</span>\n            <span class=\"o\">%</span> <span class=\"p\">{</span>\n                <span class=\"s2\">&quot;table&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">),</span>\n                <span class=\"s2\">&quot;column&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">),</span>\n                <span class=\"s2\">&quot;comment&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_comment_sql</span><span class=\"p\">(</span><span class=\"n\">new_db_comment</span><span class=\"p\">),</span>\n            <span class=\"p\">},</span>\n            <span class=\"p\">[],</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_comment_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">comment</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_value</span><span class=\"p\">(</span><span class=\"n\">comment</span> <span class=\"ow\">or</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_alter_many_to_many</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">,</span> <span class=\"n\">strict</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Alter M2Ms to repoint their to= endpoints.&quot;&quot;&quot;</span>\n        <span class=\"c1\"># Rename the through table</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span>\n            <span class=\"o\">!=</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span>\n        <span class=\"p\">):</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">alter_db_table</span><span class=\"p\">(</span>\n                <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"p\">,</span>\n                <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span>\n                <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n        <span class=\"c1\"># Repoint the FK to the other side</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">alter_field</span><span class=\"p\">(</span>\n            <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"p\">,</span>\n            <span class=\"c1\"># The field that points to the target model is needed, so we can</span>\n            <span class=\"c1\"># tell alter_field to change it - this is m2m_reverse_field_name()</span>\n            <span class=\"c1\"># (as opposed to m2m_field_name(), which points to our model).</span>\n            <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span>\n                <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">m2m_reverse_field_name</span><span class=\"p\">()</span>\n            <span class=\"p\">),</span>\n            <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span>\n                <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">m2m_reverse_field_name</span><span class=\"p\">()</span>\n            <span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">alter_field</span><span class=\"p\">(</span>\n            <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"p\">,</span>\n            <span class=\"c1\"># for self-referential models we need to alter field from the other end too</span>\n            <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">m2m_field_name</span><span class=\"p\">()),</span>\n            <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">through</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span><span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">m2m_field_name</span><span class=\"p\">()),</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_create_index_name</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">table_name</span><span class=\"p\">,</span> <span class=\"n\">column_names</span><span class=\"p\">,</span> <span class=\"n\">suffix</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Generate a unique name for an index/unique constraint.</span>\n\n<span class=\"sd\">        The name is divided into 3 parts: the table name, the column names,</span>\n<span class=\"sd\">        and a unique digest and suffix.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">table_name</span> <span class=\"o\">=</span> <span class=\"n\">split_identifier</span><span class=\"p\">(</span><span class=\"n\">table_name</span><span class=\"p\">)</span>\n        <span class=\"n\">hash_suffix_part</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span>\n            <span class=\"n\">names_digest</span><span class=\"p\">(</span><span class=\"n\">table_name</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">column_names</span><span class=\"p\">,</span> <span class=\"n\">length</span><span class=\"o\">=</span><span class=\"mi\">8</span><span class=\"p\">),</span>\n            <span class=\"n\">suffix</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">max_length</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">max_name_length</span><span class=\"p\">()</span> <span class=\"ow\">or</span> <span class=\"mi\">200</span>\n        <span class=\"c1\"># If everything fits into max_length, use that name.</span>\n        <span class=\"n\">index_name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\">_</span><span class=\"si\">%s</span><span class=\"s2\">_</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">table_name</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_&quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">column_names</span><span class=\"p\">),</span> <span class=\"n\">hash_suffix_part</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">index_name</span><span class=\"p\">)</span> <span class=\"o\">&lt;=</span> <span class=\"n\">max_length</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">index_name</span>\n        <span class=\"c1\"># Shorten a long suffix.</span>\n        <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">hash_suffix_part</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"n\">max_length</span> <span class=\"o\">/</span> <span class=\"mi\">3</span><span class=\"p\">:</span>\n            <span class=\"n\">hash_suffix_part</span> <span class=\"o\">=</span> <span class=\"n\">hash_suffix_part</span><span class=\"p\">[:</span> <span class=\"n\">max_length</span> <span class=\"o\">//</span> <span class=\"mi\">3</span><span class=\"p\">]</span>\n        <span class=\"n\">other_length</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">max_length</span> <span class=\"o\">-</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">hash_suffix_part</span><span class=\"p\">))</span> <span class=\"o\">//</span> <span class=\"mi\">2</span> <span class=\"o\">-</span> <span class=\"mi\">1</span>\n        <span class=\"n\">index_name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\">_</span><span class=\"si\">%s</span><span class=\"s2\">_</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span>\n            <span class=\"n\">table_name</span><span class=\"p\">[:</span><span class=\"n\">other_length</span><span class=\"p\">],</span>\n            <span class=\"s2\">&quot;_&quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">column_names</span><span class=\"p\">)[:</span><span class=\"n\">other_length</span><span class=\"p\">],</span>\n            <span class=\"n\">hash_suffix_part</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"c1\"># Prepend D if needed to prevent the name from starting with an</span>\n        <span class=\"c1\"># underscore or a number (not permitted on Oracle).</span>\n        <span class=\"k\">if</span> <span class=\"n\">index_name</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;_&quot;</span> <span class=\"ow\">or</span> <span class=\"n\">index_name</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">isdigit</span><span class=\"p\">():</span>\n            <span class=\"n\">index_name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;D</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"n\">index_name</span><span class=\"p\">[:</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n        <span class=\"k\">return</span> <span class=\"n\">index_name</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_get_index_tablespace_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">fields</span><span class=\"p\">,</span> <span class=\"n\">db_tablespace</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">db_tablespace</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">fields</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">1</span> <span class=\"ow\">and</span> <span class=\"n\">fields</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">db_tablespace</span><span class=\"p\">:</span>\n                <span class=\"n\">db_tablespace</span> <span class=\"o\">=</span> <span class=\"n\">fields</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">db_tablespace</span>\n            <span class=\"k\">elif</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">DEFAULT_INDEX_TABLESPACE</span><span class=\"p\">:</span>\n                <span class=\"n\">db_tablespace</span> <span class=\"o\">=</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">DEFAULT_INDEX_TABLESPACE</span>\n            <span class=\"k\">elif</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_tablespace</span><span class=\"p\">:</span>\n                <span class=\"n\">db_tablespace</span> <span class=\"o\">=</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_tablespace</span>\n        <span class=\"k\">if</span> <span class=\"n\">db_tablespace</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"s2\">&quot; &quot;</span> <span class=\"o\">+</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">tablespace_sql</span><span class=\"p\">(</span><span class=\"n\">db_tablespace</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_index_condition_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">condition</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">condition</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"s2\">&quot; WHERE &quot;</span> <span class=\"o\">+</span> <span class=\"n\">condition</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_index_include_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">columns</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">columns</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_covering_indexes</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"s2\">&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"n\">Statement</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot; INCLUDE (</span><span class=\"si\">%(columns)s</span><span class=\"s2\">)&quot;</span><span class=\"p\">,</span>\n            <span class=\"n\">columns</span><span class=\"o\">=</span><span class=\"n\">Columns</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span> <span class=\"n\">columns</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_create_index_sql</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">model</span><span class=\"p\">,</span>\n        <span class=\"o\">*</span><span class=\"p\">,</span>\n        <span class=\"n\">fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">suffix</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span>\n        <span class=\"n\">using</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span>\n        <span class=\"n\">db_tablespace</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">col_suffixes</span><span class=\"o\">=</span><span class=\"p\">(),</span>\n        <span class=\"n\">sql</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">opclasses</span><span class=\"o\">=</span><span class=\"p\">(),</span>\n        <span class=\"n\">condition</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">include</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">expressions</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return the SQL statement to create the index for one or several fields</span>\n<span class=\"sd\">        or expressions. `sql` can be specified if the syntax differs from the</span>\n<span class=\"sd\">        standard (GIS indexes, ...).</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">fields</span> <span class=\"o\">=</span> <span class=\"n\">fields</span> <span class=\"ow\">or</span> <span class=\"p\">[]</span>\n        <span class=\"n\">expressions</span> <span class=\"o\">=</span> <span class=\"n\">expressions</span> <span class=\"ow\">or</span> <span class=\"p\">[]</span>\n        <span class=\"n\">compiler</span> <span class=\"o\">=</span> <span class=\"n\">Query</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">alias_cols</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">get_compiler</span><span class=\"p\">(</span>\n            <span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">tablespace_sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_index_tablespace_sql</span><span class=\"p\">(</span>\n            <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">fields</span><span class=\"p\">,</span> <span class=\"n\">db_tablespace</span><span class=\"o\">=</span><span class=\"n\">db_tablespace</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">columns</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">column</span> <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span><span class=\"p\">]</span>\n        <span class=\"n\">sql_create_index</span> <span class=\"o\">=</span> <span class=\"n\">sql</span> <span class=\"ow\">or</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_create_index</span>\n        <span class=\"n\">table</span> <span class=\"o\">=</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span>\n\n        <span class=\"k\">def</span> <span class=\"nf\">create_index_name</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n            <span class=\"k\">nonlocal</span> <span class=\"n\">name</span>\n            <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_index_name</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">Statement</span><span class=\"p\">(</span>\n            <span class=\"n\">sql_create_index</span><span class=\"p\">,</span>\n            <span class=\"n\">table</span><span class=\"o\">=</span><span class=\"n\">Table</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">),</span>\n            <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">IndexName</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">,</span> <span class=\"n\">columns</span><span class=\"p\">,</span> <span class=\"n\">suffix</span><span class=\"p\">,</span> <span class=\"n\">create_index_name</span><span class=\"p\">),</span>\n            <span class=\"n\">using</span><span class=\"o\">=</span><span class=\"n\">using</span><span class=\"p\">,</span>\n            <span class=\"n\">columns</span><span class=\"o\">=</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_index_columns</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">,</span> <span class=\"n\">columns</span><span class=\"p\">,</span> <span class=\"n\">col_suffixes</span><span class=\"p\">,</span> <span class=\"n\">opclasses</span><span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"n\">columns</span>\n                <span class=\"k\">else</span> <span class=\"n\">Expressions</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">,</span> <span class=\"n\">expressions</span><span class=\"p\">,</span> <span class=\"n\">compiler</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_value</span><span class=\"p\">)</span>\n            <span class=\"p\">),</span>\n            <span class=\"n\">extra</span><span class=\"o\">=</span><span class=\"n\">tablespace_sql</span><span class=\"p\">,</span>\n            <span class=\"n\">condition</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_index_condition_sql</span><span class=\"p\">(</span><span class=\"n\">condition</span><span class=\"p\">),</span>\n            <span class=\"n\">include</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_index_include_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">include</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_delete_index_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">sql</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">Statement</span><span class=\"p\">(</span>\n            <span class=\"n\">sql</span> <span class=\"ow\">or</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_delete_index</span><span class=\"p\">,</span>\n            <span class=\"n\">table</span><span class=\"o\">=</span><span class=\"n\">Table</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">),</span>\n            <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_rename_index_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">old_name</span><span class=\"p\">,</span> <span class=\"n\">new_name</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">Statement</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_rename_index</span><span class=\"p\">,</span>\n            <span class=\"n\">table</span><span class=\"o\">=</span><span class=\"n\">Table</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">),</span>\n            <span class=\"n\">old_name</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">old_name</span><span class=\"p\">),</span>\n            <span class=\"n\">new_name</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">new_name</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_index_columns</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">table</span><span class=\"p\">,</span> <span class=\"n\">columns</span><span class=\"p\">,</span> <span class=\"n\">col_suffixes</span><span class=\"p\">,</span> <span class=\"n\">opclasses</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">Columns</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">,</span> <span class=\"n\">columns</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">,</span> <span class=\"n\">col_suffixes</span><span class=\"o\">=</span><span class=\"n\">col_suffixes</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_model_indexes_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a list of all index SQL statements (field indexes,</span>\n<span class=\"sd\">        index_together, Meta.indexes) for the specified model.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">managed</span> <span class=\"ow\">or</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">proxy</span> <span class=\"ow\">or</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">swapped</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"p\">[]</span>\n        <span class=\"n\">output</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">local_fields</span><span class=\"p\">:</span>\n            <span class=\"n\">output</span><span class=\"o\">.</span><span class=\"n\">extend</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_field_indexes_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">))</span>\n\n        <span class=\"c1\"># RemovedInDjango51Warning.</span>\n        <span class=\"k\">for</span> <span class=\"n\">field_names</span> <span class=\"ow\">in</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">index_together</span><span class=\"p\">:</span>\n            <span class=\"n\">fields</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">field_names</span><span class=\"p\">]</span>\n            <span class=\"n\">output</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_index_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">fields</span><span class=\"o\">=</span><span class=\"n\">fields</span><span class=\"p\">,</span> <span class=\"n\">suffix</span><span class=\"o\">=</span><span class=\"s2\">&quot;_idx&quot;</span><span class=\"p\">))</span>\n\n        <span class=\"k\">for</span> <span class=\"n\">index</span> <span class=\"ow\">in</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">indexes</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"p\">(</span>\n                <span class=\"ow\">not</span> <span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">contains_expressions</span>\n                <span class=\"ow\">or</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_expression_indexes</span>\n            <span class=\"p\">):</span>\n                <span class=\"n\">output</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">index</span><span class=\"o\">.</span><span class=\"n\">create_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">))</span>\n        <span class=\"k\">return</span> <span class=\"n\">output</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_field_indexes_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a list of all index SQL statements for the specified field.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">output</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_field_should_be_indexed</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">):</span>\n            <span class=\"n\">output</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_index_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">fields</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">field</span><span class=\"p\">]))</span>\n        <span class=\"k\">return</span> <span class=\"n\">output</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_field_should_be_altered</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">,</span> <span class=\"n\">ignore</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"n\">ignore</span> <span class=\"o\">=</span> <span class=\"n\">ignore</span> <span class=\"ow\">or</span> <span class=\"nb\">set</span><span class=\"p\">()</span>\n        <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">old_path</span><span class=\"p\">,</span> <span class=\"n\">old_args</span><span class=\"p\">,</span> <span class=\"n\">old_kwargs</span> <span class=\"o\">=</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">deconstruct</span><span class=\"p\">()</span>\n        <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">new_path</span><span class=\"p\">,</span> <span class=\"n\">new_args</span><span class=\"p\">,</span> <span class=\"n\">new_kwargs</span> <span class=\"o\">=</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">deconstruct</span><span class=\"p\">()</span>\n        <span class=\"c1\"># Don&#39;t alter when:</span>\n        <span class=\"c1\"># - changing only a field name</span>\n        <span class=\"c1\"># - changing an attribute that doesn&#39;t affect the schema</span>\n        <span class=\"c1\"># - changing an attribute in the provided set of ignored attributes</span>\n        <span class=\"c1\"># - adding only a db_column and the column name is not changed</span>\n        <span class=\"k\">for</span> <span class=\"n\">attr</span> <span class=\"ow\">in</span> <span class=\"n\">ignore</span><span class=\"o\">.</span><span class=\"n\">union</span><span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">non_db_attrs</span><span class=\"p\">):</span>\n            <span class=\"n\">old_kwargs</span><span class=\"o\">.</span><span class=\"n\">pop</span><span class=\"p\">(</span><span class=\"n\">attr</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">attr</span> <span class=\"ow\">in</span> <span class=\"n\">ignore</span><span class=\"o\">.</span><span class=\"n\">union</span><span class=\"p\">(</span><span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">non_db_attrs</span><span class=\"p\">):</span>\n            <span class=\"n\">new_kwargs</span><span class=\"o\">.</span><span class=\"n\">pop</span><span class=\"p\">(</span><span class=\"n\">attr</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">)</span> <span class=\"o\">!=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span>\n            <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">column</span>\n        <span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"p\">(</span><span class=\"n\">old_path</span><span class=\"p\">,</span> <span class=\"n\">old_args</span><span class=\"p\">,</span> <span class=\"n\">old_kwargs</span><span class=\"p\">)</span> <span class=\"o\">!=</span> <span class=\"p\">(</span><span class=\"n\">new_path</span><span class=\"p\">,</span> <span class=\"n\">new_args</span><span class=\"p\">,</span> <span class=\"n\">new_kwargs</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_field_should_be_indexed</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_index</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">unique</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_field_became_primary_key</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"ow\">not</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">primary_key</span> <span class=\"ow\">and</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">primary_key</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_unique_should_be_added</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">(</span>\n            <span class=\"ow\">not</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">primary_key</span>\n            <span class=\"ow\">and</span> <span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">unique</span>\n            <span class=\"ow\">and</span> <span class=\"p\">(</span><span class=\"ow\">not</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">unique</span> <span class=\"ow\">or</span> <span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">primary_key</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_rename_field_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">table</span><span class=\"p\">,</span> <span class=\"n\">old_field</span><span class=\"p\">,</span> <span class=\"n\">new_field</span><span class=\"p\">,</span> <span class=\"n\">new_type</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_rename_column</span> <span class=\"o\">%</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;table&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">),</span>\n            <span class=\"s2\">&quot;old_column&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">old_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">),</span>\n            <span class=\"s2\">&quot;new_column&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">new_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">),</span>\n            <span class=\"s2\">&quot;type&quot;</span><span class=\"p\">:</span> <span class=\"n\">new_type</span><span class=\"p\">,</span>\n        <span class=\"p\">}</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_create_fk_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">suffix</span><span class=\"p\">):</span>\n        <span class=\"n\">table</span> <span class=\"o\">=</span> <span class=\"n\">Table</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">)</span>\n        <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fk_constraint_name</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">suffix</span><span class=\"p\">)</span>\n        <span class=\"n\">column</span> <span class=\"o\">=</span> <span class=\"n\">Columns</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">],</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">)</span>\n        <span class=\"n\">to_table</span> <span class=\"o\">=</span> <span class=\"n\">Table</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">target_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">)</span>\n        <span class=\"n\">to_column</span> <span class=\"o\">=</span> <span class=\"n\">Columns</span><span class=\"p\">(</span>\n            <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">target_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span>\n            <span class=\"p\">[</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">target_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">],</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">deferrable</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">deferrable_sql</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">Statement</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_create_fk</span><span class=\"p\">,</span>\n            <span class=\"n\">table</span><span class=\"o\">=</span><span class=\"n\">table</span><span class=\"p\">,</span>\n            <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">name</span><span class=\"p\">,</span>\n            <span class=\"n\">column</span><span class=\"o\">=</span><span class=\"n\">column</span><span class=\"p\">,</span>\n            <span class=\"n\">to_table</span><span class=\"o\">=</span><span class=\"n\">to_table</span><span class=\"p\">,</span>\n            <span class=\"n\">to_column</span><span class=\"o\">=</span><span class=\"n\">to_column</span><span class=\"p\">,</span>\n            <span class=\"n\">deferrable</span><span class=\"o\">=</span><span class=\"n\">deferrable</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_fk_constraint_name</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">suffix</span><span class=\"p\">):</span>\n        <span class=\"k\">def</span> <span class=\"nf\">create_fk_name</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_index_name</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">))</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">ForeignKeyName</span><span class=\"p\">(</span>\n            <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span>\n            <span class=\"p\">[</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">],</span>\n            <span class=\"n\">split_identifier</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">target_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">)[</span><span class=\"mi\">1</span><span class=\"p\">],</span>\n            <span class=\"p\">[</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">target_field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">],</span>\n            <span class=\"n\">suffix</span><span class=\"p\">,</span>\n            <span class=\"n\">create_fk_name</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_delete_fk_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_delete_constraint_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_delete_fk</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_deferrable_constraint_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">deferrable</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">deferrable</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"s2\">&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">deferrable</span> <span class=\"o\">==</span> <span class=\"n\">Deferrable</span><span class=\"o\">.</span><span class=\"n\">DEFERRED</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"s2\">&quot; DEFERRABLE INITIALLY DEFERRED&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">deferrable</span> <span class=\"o\">==</span> <span class=\"n\">Deferrable</span><span class=\"o\">.</span><span class=\"n\">IMMEDIATE</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"s2\">&quot; DEFERRABLE INITIALLY IMMEDIATE&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_unique_sql</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">model</span><span class=\"p\">,</span>\n        <span class=\"n\">fields</span><span class=\"p\">,</span>\n        <span class=\"n\">name</span><span class=\"p\">,</span>\n        <span class=\"n\">condition</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">deferrable</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">include</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">opclasses</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">expressions</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"n\">deferrable</span>\n            <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_deferrable_unique_constraints</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n        <span class=\"k\">if</span> <span class=\"n\">condition</span> <span class=\"ow\">or</span> <span class=\"n\">include</span> <span class=\"ow\">or</span> <span class=\"n\">opclasses</span> <span class=\"ow\">or</span> <span class=\"n\">expressions</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Databases support conditional, covering, and functional unique</span>\n            <span class=\"c1\"># constraints via a unique index.</span>\n            <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_unique_sql</span><span class=\"p\">(</span>\n                <span class=\"n\">model</span><span class=\"p\">,</span>\n                <span class=\"n\">fields</span><span class=\"p\">,</span>\n                <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">name</span><span class=\"p\">,</span>\n                <span class=\"n\">condition</span><span class=\"o\">=</span><span class=\"n\">condition</span><span class=\"p\">,</span>\n                <span class=\"n\">include</span><span class=\"o\">=</span><span class=\"n\">include</span><span class=\"p\">,</span>\n                <span class=\"n\">opclasses</span><span class=\"o\">=</span><span class=\"n\">opclasses</span><span class=\"p\">,</span>\n                <span class=\"n\">expressions</span><span class=\"o\">=</span><span class=\"n\">expressions</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">sql</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deferred_sql</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n        <span class=\"n\">constraint</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_unique_constraint</span> <span class=\"o\">%</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;columns&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">([</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span><span class=\"p\">]),</span>\n            <span class=\"s2\">&quot;deferrable&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_deferrable_constraint_sql</span><span class=\"p\">(</span><span class=\"n\">deferrable</span><span class=\"p\">),</span>\n        <span class=\"p\">}</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_constraint</span> <span class=\"o\">%</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;name&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">),</span>\n            <span class=\"s2\">&quot;constraint&quot;</span><span class=\"p\">:</span> <span class=\"n\">constraint</span><span class=\"p\">,</span>\n        <span class=\"p\">}</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_create_unique_sql</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">model</span><span class=\"p\">,</span>\n        <span class=\"n\">fields</span><span class=\"p\">,</span>\n        <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">condition</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">deferrable</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">include</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">opclasses</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">expressions</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"p\">(</span>\n                <span class=\"n\">deferrable</span>\n                <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_deferrable_unique_constraints</span>\n            <span class=\"p\">)</span>\n            <span class=\"ow\">or</span> <span class=\"p\">(</span><span class=\"n\">condition</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_partial_indexes</span><span class=\"p\">)</span>\n            <span class=\"ow\">or</span> <span class=\"p\">(</span><span class=\"n\">include</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_covering_indexes</span><span class=\"p\">)</span>\n            <span class=\"ow\">or</span> <span class=\"p\">(</span>\n                <span class=\"n\">expressions</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_expression_indexes</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n\n        <span class=\"n\">compiler</span> <span class=\"o\">=</span> <span class=\"n\">Query</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">alias_cols</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">get_compiler</span><span class=\"p\">(</span>\n            <span class=\"n\">connection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">table</span> <span class=\"o\">=</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span>\n        <span class=\"n\">columns</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">column</span> <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_unique_constraint_name</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">,</span> <span class=\"n\">columns</span><span class=\"p\">,</span> <span class=\"n\">quote</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">condition</span> <span class=\"ow\">or</span> <span class=\"n\">include</span> <span class=\"ow\">or</span> <span class=\"n\">opclasses</span> <span class=\"ow\">or</span> <span class=\"n\">expressions</span><span class=\"p\">:</span>\n            <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_create_unique_index</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_create_unique</span>\n        <span class=\"k\">if</span> <span class=\"n\">columns</span><span class=\"p\">:</span>\n            <span class=\"n\">columns</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_index_columns</span><span class=\"p\">(</span>\n                <span class=\"n\">table</span><span class=\"p\">,</span> <span class=\"n\">columns</span><span class=\"p\">,</span> <span class=\"n\">col_suffixes</span><span class=\"o\">=</span><span class=\"p\">(),</span> <span class=\"n\">opclasses</span><span class=\"o\">=</span><span class=\"n\">opclasses</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">columns</span> <span class=\"o\">=</span> <span class=\"n\">Expressions</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">,</span> <span class=\"n\">expressions</span><span class=\"p\">,</span> <span class=\"n\">compiler</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_value</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">Statement</span><span class=\"p\">(</span>\n            <span class=\"n\">sql</span><span class=\"p\">,</span>\n            <span class=\"n\">table</span><span class=\"o\">=</span><span class=\"n\">Table</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">),</span>\n            <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">name</span><span class=\"p\">,</span>\n            <span class=\"n\">columns</span><span class=\"o\">=</span><span class=\"n\">columns</span><span class=\"p\">,</span>\n            <span class=\"n\">condition</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_index_condition_sql</span><span class=\"p\">(</span><span class=\"n\">condition</span><span class=\"p\">),</span>\n            <span class=\"n\">deferrable</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_deferrable_constraint_sql</span><span class=\"p\">(</span><span class=\"n\">deferrable</span><span class=\"p\">),</span>\n            <span class=\"n\">include</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_index_include_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">include</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_unique_constraint_name</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">table</span><span class=\"p\">,</span> <span class=\"n\">columns</span><span class=\"p\">,</span> <span class=\"n\">quote</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">quote</span><span class=\"p\">:</span>\n\n            <span class=\"k\">def</span> <span class=\"nf\">create_unique_name</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n                <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_index_name</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">))</span>\n\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">create_unique_name</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_index_name</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">IndexName</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">,</span> <span class=\"n\">columns</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_uniq&quot;</span><span class=\"p\">,</span> <span class=\"n\">create_unique_name</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_delete_unique_sql</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">model</span><span class=\"p\">,</span>\n        <span class=\"n\">name</span><span class=\"p\">,</span>\n        <span class=\"n\">condition</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">deferrable</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">include</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">opclasses</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">expressions</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"p\">(</span>\n                <span class=\"n\">deferrable</span>\n                <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_deferrable_unique_constraints</span>\n            <span class=\"p\">)</span>\n            <span class=\"ow\">or</span> <span class=\"p\">(</span><span class=\"n\">condition</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_partial_indexes</span><span class=\"p\">)</span>\n            <span class=\"ow\">or</span> <span class=\"p\">(</span><span class=\"n\">include</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_covering_indexes</span><span class=\"p\">)</span>\n            <span class=\"ow\">or</span> <span class=\"p\">(</span>\n                <span class=\"n\">expressions</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_expression_indexes</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n        <span class=\"k\">if</span> <span class=\"n\">condition</span> <span class=\"ow\">or</span> <span class=\"n\">include</span> <span class=\"ow\">or</span> <span class=\"n\">opclasses</span> <span class=\"ow\">or</span> <span class=\"n\">expressions</span><span class=\"p\">:</span>\n            <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_delete_index</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_delete_unique</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_delete_constraint_sql</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_check_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">check</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_constraint</span> <span class=\"o\">%</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;name&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">),</span>\n            <span class=\"s2\">&quot;constraint&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_check_constraint</span> <span class=\"o\">%</span> <span class=\"p\">{</span><span class=\"s2\">&quot;check&quot;</span><span class=\"p\">:</span> <span class=\"n\">check</span><span class=\"p\">},</span>\n        <span class=\"p\">}</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_create_check_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">check</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_table_check_constraints</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n        <span class=\"k\">return</span> <span class=\"n\">Statement</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_create_check</span><span class=\"p\">,</span>\n            <span class=\"n\">table</span><span class=\"o\">=</span><span class=\"n\">Table</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">),</span>\n            <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">),</span>\n            <span class=\"n\">check</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_delete_check_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_table_check_constraints</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_delete_constraint_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_delete_check</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_delete_constraint_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">template</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">Statement</span><span class=\"p\">(</span>\n            <span class=\"n\">template</span><span class=\"p\">,</span>\n            <span class=\"n\">table</span><span class=\"o\">=</span><span class=\"n\">Table</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">),</span>\n            <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_constraint_names</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">model</span><span class=\"p\">,</span>\n        <span class=\"n\">column_names</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">unique</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">primary_key</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">index</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">foreign_key</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">check</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">exclude</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Return all constraint names matching the columns and conditions.&quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">column_names</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">column_names</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">introspection</span><span class=\"o\">.</span><span class=\"n\">identifier_converter</span><span class=\"p\">(</span>\n                    <span class=\"n\">truncate_name</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">max_name_length</span><span class=\"p\">())</span>\n                <span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">truncates_names</span>\n                <span class=\"k\">else</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">introspection</span><span class=\"o\">.</span><span class=\"n\">identifier_converter</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n                <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">column_names</span>\n            <span class=\"p\">]</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">cursor</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">cursor</span><span class=\"p\">:</span>\n            <span class=\"n\">constraints</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">introspection</span><span class=\"o\">.</span><span class=\"n\">get_constraints</span><span class=\"p\">(</span>\n                <span class=\"n\">cursor</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span>\n            <span class=\"p\">)</span>\n        <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">infodict</span> <span class=\"ow\">in</span> <span class=\"n\">constraints</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n            <span class=\"k\">if</span> <span class=\"n\">column_names</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">or</span> <span class=\"n\">column_names</span> <span class=\"o\">==</span> <span class=\"n\">infodict</span><span class=\"p\">[</span><span class=\"s2\">&quot;columns&quot;</span><span class=\"p\">]:</span>\n                <span class=\"k\">if</span> <span class=\"n\">unique</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">infodict</span><span class=\"p\">[</span><span class=\"s2\">&quot;unique&quot;</span><span class=\"p\">]</span> <span class=\"o\">!=</span> <span class=\"n\">unique</span><span class=\"p\">:</span>\n                    <span class=\"k\">continue</span>\n                <span class=\"k\">if</span> <span class=\"n\">primary_key</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">infodict</span><span class=\"p\">[</span><span class=\"s2\">&quot;primary_key&quot;</span><span class=\"p\">]</span> <span class=\"o\">!=</span> <span class=\"n\">primary_key</span><span class=\"p\">:</span>\n                    <span class=\"k\">continue</span>\n                <span class=\"k\">if</span> <span class=\"n\">index</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">infodict</span><span class=\"p\">[</span><span class=\"s2\">&quot;index&quot;</span><span class=\"p\">]</span> <span class=\"o\">!=</span> <span class=\"n\">index</span><span class=\"p\">:</span>\n                    <span class=\"k\">continue</span>\n                <span class=\"k\">if</span> <span class=\"n\">check</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">infodict</span><span class=\"p\">[</span><span class=\"s2\">&quot;check&quot;</span><span class=\"p\">]</span> <span class=\"o\">!=</span> <span class=\"n\">check</span><span class=\"p\">:</span>\n                    <span class=\"k\">continue</span>\n                <span class=\"k\">if</span> <span class=\"n\">foreign_key</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">infodict</span><span class=\"p\">[</span><span class=\"s2\">&quot;foreign_key&quot;</span><span class=\"p\">]:</span>\n                    <span class=\"k\">continue</span>\n                <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">infodict</span><span class=\"p\">[</span><span class=\"s2\">&quot;type&quot;</span><span class=\"p\">]</span> <span class=\"o\">!=</span> <span class=\"n\">type_</span><span class=\"p\">:</span>\n                    <span class=\"k\">continue</span>\n                <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">exclude</span> <span class=\"ow\">or</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">exclude</span><span class=\"p\">:</span>\n                    <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">result</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_delete_primary_key</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">strict</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"n\">constraint_names</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_constraint_names</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">primary_key</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">strict</span> <span class=\"ow\">and</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">constraint_names</span><span class=\"p\">)</span> <span class=\"o\">!=</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Found wrong number (</span><span class=\"si\">%s</span><span class=\"s2\">) of PK constraints for </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span>\n                    <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">constraint_names</span><span class=\"p\">),</span>\n                    <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">constraint_name</span> <span class=\"ow\">in</span> <span class=\"n\">constraint_names</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_delete_primary_key_sql</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">constraint_name</span><span class=\"p\">))</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_create_primary_key_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">Statement</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_create_pk</span><span class=\"p\">,</span>\n            <span class=\"n\">table</span><span class=\"o\">=</span><span class=\"n\">Table</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">),</span>\n            <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_index_name</span><span class=\"p\">(</span>\n                    <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">],</span> <span class=\"n\">suffix</span><span class=\"o\">=</span><span class=\"s2\">&quot;_pk&quot;</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">),</span>\n            <span class=\"n\">columns</span><span class=\"o\">=</span><span class=\"n\">Columns</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">],</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_delete_primary_key_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_delete_constraint_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_delete_pk</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_collate_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">collation</span><span class=\"p\">,</span> <span class=\"n\">old_collation</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">table_name</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;COLLATE &quot;</span> <span class=\"o\">+</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">collation</span><span class=\"p\">)</span> <span class=\"k\">if</span> <span class=\"n\">collation</span> <span class=\"k\">else</span> <span class=\"s2\">&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">remove_procedure</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">procedure_name</span><span class=\"p\">,</span> <span class=\"n\">param_types</span><span class=\"o\">=</span><span class=\"p\">()):</span>\n        <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">sql_delete_procedure</span> <span class=\"o\">%</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;procedure&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">quote_name</span><span class=\"p\">(</span><span class=\"n\">procedure_name</span><span class=\"p\">),</span>\n            <span class=\"s2\">&quot;param_types&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;,&quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">param_types</span><span class=\"p\">),</span>\n        <span class=\"p\">}</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">)</span></div>\n</pre></div>", "current_page_name": "_modules/django/db/backends/base/schema", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "favicon_url": null, "logo_url": null, "alabaster_version": "0.7.13", "include_console_assets": false}