{"parents": [{"link": "../../../../../", "title": "Module code"}, {"link": "../../../../", "title": "django"}], "title": "django.contrib.postgres.aggregates.general", "body": "<h1>Source code for django.contrib.postgres.aggregates.general</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">json</span>\n<span class=\"kn\">import</span> <span class=\"nn\">warnings</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">django.contrib.postgres.fields</span> <span class=\"kn\">import</span> <span class=\"n\">ArrayField</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models</span> <span class=\"kn\">import</span> <span class=\"n\">Aggregate</span><span class=\"p\">,</span> <span class=\"n\">BooleanField</span><span class=\"p\">,</span> <span class=\"n\">JSONField</span><span class=\"p\">,</span> <span class=\"n\">TextField</span><span class=\"p\">,</span> <span class=\"n\">Value</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils.deprecation</span> <span class=\"kn\">import</span> <span class=\"n\">RemovedInDjango51Warning</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.mixins</span> <span class=\"kn\">import</span> <span class=\"n\">OrderableAggMixin</span>\n\n<span class=\"n\">__all__</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n    <span class=\"s2\">&quot;ArrayAgg&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;BitAnd&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;BitOr&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;BitXor&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;BoolAnd&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;BoolOr&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;JSONBAgg&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;StringAgg&quot;</span><span class=\"p\">,</span>\n<span class=\"p\">]</span>\n\n\n<div class=\"viewcode-block\" id=\"ArrayAgg\"><a class=\"viewcode-back\" href=\"../../../../../../ref/contrib/postgres/aggregates/#django.contrib.postgres.aggregates.ArrayAgg\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">ArrayAgg</span><span class=\"p\">(</span><span class=\"n\">OrderableAggMixin</span><span class=\"p\">,</span> <span class=\"n\">Aggregate</span><span class=\"p\">):</span>\n    <span class=\"n\">function</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;ARRAY_AGG&quot;</span>\n    <span class=\"n\">template</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%(function)s</span><span class=\"s2\">(</span><span class=\"si\">%(distinct)s%(expressions)s</span><span class=\"s2\"> </span><span class=\"si\">%(ordering)s</span><span class=\"s2\">)&quot;</span>\n    <span class=\"n\">allow_distinct</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">output_field</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">ArrayField</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">source_expressions</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">output_field</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"BitAnd\"><a class=\"viewcode-back\" href=\"../../../../../../ref/contrib/postgres/aggregates/#django.contrib.postgres.aggregates.BitAnd\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">BitAnd</span><span class=\"p\">(</span><span class=\"n\">Aggregate</span><span class=\"p\">):</span>\n    <span class=\"n\">function</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;BIT_AND&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"BitOr\"><a class=\"viewcode-back\" href=\"../../../../../../ref/contrib/postgres/aggregates/#django.contrib.postgres.aggregates.BitOr\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">BitOr</span><span class=\"p\">(</span><span class=\"n\">Aggregate</span><span class=\"p\">):</span>\n    <span class=\"n\">function</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;BIT_OR&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"BitXor\"><a class=\"viewcode-back\" href=\"../../../../../../ref/contrib/postgres/aggregates/#django.contrib.postgres.aggregates.BitXor\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">BitXor</span><span class=\"p\">(</span><span class=\"n\">Aggregate</span><span class=\"p\">):</span>\n    <span class=\"n\">function</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;BIT_XOR&quot;</span></div>\n\n\n<div class=\"viewcode-block\" id=\"BoolAnd\"><a class=\"viewcode-back\" href=\"../../../../../../ref/contrib/postgres/aggregates/#django.contrib.postgres.aggregates.BoolAnd\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">BoolAnd</span><span class=\"p\">(</span><span class=\"n\">Aggregate</span><span class=\"p\">):</span>\n    <span class=\"n\">function</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;BOOL_AND&quot;</span>\n    <span class=\"n\">output_field</span> <span class=\"o\">=</span> <span class=\"n\">BooleanField</span><span class=\"p\">()</span></div>\n\n\n<div class=\"viewcode-block\" id=\"BoolOr\"><a class=\"viewcode-back\" href=\"../../../../../../ref/contrib/postgres/aggregates/#django.contrib.postgres.aggregates.BoolOr\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">BoolOr</span><span class=\"p\">(</span><span class=\"n\">Aggregate</span><span class=\"p\">):</span>\n    <span class=\"n\">function</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;BOOL_OR&quot;</span>\n    <span class=\"n\">output_field</span> <span class=\"o\">=</span> <span class=\"n\">BooleanField</span><span class=\"p\">()</span></div>\n\n\n<div class=\"viewcode-block\" id=\"JSONBAgg\"><a class=\"viewcode-back\" href=\"../../../../../../ref/contrib/postgres/aggregates/#django.contrib.postgres.aggregates.JSONBAgg\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">JSONBAgg</span><span class=\"p\">(</span><span class=\"n\">OrderableAggMixin</span><span class=\"p\">,</span> <span class=\"n\">Aggregate</span><span class=\"p\">):</span>\n    <span class=\"n\">function</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;JSONB_AGG&quot;</span>\n    <span class=\"n\">template</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%(function)s</span><span class=\"s2\">(</span><span class=\"si\">%(distinct)s%(expressions)s</span><span class=\"s2\"> </span><span class=\"si\">%(ordering)s</span><span class=\"s2\">)&quot;</span>\n    <span class=\"n\">allow_distinct</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"n\">output_field</span> <span class=\"o\">=</span> <span class=\"n\">JSONField</span><span class=\"p\">()</span>\n\n    <span class=\"c1\"># RemovedInDjango51Warning: When the deprecation ends, remove __init__().</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">expressions</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">extra</span><span class=\"p\">):</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">expressions</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"n\">default</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">extra</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">default</span><span class=\"p\">,</span> <span class=\"n\">Value</span><span class=\"p\">)</span>\n            <span class=\"ow\">and</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">default</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">)</span>\n            <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">default</span><span class=\"o\">.</span><span class=\"n\">output_field</span><span class=\"p\">,</span> <span class=\"n\">JSONField</span><span class=\"p\">)</span>\n        <span class=\"p\">):</span>\n            <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">default</span><span class=\"o\">.</span><span class=\"n\">value</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">decoded</span> <span class=\"o\">=</span> <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">loads</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n            <span class=\"k\">except</span> <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">JSONDecodeError</span><span class=\"p\">:</span>\n                <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Passing a Value() with an output_field that isn&#39;t a JSONField as &quot;</span>\n                    <span class=\"s2\">&quot;JSONBAgg(default) is deprecated. Pass default=&quot;</span>\n                    <span class=\"sa\">f</span><span class=\"s2\">&quot;Value(</span><span class=\"si\">{</span><span class=\"n\">value</span><span class=\"si\">!r}</span><span class=\"s2\">, output_field=JSONField()) instead.&quot;</span><span class=\"p\">,</span>\n                    <span class=\"n\">stacklevel</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">,</span>\n                    <span class=\"n\">category</span><span class=\"o\">=</span><span class=\"n\">RemovedInDjango51Warning</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">default</span><span class=\"o\">.</span><span class=\"n\">output_field</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">output_field</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">default</span> <span class=\"o\">=</span> <span class=\"n\">Value</span><span class=\"p\">(</span><span class=\"n\">decoded</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">output_field</span><span class=\"p\">)</span>\n                <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Passing an encoded JSON string as JSONBAgg(default) is &quot;</span>\n                    <span class=\"sa\">f</span><span class=\"s2\">&quot;deprecated. Pass default=</span><span class=\"si\">{</span><span class=\"n\">decoded</span><span class=\"si\">!r}</span><span class=\"s2\"> instead.&quot;</span><span class=\"p\">,</span>\n                    <span class=\"n\">stacklevel</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">,</span>\n                    <span class=\"n\">category</span><span class=\"o\">=</span><span class=\"n\">RemovedInDjango51Warning</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"StringAgg\"><a class=\"viewcode-back\" href=\"../../../../../../ref/contrib/postgres/aggregates/#django.contrib.postgres.aggregates.StringAgg\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">StringAgg</span><span class=\"p\">(</span><span class=\"n\">OrderableAggMixin</span><span class=\"p\">,</span> <span class=\"n\">Aggregate</span><span class=\"p\">):</span>\n    <span class=\"n\">function</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;STRING_AGG&quot;</span>\n    <span class=\"n\">template</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%(function)s</span><span class=\"s2\">(</span><span class=\"si\">%(distinct)s%(expressions)s</span><span class=\"s2\"> </span><span class=\"si\">%(ordering)s</span><span class=\"s2\">)&quot;</span>\n    <span class=\"n\">allow_distinct</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"n\">output_field</span> <span class=\"o\">=</span> <span class=\"n\">TextField</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">expression</span><span class=\"p\">,</span> <span class=\"n\">delimiter</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">extra</span><span class=\"p\">):</span>\n        <span class=\"n\">delimiter_expr</span> <span class=\"o\">=</span> <span class=\"n\">Value</span><span class=\"p\">(</span><span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">delimiter</span><span class=\"p\">))</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"n\">expression</span><span class=\"p\">,</span> <span class=\"n\">delimiter_expr</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">extra</span><span class=\"p\">)</span></div>\n</pre></div>", "current_page_name": "_modules/django/contrib/postgres/aggregates/general", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "favicon_url": null, "logo_url": null, "alabaster_version": "0.7.13", "include_console_assets": false}
