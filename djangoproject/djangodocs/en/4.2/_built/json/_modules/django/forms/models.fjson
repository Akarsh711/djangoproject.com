{"parents": [{"link": "../../../", "title": "Module code"}, {"link": "../../", "title": "django"}], "title": "django.forms.models", "body": "<h1>Source code for django.forms.models</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">Helper functions for creating Form classes from Django models</span>\n<span class=\"sd\">and database field objects.</span>\n<span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"kn\">from</span> <span class=\"nn\">itertools</span> <span class=\"kn\">import</span> <span class=\"n\">chain</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.exceptions</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">NON_FIELD_ERRORS</span><span class=\"p\">,</span>\n    <span class=\"n\">FieldError</span><span class=\"p\">,</span>\n    <span class=\"n\">ImproperlyConfigured</span><span class=\"p\">,</span>\n    <span class=\"n\">ValidationError</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models.utils</span> <span class=\"kn\">import</span> <span class=\"n\">AltersData</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.forms.fields</span> <span class=\"kn\">import</span> <span class=\"n\">ChoiceField</span><span class=\"p\">,</span> <span class=\"n\">Field</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.forms.forms</span> <span class=\"kn\">import</span> <span class=\"n\">BaseForm</span><span class=\"p\">,</span> <span class=\"n\">DeclarativeFieldsMetaclass</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.forms.formsets</span> <span class=\"kn\">import</span> <span class=\"n\">BaseFormSet</span><span class=\"p\">,</span> <span class=\"n\">formset_factory</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.forms.utils</span> <span class=\"kn\">import</span> <span class=\"n\">ErrorList</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.forms.widgets</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">HiddenInput</span><span class=\"p\">,</span>\n    <span class=\"n\">MultipleHiddenInput</span><span class=\"p\">,</span>\n    <span class=\"n\">RadioSelect</span><span class=\"p\">,</span>\n    <span class=\"n\">SelectMultiple</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils.text</span> <span class=\"kn\">import</span> <span class=\"n\">capfirst</span><span class=\"p\">,</span> <span class=\"n\">get_text_list</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils.translation</span> <span class=\"kn\">import</span> <span class=\"n\">gettext</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils.translation</span> <span class=\"kn\">import</span> <span class=\"n\">gettext_lazy</span> <span class=\"k\">as</span> <span class=\"n\">_</span>\n\n<span class=\"n\">__all__</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n    <span class=\"s2\">&quot;ModelForm&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;BaseModelForm&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;model_to_dict&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;fields_for_model&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;ModelChoiceField&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;ModelMultipleChoiceField&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;ALL_FIELDS&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;BaseModelFormSet&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;modelformset_factory&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;BaseInlineFormSet&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;inlineformset_factory&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;modelform_factory&quot;</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n\n<span class=\"n\">ALL_FIELDS</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;__all__&quot;</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">construct_instance</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">exclude</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Construct and return a model instance from the bound ``form``&#39;s</span>\n<span class=\"sd\">    ``cleaned_data``, but do not save the returned instance to the database.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"kn\">from</span> <span class=\"nn\">django.db</span> <span class=\"kn\">import</span> <span class=\"n\">models</span>\n\n    <span class=\"n\">opts</span> <span class=\"o\">=</span> <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">_meta</span>\n\n    <span class=\"n\">cleaned_data</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span>\n    <span class=\"n\">file_field_list</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n    <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">:</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"ow\">not</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">editable</span>\n            <span class=\"ow\">or</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">,</span> <span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">AutoField</span><span class=\"p\">)</span>\n            <span class=\"ow\">or</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">cleaned_data</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">continue</span>\n        <span class=\"k\">if</span> <span class=\"n\">fields</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span><span class=\"p\">:</span>\n            <span class=\"k\">continue</span>\n        <span class=\"k\">if</span> <span class=\"n\">exclude</span> <span class=\"ow\">and</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">exclude</span><span class=\"p\">:</span>\n            <span class=\"k\">continue</span>\n        <span class=\"c1\"># Leave defaults for fields that aren&#39;t in POST data, except for</span>\n        <span class=\"c1\"># checkbox inputs because they don&#39;t appear in POST data if not checked.</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">has_default</span><span class=\"p\">()</span>\n            <span class=\"ow\">and</span> <span class=\"n\">form</span><span class=\"p\">[</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">widget</span><span class=\"o\">.</span><span class=\"n\">value_omitted_from_data</span><span class=\"p\">(</span>\n                <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">files</span><span class=\"p\">,</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">add_prefix</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n            <span class=\"ow\">and</span> <span class=\"n\">cleaned_data</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"ow\">in</span> <span class=\"n\">form</span><span class=\"p\">[</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">empty_values</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">continue</span>\n        <span class=\"c1\"># Defer saving file-type fields until after the other fields, so a</span>\n        <span class=\"c1\"># callable upload_to can use the values from other fields.</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">,</span> <span class=\"n\">models</span><span class=\"o\">.</span><span class=\"n\">FileField</span><span class=\"p\">):</span>\n            <span class=\"n\">file_field_list</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">save_form_data</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">])</span>\n\n    <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">file_field_list</span><span class=\"p\">:</span>\n        <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">save_form_data</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">])</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">instance</span>\n\n\n<span class=\"c1\"># ModelForms #################################################################</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">model_to_dict</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">exclude</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Return a dict containing the data in ``instance`` suitable for passing as</span>\n<span class=\"sd\">    a Form&#39;s ``initial`` keyword argument.</span>\n\n<span class=\"sd\">    ``fields`` is an optional list of field names. If provided, return only the</span>\n<span class=\"sd\">    named.</span>\n\n<span class=\"sd\">    ``exclude`` is an optional list of field names. If provided, exclude the</span>\n<span class=\"sd\">    named from the returned dict, even if they are listed in the ``fields``</span>\n<span class=\"sd\">    argument.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">opts</span> <span class=\"o\">=</span> <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">_meta</span>\n    <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n    <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">chain</span><span class=\"p\">(</span><span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">concrete_fields</span><span class=\"p\">,</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">private_fields</span><span class=\"p\">,</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">many_to_many</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">,</span> <span class=\"s2\">&quot;editable&quot;</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">):</span>\n            <span class=\"k\">continue</span>\n        <span class=\"k\">if</span> <span class=\"n\">fields</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span><span class=\"p\">:</span>\n            <span class=\"k\">continue</span>\n        <span class=\"k\">if</span> <span class=\"n\">exclude</span> <span class=\"ow\">and</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">exclude</span><span class=\"p\">:</span>\n            <span class=\"k\">continue</span>\n        <span class=\"n\">data</span><span class=\"p\">[</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">value_from_object</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">data</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">apply_limit_choices_to_to_formfield</span><span class=\"p\">(</span><span class=\"n\">formfield</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Apply limit_choices_to to the formfield&#39;s queryset if needed.&quot;&quot;&quot;</span>\n    <span class=\"kn\">from</span> <span class=\"nn\">django.db.models</span> <span class=\"kn\">import</span> <span class=\"n\">Exists</span><span class=\"p\">,</span> <span class=\"n\">OuterRef</span><span class=\"p\">,</span> <span class=\"n\">Q</span>\n\n    <span class=\"k\">if</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">formfield</span><span class=\"p\">,</span> <span class=\"s2\">&quot;queryset&quot;</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">formfield</span><span class=\"p\">,</span> <span class=\"s2\">&quot;get_limit_choices_to&quot;</span><span class=\"p\">):</span>\n        <span class=\"n\">limit_choices_to</span> <span class=\"o\">=</span> <span class=\"n\">formfield</span><span class=\"o\">.</span><span class=\"n\">get_limit_choices_to</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">limit_choices_to</span><span class=\"p\">:</span>\n            <span class=\"n\">complex_filter</span> <span class=\"o\">=</span> <span class=\"n\">limit_choices_to</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">complex_filter</span><span class=\"p\">,</span> <span class=\"n\">Q</span><span class=\"p\">):</span>\n                <span class=\"n\">complex_filter</span> <span class=\"o\">=</span> <span class=\"n\">Q</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"n\">limit_choices_to</span><span class=\"p\">)</span>\n            <span class=\"n\">complex_filter</span> <span class=\"o\">&amp;=</span> <span class=\"n\">Q</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">OuterRef</span><span class=\"p\">(</span><span class=\"s2\">&quot;pk&quot;</span><span class=\"p\">))</span>\n            <span class=\"c1\"># Use Exists() to avoid potential duplicates.</span>\n            <span class=\"n\">formfield</span><span class=\"o\">.</span><span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"n\">formfield</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span>\n                <span class=\"n\">Exists</span><span class=\"p\">(</span><span class=\"n\">formfield</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_base_manager</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">complex_filter</span><span class=\"p\">)),</span>\n            <span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">fields_for_model</span><span class=\"p\">(</span>\n    <span class=\"n\">model</span><span class=\"p\">,</span>\n    <span class=\"n\">fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">exclude</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">widgets</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">formfield_callback</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">localized_fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">labels</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">help_texts</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">error_messages</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">field_classes</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"o\">*</span><span class=\"p\">,</span>\n    <span class=\"n\">apply_limit_choices_to</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n    <span class=\"n\">form_declared_fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n<span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Return a dictionary containing form fields for the given model.</span>\n\n<span class=\"sd\">    ``fields`` is an optional list of field names. If provided, return only the</span>\n<span class=\"sd\">    named fields.</span>\n\n<span class=\"sd\">    ``exclude`` is an optional list of field names. If provided, exclude the</span>\n<span class=\"sd\">    named fields from the returned fields, even if they are listed in the</span>\n<span class=\"sd\">    ``fields`` argument.</span>\n\n<span class=\"sd\">    ``widgets`` is a dictionary of model field names mapped to a widget.</span>\n\n<span class=\"sd\">    ``formfield_callback`` is a callable that takes a model field and returns</span>\n<span class=\"sd\">    a form field.</span>\n\n<span class=\"sd\">    ``localized_fields`` is a list of names of fields which should be localized.</span>\n\n<span class=\"sd\">    ``labels`` is a dictionary of model field names mapped to a label.</span>\n\n<span class=\"sd\">    ``help_texts`` is a dictionary of model field names mapped to a help text.</span>\n\n<span class=\"sd\">    ``error_messages`` is a dictionary of model field names mapped to a</span>\n<span class=\"sd\">    dictionary of error messages.</span>\n\n<span class=\"sd\">    ``field_classes`` is a dictionary of model field names mapped to a form</span>\n<span class=\"sd\">    field class.</span>\n\n<span class=\"sd\">    ``apply_limit_choices_to`` is a boolean indicating if limit_choices_to</span>\n<span class=\"sd\">    should be applied to a field&#39;s queryset.</span>\n\n<span class=\"sd\">    ``form_declared_fields`` is a dictionary of form fields created directly on</span>\n<span class=\"sd\">    a form.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">form_declared_fields</span> <span class=\"o\">=</span> <span class=\"n\">form_declared_fields</span> <span class=\"ow\">or</span> <span class=\"p\">{}</span>\n    <span class=\"n\">field_dict</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n    <span class=\"n\">ignored</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n    <span class=\"n\">opts</span> <span class=\"o\">=</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span>\n    <span class=\"c1\"># Avoid circular import</span>\n    <span class=\"kn\">from</span> <span class=\"nn\">django.db.models</span> <span class=\"kn\">import</span> <span class=\"n\">Field</span> <span class=\"k\">as</span> <span class=\"n\">ModelField</span>\n\n    <span class=\"n\">sortable_private_fields</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n        <span class=\"n\">f</span> <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">private_fields</span> <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">,</span> <span class=\"n\">ModelField</span><span class=\"p\">)</span>\n    <span class=\"p\">]</span>\n    <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"nb\">sorted</span><span class=\"p\">(</span>\n        <span class=\"n\">chain</span><span class=\"p\">(</span><span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">concrete_fields</span><span class=\"p\">,</span> <span class=\"n\">sortable_private_fields</span><span class=\"p\">,</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">many_to_many</span><span class=\"p\">)</span>\n    <span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">,</span> <span class=\"s2\">&quot;editable&quot;</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"p\">(</span>\n                <span class=\"n\">fields</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n                <span class=\"ow\">and</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span>\n                <span class=\"ow\">and</span> <span class=\"p\">(</span><span class=\"n\">exclude</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">or</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">exclude</span><span class=\"p\">)</span>\n            <span class=\"p\">):</span>\n                <span class=\"k\">raise</span> <span class=\"n\">FieldError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;&#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; cannot be specified for </span><span class=\"si\">%s</span><span class=\"s2\"> model form as it is a &quot;</span>\n                    <span class=\"s2\">&quot;non-editable field&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"vm\">__name__</span><span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">continue</span>\n        <span class=\"k\">if</span> <span class=\"n\">fields</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span><span class=\"p\">:</span>\n            <span class=\"k\">continue</span>\n        <span class=\"k\">if</span> <span class=\"n\">exclude</span> <span class=\"ow\">and</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">exclude</span><span class=\"p\">:</span>\n            <span class=\"k\">continue</span>\n        <span class=\"k\">if</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">form_declared_fields</span><span class=\"p\">:</span>\n            <span class=\"n\">field_dict</span><span class=\"p\">[</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">form_declared_fields</span><span class=\"p\">[</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">]</span>\n            <span class=\"k\">continue</span>\n\n        <span class=\"n\">kwargs</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n        <span class=\"k\">if</span> <span class=\"n\">widgets</span> <span class=\"ow\">and</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">widgets</span><span class=\"p\">:</span>\n            <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;widget&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">widgets</span><span class=\"p\">[</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"n\">localized_fields</span> <span class=\"o\">==</span> <span class=\"n\">ALL_FIELDS</span> <span class=\"ow\">or</span> <span class=\"p\">(</span>\n            <span class=\"n\">localized_fields</span> <span class=\"ow\">and</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">localized_fields</span>\n        <span class=\"p\">):</span>\n            <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;localize&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"k\">if</span> <span class=\"n\">labels</span> <span class=\"ow\">and</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">labels</span><span class=\"p\">:</span>\n            <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;label&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">labels</span><span class=\"p\">[</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"n\">help_texts</span> <span class=\"ow\">and</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">help_texts</span><span class=\"p\">:</span>\n            <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;help_text&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">help_texts</span><span class=\"p\">[</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"n\">error_messages</span> <span class=\"ow\">and</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">error_messages</span><span class=\"p\">:</span>\n            <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;error_messages&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">error_messages</span><span class=\"p\">[</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"n\">field_classes</span> <span class=\"ow\">and</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">field_classes</span><span class=\"p\">:</span>\n            <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;form_class&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">field_classes</span><span class=\"p\">[</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">]</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">formfield_callback</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">formfield</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">formfield</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"ow\">not</span> <span class=\"n\">callable</span><span class=\"p\">(</span><span class=\"n\">formfield_callback</span><span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;formfield_callback must be a function or callable&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">formfield</span> <span class=\"o\">=</span> <span class=\"n\">formfield_callback</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">formfield</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">apply_limit_choices_to</span><span class=\"p\">:</span>\n                <span class=\"n\">apply_limit_choices_to_to_formfield</span><span class=\"p\">(</span><span class=\"n\">formfield</span><span class=\"p\">)</span>\n            <span class=\"n\">field_dict</span><span class=\"p\">[</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">formfield</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">ignored</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">fields</span><span class=\"p\">:</span>\n        <span class=\"n\">field_dict</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"n\">f</span><span class=\"p\">:</span> <span class=\"n\">field_dict</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span>\n            <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"ow\">not</span> <span class=\"n\">exclude</span> <span class=\"ow\">or</span> <span class=\"n\">f</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">exclude</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">f</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">ignored</span>\n        <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"n\">field_dict</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">ModelFormOptions</span><span class=\"p\">:</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">options</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">options</span><span class=\"p\">,</span> <span class=\"s2\">&quot;model&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fields</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">options</span><span class=\"p\">,</span> <span class=\"s2\">&quot;fields&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">exclude</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">options</span><span class=\"p\">,</span> <span class=\"s2\">&quot;exclude&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">widgets</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">options</span><span class=\"p\">,</span> <span class=\"s2\">&quot;widgets&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">localized_fields</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">options</span><span class=\"p\">,</span> <span class=\"s2\">&quot;localized_fields&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">labels</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">options</span><span class=\"p\">,</span> <span class=\"s2\">&quot;labels&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">help_texts</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">options</span><span class=\"p\">,</span> <span class=\"s2\">&quot;help_texts&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">error_messages</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">options</span><span class=\"p\">,</span> <span class=\"s2\">&quot;error_messages&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">field_classes</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">options</span><span class=\"p\">,</span> <span class=\"s2\">&quot;field_classes&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">formfield_callback</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">options</span><span class=\"p\">,</span> <span class=\"s2\">&quot;formfield_callback&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">ModelFormMetaclass</span><span class=\"p\">(</span><span class=\"n\">DeclarativeFieldsMetaclass</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__new__</span><span class=\"p\">(</span><span class=\"n\">mcs</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">bases</span><span class=\"p\">,</span> <span class=\"n\">attrs</span><span class=\"p\">):</span>\n        <span class=\"n\">new_class</span> <span class=\"o\">=</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__new__</span><span class=\"p\">(</span><span class=\"n\">mcs</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">bases</span><span class=\"p\">,</span> <span class=\"n\">attrs</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">bases</span> <span class=\"o\">==</span> <span class=\"p\">(</span><span class=\"n\">BaseModelForm</span><span class=\"p\">,):</span>\n            <span class=\"k\">return</span> <span class=\"n\">new_class</span>\n\n        <span class=\"n\">opts</span> <span class=\"o\">=</span> <span class=\"n\">new_class</span><span class=\"o\">.</span><span class=\"n\">_meta</span> <span class=\"o\">=</span> <span class=\"n\">ModelFormOptions</span><span class=\"p\">(</span><span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">new_class</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Meta&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">))</span>\n\n        <span class=\"c1\"># We check if a string was passed to `fields` or `exclude`,</span>\n        <span class=\"c1\"># which is likely to be a mistake where the user typed (&#39;foo&#39;) instead</span>\n        <span class=\"c1\"># of (&#39;foo&#39;,)</span>\n        <span class=\"k\">for</span> <span class=\"n\">opt</span> <span class=\"ow\">in</span> <span class=\"p\">[</span><span class=\"s2\">&quot;fields&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;exclude&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;localized_fields&quot;</span><span class=\"p\">]:</span>\n            <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">opts</span><span class=\"p\">,</span> <span class=\"n\">opt</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">value</span> <span class=\"o\">!=</span> <span class=\"n\">ALL_FIELDS</span><span class=\"p\">:</span>\n                <span class=\"n\">msg</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;</span><span class=\"si\">%(model)s</span><span class=\"s2\">.Meta.</span><span class=\"si\">%(opt)s</span><span class=\"s2\"> cannot be a string. &quot;</span>\n                    <span class=\"s2\">&quot;Did you mean to type: (&#39;</span><span class=\"si\">%(value)s</span><span class=\"s2\">&#39;,)?&quot;</span>\n                    <span class=\"o\">%</span> <span class=\"p\">{</span>\n                        <span class=\"s2\">&quot;model&quot;</span><span class=\"p\">:</span> <span class=\"n\">new_class</span><span class=\"o\">.</span><span class=\"vm\">__name__</span><span class=\"p\">,</span>\n                        <span class=\"s2\">&quot;opt&quot;</span><span class=\"p\">:</span> <span class=\"n\">opt</span><span class=\"p\">,</span>\n                        <span class=\"s2\">&quot;value&quot;</span><span class=\"p\">:</span> <span class=\"n\">value</span><span class=\"p\">,</span>\n                    <span class=\"p\">}</span>\n                <span class=\"p\">)</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">:</span>\n            <span class=\"c1\"># If a model is defined, extract form fields from it.</span>\n            <span class=\"k\">if</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">fields</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">exclude</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"n\">ImproperlyConfigured</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Creating a ModelForm without either the &#39;fields&#39; attribute &quot;</span>\n                    <span class=\"s2\">&quot;or the &#39;exclude&#39; attribute is prohibited; form </span><span class=\"si\">%s</span><span class=\"s2\"> &quot;</span>\n                    <span class=\"s2\">&quot;needs updating.&quot;</span> <span class=\"o\">%</span> <span class=\"n\">name</span>\n                <span class=\"p\">)</span>\n\n            <span class=\"k\">if</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">fields</span> <span class=\"o\">==</span> <span class=\"n\">ALL_FIELDS</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Sentinel for fields_for_model to indicate &quot;get the list of</span>\n                <span class=\"c1\"># fields from the model&quot;</span>\n                <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">fields</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n\n            <span class=\"n\">fields</span> <span class=\"o\">=</span> <span class=\"n\">fields_for_model</span><span class=\"p\">(</span>\n                <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">,</span>\n                <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">,</span>\n                <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">,</span>\n                <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">widgets</span><span class=\"p\">,</span>\n                <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">formfield_callback</span><span class=\"p\">,</span>\n                <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">localized_fields</span><span class=\"p\">,</span>\n                <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">labels</span><span class=\"p\">,</span>\n                <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">help_texts</span><span class=\"p\">,</span>\n                <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">error_messages</span><span class=\"p\">,</span>\n                <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">field_classes</span><span class=\"p\">,</span>\n                <span class=\"c1\"># limit_choices_to will be applied during ModelForm.__init__().</span>\n                <span class=\"n\">apply_limit_choices_to</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n                <span class=\"n\">form_declared_fields</span><span class=\"o\">=</span><span class=\"n\">new_class</span><span class=\"o\">.</span><span class=\"n\">declared_fields</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n\n            <span class=\"c1\"># make sure opts.fields doesn&#39;t specify an invalid field</span>\n            <span class=\"n\">none_model_fields</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"n\">k</span> <span class=\"k\">for</span> <span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"n\">v</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()</span> <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">v</span><span class=\"p\">}</span>\n            <span class=\"n\">missing_fields</span> <span class=\"o\">=</span> <span class=\"n\">none_model_fields</span><span class=\"o\">.</span><span class=\"n\">difference</span><span class=\"p\">(</span><span class=\"n\">new_class</span><span class=\"o\">.</span><span class=\"n\">declared_fields</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">missing_fields</span><span class=\"p\">:</span>\n                <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;Unknown field(s) (</span><span class=\"si\">%s</span><span class=\"s2\">) specified for </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span>\n                <span class=\"n\">message</span> <span class=\"o\">%=</span> <span class=\"p\">(</span><span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">missing_fields</span><span class=\"p\">),</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"vm\">__name__</span><span class=\"p\">)</span>\n                <span class=\"k\">raise</span> <span class=\"n\">FieldError</span><span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">)</span>\n            <span class=\"c1\"># Include all the other declared fields.</span>\n            <span class=\"n\">fields</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">new_class</span><span class=\"o\">.</span><span class=\"n\">declared_fields</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">fields</span> <span class=\"o\">=</span> <span class=\"n\">new_class</span><span class=\"o\">.</span><span class=\"n\">declared_fields</span>\n\n        <span class=\"n\">new_class</span><span class=\"o\">.</span><span class=\"n\">base_fields</span> <span class=\"o\">=</span> <span class=\"n\">fields</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">new_class</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">BaseModelForm</span><span class=\"p\">(</span><span class=\"n\">BaseForm</span><span class=\"p\">,</span> <span class=\"n\">AltersData</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">data</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">files</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">auto_id</span><span class=\"o\">=</span><span class=\"s2\">&quot;id_</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span>\n        <span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">initial</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">error_class</span><span class=\"o\">=</span><span class=\"n\">ErrorList</span><span class=\"p\">,</span>\n        <span class=\"n\">label_suffix</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">empty_permitted</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">use_required_attribute</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">renderer</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"n\">opts</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_meta</span>\n        <span class=\"k\">if</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">model</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;ModelForm has no model class specified.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">instance</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"c1\"># if we didn&#39;t get an instance, instantiate a new one</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span> <span class=\"o\">=</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">()</span>\n            <span class=\"n\">object_data</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span> <span class=\"o\">=</span> <span class=\"n\">instance</span>\n            <span class=\"n\">object_data</span> <span class=\"o\">=</span> <span class=\"n\">model_to_dict</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">,</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">)</span>\n        <span class=\"c1\"># if initial was provided, it should override the values from instance</span>\n        <span class=\"k\">if</span> <span class=\"n\">initial</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">object_data</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">initial</span><span class=\"p\">)</span>\n        <span class=\"c1\"># self._validate_unique will be set to True by BaseModelForm.clean().</span>\n        <span class=\"c1\"># It is False by default so overriding self.clean() and failing to call</span>\n        <span class=\"c1\"># super will stop validate_unique from being called.</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_validate_unique</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span>\n            <span class=\"n\">data</span><span class=\"p\">,</span>\n            <span class=\"n\">files</span><span class=\"p\">,</span>\n            <span class=\"n\">auto_id</span><span class=\"p\">,</span>\n            <span class=\"n\">prefix</span><span class=\"p\">,</span>\n            <span class=\"n\">object_data</span><span class=\"p\">,</span>\n            <span class=\"n\">error_class</span><span class=\"p\">,</span>\n            <span class=\"n\">label_suffix</span><span class=\"p\">,</span>\n            <span class=\"n\">empty_permitted</span><span class=\"p\">,</span>\n            <span class=\"n\">use_required_attribute</span><span class=\"o\">=</span><span class=\"n\">use_required_attribute</span><span class=\"p\">,</span>\n            <span class=\"n\">renderer</span><span class=\"o\">=</span><span class=\"n\">renderer</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">formfield</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">():</span>\n            <span class=\"n\">apply_limit_choices_to_to_formfield</span><span class=\"p\">(</span><span class=\"n\">formfield</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_get_validation_exclusions</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        For backwards-compatibility, exclude several types of fields from model</span>\n<span class=\"sd\">        validation. See tickets #12507, #12521, #12553.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">exclude</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">()</span>\n        <span class=\"c1\"># Build up a list of fields that should be excluded from model field</span>\n        <span class=\"c1\"># validation and unique checks.</span>\n        <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">:</span>\n            <span class=\"n\">field</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span>\n            <span class=\"c1\"># Exclude fields that aren&#39;t on the form. The developer may be</span>\n            <span class=\"c1\"># adding these values to the model after form validation.</span>\n            <span class=\"k\">if</span> <span class=\"n\">field</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">:</span>\n                <span class=\"n\">exclude</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n\n            <span class=\"c1\"># Don&#39;t perform model validation on fields that were defined</span>\n            <span class=\"c1\"># manually on the form and excluded via the ModelForm&#39;s Meta</span>\n            <span class=\"c1\"># class. See #12901.</span>\n            <span class=\"k\">elif</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">fields</span> <span class=\"ow\">and</span> <span class=\"n\">field</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">:</span>\n                <span class=\"n\">exclude</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n            <span class=\"k\">elif</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">exclude</span> <span class=\"ow\">and</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">exclude</span><span class=\"p\">:</span>\n                <span class=\"n\">exclude</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n\n            <span class=\"c1\"># Exclude fields that failed form validation. There&#39;s no need for</span>\n            <span class=\"c1\"># the model fields to validate them as well.</span>\n            <span class=\"k\">elif</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_errors</span><span class=\"p\">:</span>\n                <span class=\"n\">exclude</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n\n            <span class=\"c1\"># Exclude empty fields that are not required by the form, if the</span>\n            <span class=\"c1\"># underlying model field is required. This keeps the model field</span>\n            <span class=\"c1\"># from raising a required error. Note: don&#39;t exclude the field from</span>\n            <span class=\"c1\"># validation if the model field allows blanks. If it does, the blank</span>\n            <span class=\"c1\"># value may be included in a unique check, so cannot be excluded</span>\n            <span class=\"c1\"># from validation.</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">form_field</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">[</span><span class=\"n\">field</span><span class=\"p\">]</span>\n                <span class=\"n\">field_value</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"p\">(</span>\n                    <span class=\"ow\">not</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">blank</span>\n                    <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">form_field</span><span class=\"o\">.</span><span class=\"n\">required</span>\n                    <span class=\"ow\">and</span> <span class=\"n\">field_value</span> <span class=\"ow\">in</span> <span class=\"n\">form_field</span><span class=\"o\">.</span><span class=\"n\">empty_values</span>\n                <span class=\"p\">):</span>\n                    <span class=\"n\">exclude</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">exclude</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">clean</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_validate_unique</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_update_errors</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">errors</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Override any validation error messages defined at the model level</span>\n        <span class=\"c1\"># with those defined at the form level.</span>\n        <span class=\"n\">opts</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_meta</span>\n\n        <span class=\"c1\"># Allow the model generated by construct_instance() to raise</span>\n        <span class=\"c1\"># ValidationError and have them handled in the same way as others.</span>\n        <span class=\"k\">if</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">errors</span><span class=\"p\">,</span> <span class=\"s2\">&quot;error_dict&quot;</span><span class=\"p\">):</span>\n            <span class=\"n\">error_dict</span> <span class=\"o\">=</span> <span class=\"n\">errors</span><span class=\"o\">.</span><span class=\"n\">error_dict</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">error_dict</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"n\">NON_FIELD_ERRORS</span><span class=\"p\">:</span> <span class=\"n\">errors</span><span class=\"p\">}</span>\n\n        <span class=\"k\">for</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">messages</span> <span class=\"ow\">in</span> <span class=\"n\">error_dict</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n            <span class=\"k\">if</span> <span class=\"p\">(</span>\n                <span class=\"n\">field</span> <span class=\"o\">==</span> <span class=\"n\">NON_FIELD_ERRORS</span>\n                <span class=\"ow\">and</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">error_messages</span>\n                <span class=\"ow\">and</span> <span class=\"n\">NON_FIELD_ERRORS</span> <span class=\"ow\">in</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">error_messages</span>\n            <span class=\"p\">):</span>\n                <span class=\"n\">error_messages</span> <span class=\"o\">=</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">error_messages</span><span class=\"p\">[</span><span class=\"n\">NON_FIELD_ERRORS</span><span class=\"p\">]</span>\n            <span class=\"k\">elif</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">:</span>\n                <span class=\"n\">error_messages</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">[</span><span class=\"n\">field</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">error_messages</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"k\">continue</span>\n\n            <span class=\"k\">for</span> <span class=\"n\">message</span> <span class=\"ow\">in</span> <span class=\"n\">messages</span><span class=\"p\">:</span>\n                <span class=\"k\">if</span> <span class=\"p\">(</span>\n                    <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"n\">ValidationError</span><span class=\"p\">)</span>\n                    <span class=\"ow\">and</span> <span class=\"n\">message</span><span class=\"o\">.</span><span class=\"n\">code</span> <span class=\"ow\">in</span> <span class=\"n\">error_messages</span>\n                <span class=\"p\">):</span>\n                    <span class=\"n\">message</span><span class=\"o\">.</span><span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"n\">error_messages</span><span class=\"p\">[</span><span class=\"n\">message</span><span class=\"o\">.</span><span class=\"n\">code</span><span class=\"p\">]</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">add_error</span><span class=\"p\">(</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">errors</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_post_clean</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">opts</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_meta</span>\n\n        <span class=\"n\">exclude</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_validation_exclusions</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># Foreign Keys being used to represent inline relationships</span>\n        <span class=\"c1\"># are excluded from basic field value validation. This is for two</span>\n        <span class=\"c1\"># reasons: firstly, the value may not be supplied (#12507; the</span>\n        <span class=\"c1\"># case of providing new values to the admin); secondly the</span>\n        <span class=\"c1\"># object being referred to may not yet fully exist (#12749).</span>\n        <span class=\"c1\"># However, these fields *must* be included in uniqueness checks,</span>\n        <span class=\"c1\"># so this can&#39;t be part of _get_validation_exclusions().</span>\n        <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">InlineForeignKeyField</span><span class=\"p\">):</span>\n                <span class=\"n\">exclude</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span> <span class=\"o\">=</span> <span class=\"n\">construct_instance</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">,</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">exclude</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"n\">ValidationError</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_update_errors</span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"p\">)</span>\n\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">full_clean</span><span class=\"p\">(</span><span class=\"n\">exclude</span><span class=\"o\">=</span><span class=\"n\">exclude</span><span class=\"p\">,</span> <span class=\"n\">validate_unique</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"n\">ValidationError</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_update_errors</span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Validate uniqueness if needed.</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_validate_unique</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">validate_unique</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">validate_unique</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Call the instance&#39;s validate_unique() method and update the form&#39;s</span>\n<span class=\"sd\">        validation errors if any were raised.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">exclude</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_validation_exclusions</span><span class=\"p\">()</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">validate_unique</span><span class=\"p\">(</span><span class=\"n\">exclude</span><span class=\"o\">=</span><span class=\"n\">exclude</span><span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"n\">ValidationError</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_update_errors</span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_save_m2m</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Save the many-to-many fields and generic relations for this form.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">cleaned_data</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span>\n        <span class=\"n\">exclude</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">exclude</span>\n        <span class=\"n\">fields</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">fields</span>\n        <span class=\"n\">opts</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">_meta</span>\n        <span class=\"c1\"># Note that for historical reasons we want to include also</span>\n        <span class=\"c1\"># private_fields here. (GenericRelation was previously a fake</span>\n        <span class=\"c1\"># m2m field).</span>\n        <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">chain</span><span class=\"p\">(</span><span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">many_to_many</span><span class=\"p\">,</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">private_fields</span><span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">,</span> <span class=\"s2\">&quot;save_form_data&quot;</span><span class=\"p\">):</span>\n                <span class=\"k\">continue</span>\n            <span class=\"k\">if</span> <span class=\"n\">fields</span> <span class=\"ow\">and</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span><span class=\"p\">:</span>\n                <span class=\"k\">continue</span>\n            <span class=\"k\">if</span> <span class=\"n\">exclude</span> <span class=\"ow\">and</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">exclude</span><span class=\"p\">:</span>\n                <span class=\"k\">continue</span>\n            <span class=\"k\">if</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">cleaned_data</span><span class=\"p\">:</span>\n                <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">save_form_data</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">])</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">save</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Save this form&#39;s self.instance object if commit=True. Otherwise, add</span>\n<span class=\"sd\">        a save_m2m() method to the form which can be called after the instance</span>\n<span class=\"sd\">        is saved manually at a later time. Return the model instance.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">errors</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;The </span><span class=\"si\">%s</span><span class=\"s2\"> could not be </span><span class=\"si\">%s</span><span class=\"s2\"> because the data didn&#39;t validate.&quot;</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">object_name</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;created&quot;</span> <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">_state</span><span class=\"o\">.</span><span class=\"n\">adding</span> <span class=\"k\">else</span> <span class=\"s2\">&quot;changed&quot;</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"p\">:</span>\n            <span class=\"c1\"># If committing, save the instance and the m2m data immediately.</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">()</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_save_m2m</span><span class=\"p\">()</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"c1\"># If not committing, add a method to the form to allow deferred</span>\n            <span class=\"c1\"># saving of m2m data.</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">save_m2m</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_save_m2m</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span>\n\n    <span class=\"n\">save</span><span class=\"o\">.</span><span class=\"n\">alters_data</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n\n<div class=\"viewcode-block\" id=\"ModelForm\"><a class=\"viewcode-back\" href=\"../../../../topics/forms/modelforms/#django.forms.ModelForm\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">ModelForm</span><span class=\"p\">(</span><span class=\"n\">BaseModelForm</span><span class=\"p\">,</span> <span class=\"n\">metaclass</span><span class=\"o\">=</span><span class=\"n\">ModelFormMetaclass</span><span class=\"p\">):</span>\n    <span class=\"k\">pass</span></div>\n\n\n<div class=\"viewcode-block\" id=\"modelform_factory\"><a class=\"viewcode-back\" href=\"../../../../ref/forms/models/#django.forms.modelform_factory\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">modelform_factory</span><span class=\"p\">(</span>\n    <span class=\"n\">model</span><span class=\"p\">,</span>\n    <span class=\"n\">form</span><span class=\"o\">=</span><span class=\"n\">ModelForm</span><span class=\"p\">,</span>\n    <span class=\"n\">fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">exclude</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">formfield_callback</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">widgets</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">localized_fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">labels</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">help_texts</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">error_messages</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">field_classes</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n<span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Return a ModelForm containing form fields for the given model. You can</span>\n<span class=\"sd\">    optionally pass a `form` argument to use as a starting point for</span>\n<span class=\"sd\">    constructing the ModelForm.</span>\n\n<span class=\"sd\">    ``fields`` is an optional list of field names. If provided, include only</span>\n<span class=\"sd\">    the named fields in the returned fields. If omitted or &#39;__all__&#39;, use all</span>\n<span class=\"sd\">    fields.</span>\n\n<span class=\"sd\">    ``exclude`` is an optional list of field names. If provided, exclude the</span>\n<span class=\"sd\">    named fields from the returned fields, even if they are listed in the</span>\n<span class=\"sd\">    ``fields`` argument.</span>\n\n<span class=\"sd\">    ``widgets`` is a dictionary of model field names mapped to a widget.</span>\n\n<span class=\"sd\">    ``localized_fields`` is a list of names of fields which should be localized.</span>\n\n<span class=\"sd\">    ``formfield_callback`` is a callable that takes a model field and returns</span>\n<span class=\"sd\">    a form field.</span>\n\n<span class=\"sd\">    ``labels`` is a dictionary of model field names mapped to a label.</span>\n\n<span class=\"sd\">    ``help_texts`` is a dictionary of model field names mapped to a help text.</span>\n\n<span class=\"sd\">    ``error_messages`` is a dictionary of model field names mapped to a</span>\n<span class=\"sd\">    dictionary of error messages.</span>\n\n<span class=\"sd\">    ``field_classes`` is a dictionary of model field names mapped to a form</span>\n<span class=\"sd\">    field class.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"c1\"># Create the inner Meta class. FIXME: ideally, we should be able to</span>\n    <span class=\"c1\"># construct a ModelForm without creating and passing in a temporary</span>\n    <span class=\"c1\"># inner class.</span>\n\n    <span class=\"c1\"># Build up a list of attributes that the Meta object will have.</span>\n    <span class=\"n\">attrs</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s2\">&quot;model&quot;</span><span class=\"p\">:</span> <span class=\"n\">model</span><span class=\"p\">}</span>\n    <span class=\"k\">if</span> <span class=\"n\">fields</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">attrs</span><span class=\"p\">[</span><span class=\"s2\">&quot;fields&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">fields</span>\n    <span class=\"k\">if</span> <span class=\"n\">exclude</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">attrs</span><span class=\"p\">[</span><span class=\"s2\">&quot;exclude&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">exclude</span>\n    <span class=\"k\">if</span> <span class=\"n\">widgets</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">attrs</span><span class=\"p\">[</span><span class=\"s2\">&quot;widgets&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">widgets</span>\n    <span class=\"k\">if</span> <span class=\"n\">localized_fields</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">attrs</span><span class=\"p\">[</span><span class=\"s2\">&quot;localized_fields&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">localized_fields</span>\n    <span class=\"k\">if</span> <span class=\"n\">labels</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">attrs</span><span class=\"p\">[</span><span class=\"s2\">&quot;labels&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">labels</span>\n    <span class=\"k\">if</span> <span class=\"n\">help_texts</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">attrs</span><span class=\"p\">[</span><span class=\"s2\">&quot;help_texts&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">help_texts</span>\n    <span class=\"k\">if</span> <span class=\"n\">error_messages</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">attrs</span><span class=\"p\">[</span><span class=\"s2\">&quot;error_messages&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">error_messages</span>\n    <span class=\"k\">if</span> <span class=\"n\">field_classes</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">attrs</span><span class=\"p\">[</span><span class=\"s2\">&quot;field_classes&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">field_classes</span>\n\n    <span class=\"c1\"># If parent form class already has an inner Meta, the Meta we&#39;re</span>\n    <span class=\"c1\"># creating needs to inherit from the parent&#39;s inner meta.</span>\n    <span class=\"n\">bases</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">Meta</span><span class=\"p\">,)</span> <span class=\"k\">if</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Meta&quot;</span><span class=\"p\">)</span> <span class=\"k\">else</span> <span class=\"p\">()</span>\n    <span class=\"n\">Meta</span> <span class=\"o\">=</span> <span class=\"nb\">type</span><span class=\"p\">(</span><span class=\"s2\">&quot;Meta&quot;</span><span class=\"p\">,</span> <span class=\"n\">bases</span><span class=\"p\">,</span> <span class=\"n\">attrs</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">formfield_callback</span><span class=\"p\">:</span>\n        <span class=\"n\">Meta</span><span class=\"o\">.</span><span class=\"n\">formfield_callback</span> <span class=\"o\">=</span> <span class=\"nb\">staticmethod</span><span class=\"p\">(</span><span class=\"n\">formfield_callback</span><span class=\"p\">)</span>\n    <span class=\"c1\"># Give this new form class a reasonable name.</span>\n    <span class=\"n\">class_name</span> <span class=\"o\">=</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"vm\">__name__</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;Form&quot;</span>\n\n    <span class=\"c1\"># Class attributes for the new form class.</span>\n    <span class=\"n\">form_class_attrs</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s2\">&quot;Meta&quot;</span><span class=\"p\">:</span> <span class=\"n\">Meta</span><span class=\"p\">}</span>\n\n    <span class=\"k\">if</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">Meta</span><span class=\"p\">,</span> <span class=\"s2\">&quot;fields&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">Meta</span><span class=\"p\">,</span> <span class=\"s2\">&quot;exclude&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"k\">raise</span> <span class=\"n\">ImproperlyConfigured</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;Calling modelform_factory without defining &#39;fields&#39; or &quot;</span>\n            <span class=\"s2\">&quot;&#39;exclude&#39; explicitly is prohibited.&quot;</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"c1\"># Instantiate type(form) in order to use the same metaclass as form.</span>\n    <span class=\"k\">return</span> <span class=\"nb\">type</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"p\">)(</span><span class=\"n\">class_name</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"n\">form</span><span class=\"p\">,),</span> <span class=\"n\">form_class_attrs</span><span class=\"p\">)</span></div>\n\n\n<span class=\"c1\"># ModelFormSets ##############################################################</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">BaseModelFormSet</span><span class=\"p\">(</span><span class=\"n\">BaseFormSet</span><span class=\"p\">,</span> <span class=\"n\">AltersData</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    A ``FormSet`` for editing a queryset and/or adding new objects to it.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"n\">model</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"n\">edit_only</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n\n    <span class=\"c1\"># Set of fields that must be unique among forms of this set.</span>\n    <span class=\"n\">unique_fields</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">data</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">files</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">auto_id</span><span class=\"o\">=</span><span class=\"s2\">&quot;id_</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span>\n        <span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">queryset</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"o\">*</span><span class=\"p\">,</span>\n        <span class=\"n\">initial</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"n\">queryset</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">initial_extra</span> <span class=\"o\">=</span> <span class=\"n\">initial</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span>\n            <span class=\"o\">**</span><span class=\"p\">{</span>\n                <span class=\"s2\">&quot;data&quot;</span><span class=\"p\">:</span> <span class=\"n\">data</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;files&quot;</span><span class=\"p\">:</span> <span class=\"n\">files</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;auto_id&quot;</span><span class=\"p\">:</span> <span class=\"n\">auto_id</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;prefix&quot;</span><span class=\"p\">:</span> <span class=\"n\">prefix</span><span class=\"p\">,</span>\n                <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">,</span>\n            <span class=\"p\">}</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">initial_form_count</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Return the number of forms that are required in this FormSet.&quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">is_bound</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_queryset</span><span class=\"p\">())</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">initial_form_count</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_existing_object</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">pk</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_object_dict&quot;</span><span class=\"p\">):</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_object_dict</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"n\">o</span><span class=\"o\">.</span><span class=\"n\">pk</span><span class=\"p\">:</span> <span class=\"n\">o</span> <span class=\"k\">for</span> <span class=\"n\">o</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_queryset</span><span class=\"p\">()}</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_object_dict</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_get_to_python</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        If the field is a related field, fetch the concrete field&#39;s (that</span>\n<span class=\"sd\">        is, the ultimate pointed-to field&#39;s) to_python.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">while</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">field</span> <span class=\"o\">=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">get_related_field</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">to_python</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_construct_form</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"n\">pk_required</span> <span class=\"o\">=</span> <span class=\"n\">i</span> <span class=\"o\">&lt;</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">initial_form_count</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">pk_required</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">is_bound</span><span class=\"p\">:</span>\n                <span class=\"n\">pk_key</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\">-</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">add_prefix</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">),</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">pk</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n                <span class=\"k\">try</span><span class=\"p\">:</span>\n                    <span class=\"n\">pk</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"p\">[</span><span class=\"n\">pk_key</span><span class=\"p\">]</span>\n                <span class=\"k\">except</span> <span class=\"ne\">KeyError</span><span class=\"p\">:</span>\n                    <span class=\"c1\"># The primary key is missing. The user may have tampered</span>\n                    <span class=\"c1\"># with POST data.</span>\n                    <span class=\"k\">pass</span>\n                <span class=\"k\">else</span><span class=\"p\">:</span>\n                    <span class=\"n\">to_python</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_to_python</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">pk</span><span class=\"p\">)</span>\n                    <span class=\"k\">try</span><span class=\"p\">:</span>\n                        <span class=\"n\">pk</span> <span class=\"o\">=</span> <span class=\"n\">to_python</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"p\">)</span>\n                    <span class=\"k\">except</span> <span class=\"n\">ValidationError</span><span class=\"p\">:</span>\n                        <span class=\"c1\"># The primary key exists but is an invalid value. The</span>\n                        <span class=\"c1\"># user may have tampered with POST data.</span>\n                        <span class=\"k\">pass</span>\n                    <span class=\"k\">else</span><span class=\"p\">:</span>\n                        <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;instance&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_existing_object</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;instance&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_queryset</span><span class=\"p\">()[</span><span class=\"n\">i</span><span class=\"p\">]</span>\n        <span class=\"k\">elif</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">initial_extra</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Set initial values for extra forms</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;initial&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">initial_extra</span><span class=\"p\">[</span><span class=\"n\">i</span> <span class=\"o\">-</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">initial_form_count</span><span class=\"p\">()]</span>\n            <span class=\"k\">except</span> <span class=\"ne\">IndexError</span><span class=\"p\">:</span>\n                <span class=\"k\">pass</span>\n        <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">_construct_form</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">pk_required</span><span class=\"p\">:</span>\n            <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">pk</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"k\">return</span> <span class=\"n\">form</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_queryset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_queryset&quot;</span><span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_default_manager</span><span class=\"o\">.</span><span class=\"n\">get_queryset</span><span class=\"p\">()</span>\n\n            <span class=\"c1\"># If the queryset isn&#39;t already ordered we need to add an</span>\n            <span class=\"c1\"># artificial ordering here to make sure that all formsets</span>\n            <span class=\"c1\"># constructed from this queryset have the same form order.</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">qs</span><span class=\"o\">.</span><span class=\"n\">ordered</span><span class=\"p\">:</span>\n                <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"n\">qs</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">pk</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n\n            <span class=\"c1\"># Removed queryset limiting here. As per discussion re: #13023</span>\n            <span class=\"c1\"># on django-dev, max_num should not prevent existing</span>\n            <span class=\"c1\"># related objects/inlines from being displayed.</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_queryset</span> <span class=\"o\">=</span> <span class=\"n\">qs</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_queryset</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">save_new</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">form</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Save and return a new model instance for the given form.&quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">save_existing</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">form</span><span class=\"p\">,</span> <span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Save and return an existing model instance for the given form.&quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">delete_existing</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Deletes an existing model instance.&quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"p\">:</span>\n            <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">save</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Save model instances for every form, adding and changing instances</span>\n<span class=\"sd\">        as necessary, and return the list of instances.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">commit</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">saved_forms</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n\n            <span class=\"k\">def</span> <span class=\"nf\">save_m2m</span><span class=\"p\">():</span>\n                <span class=\"k\">for</span> <span class=\"n\">form</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">saved_forms</span><span class=\"p\">:</span>\n                    <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">save_m2m</span><span class=\"p\">()</span>\n\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">save_m2m</span> <span class=\"o\">=</span> <span class=\"n\">save_m2m</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">edit_only</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">save_existing_objects</span><span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">save_existing_objects</span><span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">save_new_objects</span><span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n\n    <span class=\"n\">save</span><span class=\"o\">.</span><span class=\"n\">alters_data</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">clean</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">validate_unique</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">validate_unique</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Collect unique_checks and date_checks to run from all the forms.</span>\n        <span class=\"n\">all_unique_checks</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">()</span>\n        <span class=\"n\">all_date_checks</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">()</span>\n        <span class=\"n\">forms_to_delete</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deleted_forms</span>\n        <span class=\"n\">valid_forms</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n            <span class=\"n\">form</span>\n            <span class=\"k\">for</span> <span class=\"n\">form</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">forms</span>\n            <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_valid</span><span class=\"p\">()</span> <span class=\"ow\">and</span> <span class=\"n\">form</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">forms_to_delete</span>\n        <span class=\"p\">]</span>\n        <span class=\"k\">for</span> <span class=\"n\">form</span> <span class=\"ow\">in</span> <span class=\"n\">valid_forms</span><span class=\"p\">:</span>\n            <span class=\"n\">exclude</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">_get_validation_exclusions</span><span class=\"p\">()</span>\n            <span class=\"n\">unique_checks</span><span class=\"p\">,</span> <span class=\"n\">date_checks</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">_get_unique_checks</span><span class=\"p\">(</span>\n                <span class=\"n\">exclude</span><span class=\"o\">=</span><span class=\"n\">exclude</span><span class=\"p\">,</span>\n                <span class=\"n\">include_meta_constraints</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">all_unique_checks</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">unique_checks</span><span class=\"p\">)</span>\n            <span class=\"n\">all_date_checks</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">date_checks</span><span class=\"p\">)</span>\n\n        <span class=\"n\">errors</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"c1\"># Do each of the unique checks (unique and unique_together)</span>\n        <span class=\"k\">for</span> <span class=\"n\">uclass</span><span class=\"p\">,</span> <span class=\"n\">unique_check</span> <span class=\"ow\">in</span> <span class=\"n\">all_unique_checks</span><span class=\"p\">:</span>\n            <span class=\"n\">seen_data</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">()</span>\n            <span class=\"k\">for</span> <span class=\"n\">form</span> <span class=\"ow\">in</span> <span class=\"n\">valid_forms</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Get the data for the set of fields that must be unique among</span>\n                <span class=\"c1\"># the forms.</span>\n                <span class=\"n\">row_data</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n                    <span class=\"n\">field</span> <span class=\"k\">if</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">unique_fields</span> <span class=\"k\">else</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"n\">field</span><span class=\"p\">]</span>\n                    <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">unique_check</span>\n                    <span class=\"k\">if</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span>\n                <span class=\"p\">)</span>\n                <span class=\"c1\"># Reduce Model instances to their primary key values</span>\n                <span class=\"n\">row_data</span> <span class=\"o\">=</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span>\n                    <span class=\"n\">d</span><span class=\"o\">.</span><span class=\"n\">_get_pk_val</span><span class=\"p\">()</span> <span class=\"k\">if</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">d</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_get_pk_val&quot;</span><span class=\"p\">)</span>\n                    <span class=\"c1\"># Prevent &quot;unhashable type: list&quot; errors later on.</span>\n                    <span class=\"k\">else</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">d</span><span class=\"p\">)</span> <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">d</span><span class=\"p\">,</span> <span class=\"nb\">list</span><span class=\"p\">)</span> <span class=\"k\">else</span> <span class=\"n\">d</span>\n                    <span class=\"k\">for</span> <span class=\"n\">d</span> <span class=\"ow\">in</span> <span class=\"n\">row_data</span>\n                <span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"n\">row_data</span> <span class=\"ow\">and</span> <span class=\"kc\">None</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">row_data</span><span class=\"p\">:</span>\n                    <span class=\"c1\"># if we&#39;ve already seen it then we have a uniqueness failure</span>\n                    <span class=\"k\">if</span> <span class=\"n\">row_data</span> <span class=\"ow\">in</span> <span class=\"n\">seen_data</span><span class=\"p\">:</span>\n                        <span class=\"c1\"># poke error messages into the right places and mark</span>\n                        <span class=\"c1\"># the form as invalid</span>\n                        <span class=\"n\">errors</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_unique_error_message</span><span class=\"p\">(</span><span class=\"n\">unique_check</span><span class=\"p\">))</span>\n                        <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">_errors</span><span class=\"p\">[</span><span class=\"n\">NON_FIELD_ERRORS</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">error_class</span><span class=\"p\">(</span>\n                            <span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_form_error</span><span class=\"p\">()],</span>\n                            <span class=\"n\">renderer</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">renderer</span><span class=\"p\">,</span>\n                        <span class=\"p\">)</span>\n                        <span class=\"c1\"># Remove the data from the cleaned_data dict since it</span>\n                        <span class=\"c1\"># was invalid.</span>\n                        <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">unique_check</span><span class=\"p\">:</span>\n                            <span class=\"k\">if</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">:</span>\n                                <span class=\"k\">del</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"n\">field</span><span class=\"p\">]</span>\n                    <span class=\"c1\"># mark the data as seen</span>\n                    <span class=\"n\">seen_data</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">row_data</span><span class=\"p\">)</span>\n        <span class=\"c1\"># iterate over each of the date checks now</span>\n        <span class=\"k\">for</span> <span class=\"n\">date_check</span> <span class=\"ow\">in</span> <span class=\"n\">all_date_checks</span><span class=\"p\">:</span>\n            <span class=\"n\">seen_data</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">()</span>\n            <span class=\"n\">uclass</span><span class=\"p\">,</span> <span class=\"n\">lookup</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">unique_for</span> <span class=\"o\">=</span> <span class=\"n\">date_check</span>\n            <span class=\"k\">for</span> <span class=\"n\">form</span> <span class=\"ow\">in</span> <span class=\"n\">valid_forms</span><span class=\"p\">:</span>\n                <span class=\"c1\"># see if we have data for both fields</span>\n                <span class=\"k\">if</span> <span class=\"p\">(</span>\n                    <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span>\n                    <span class=\"ow\">and</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"n\">field</span><span class=\"p\">]</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n                    <span class=\"ow\">and</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"n\">unique_for</span><span class=\"p\">]</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n                <span class=\"p\">):</span>\n                    <span class=\"c1\"># if it&#39;s a date lookup we need to get the data for all the fields</span>\n                    <span class=\"k\">if</span> <span class=\"n\">lookup</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;date&quot;</span><span class=\"p\">:</span>\n                        <span class=\"n\">date</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"n\">unique_for</span><span class=\"p\">]</span>\n                        <span class=\"n\">date_data</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">date</span><span class=\"o\">.</span><span class=\"n\">year</span><span class=\"p\">,</span> <span class=\"n\">date</span><span class=\"o\">.</span><span class=\"n\">month</span><span class=\"p\">,</span> <span class=\"n\">date</span><span class=\"o\">.</span><span class=\"n\">day</span><span class=\"p\">)</span>\n                    <span class=\"c1\"># otherwise it&#39;s just the attribute on the date/datetime</span>\n                    <span class=\"c1\"># object</span>\n                    <span class=\"k\">else</span><span class=\"p\">:</span>\n                        <span class=\"n\">date_data</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"n\">unique_for</span><span class=\"p\">],</span> <span class=\"n\">lookup</span><span class=\"p\">),)</span>\n                    <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"n\">field</span><span class=\"p\">],)</span> <span class=\"o\">+</span> <span class=\"n\">date_data</span>\n                    <span class=\"c1\"># if we&#39;ve already seen it then we have a uniqueness failure</span>\n                    <span class=\"k\">if</span> <span class=\"n\">data</span> <span class=\"ow\">in</span> <span class=\"n\">seen_data</span><span class=\"p\">:</span>\n                        <span class=\"c1\"># poke error messages into the right places and mark</span>\n                        <span class=\"c1\"># the form as invalid</span>\n                        <span class=\"n\">errors</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_date_error_message</span><span class=\"p\">(</span><span class=\"n\">date_check</span><span class=\"p\">))</span>\n                        <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">_errors</span><span class=\"p\">[</span><span class=\"n\">NON_FIELD_ERRORS</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">error_class</span><span class=\"p\">(</span>\n                            <span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_form_error</span><span class=\"p\">()],</span>\n                            <span class=\"n\">renderer</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">renderer</span><span class=\"p\">,</span>\n                        <span class=\"p\">)</span>\n                        <span class=\"c1\"># Remove the data from the cleaned_data dict since it</span>\n                        <span class=\"c1\"># was invalid.</span>\n                        <span class=\"k\">del</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">cleaned_data</span><span class=\"p\">[</span><span class=\"n\">field</span><span class=\"p\">]</span>\n                    <span class=\"c1\"># mark the data as seen</span>\n                    <span class=\"n\">seen_data</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">errors</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"n\">ValidationError</span><span class=\"p\">(</span><span class=\"n\">errors</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_unique_error_message</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">unique_check</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">unique_check</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">gettext</span><span class=\"p\">(</span><span class=\"s2\">&quot;Please correct the duplicate data for </span><span class=\"si\">%(field)s</span><span class=\"s2\">.&quot;</span><span class=\"p\">)</span> <span class=\"o\">%</span> <span class=\"p\">{</span>\n                <span class=\"s2\">&quot;field&quot;</span><span class=\"p\">:</span> <span class=\"n\">unique_check</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">],</span>\n            <span class=\"p\">}</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">gettext</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Please correct the duplicate data for </span><span class=\"si\">%(field)s</span><span class=\"s2\">, which must be unique.&quot;</span>\n            <span class=\"p\">)</span> <span class=\"o\">%</span> <span class=\"p\">{</span>\n                <span class=\"s2\">&quot;field&quot;</span><span class=\"p\">:</span> <span class=\"n\">get_text_list</span><span class=\"p\">(</span><span class=\"n\">unique_check</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">(</span><span class=\"s2\">&quot;and&quot;</span><span class=\"p\">)),</span>\n            <span class=\"p\">}</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_date_error_message</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">date_check</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">gettext</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;Please correct the duplicate data for </span><span class=\"si\">%(field_name)s</span><span class=\"s2\"> &quot;</span>\n            <span class=\"s2\">&quot;which must be unique for the </span><span class=\"si\">%(lookup)s</span><span class=\"s2\"> in </span><span class=\"si\">%(date_field)s</span><span class=\"s2\">.&quot;</span>\n        <span class=\"p\">)</span> <span class=\"o\">%</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;field_name&quot;</span><span class=\"p\">:</span> <span class=\"n\">date_check</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">],</span>\n            <span class=\"s2\">&quot;date_field&quot;</span><span class=\"p\">:</span> <span class=\"n\">date_check</span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">],</span>\n            <span class=\"s2\">&quot;lookup&quot;</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">date_check</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]),</span>\n        <span class=\"p\">}</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_form_error</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">gettext</span><span class=\"p\">(</span><span class=\"s2\">&quot;Please correct the duplicate values below.&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">save_existing_objects</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">changed_objects</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deleted_objects</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">initial_forms</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"p\">[]</span>\n\n        <span class=\"n\">saved_instances</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"n\">forms_to_delete</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deleted_forms</span>\n        <span class=\"k\">for</span> <span class=\"n\">form</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">initial_forms</span><span class=\"p\">:</span>\n            <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">instance</span>\n            <span class=\"c1\"># If the pk is None, it means either:</span>\n            <span class=\"c1\"># 1. The object is an unexpected empty model, created by invalid</span>\n            <span class=\"c1\">#    POST data such as an object outside the formset&#39;s queryset.</span>\n            <span class=\"c1\"># 2. The object was already deleted from the database.</span>\n            <span class=\"k\">if</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">pk</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"k\">continue</span>\n            <span class=\"k\">if</span> <span class=\"n\">form</span> <span class=\"ow\">in</span> <span class=\"n\">forms_to_delete</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">deleted_objects</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">delete_existing</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n            <span class=\"k\">elif</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">has_changed</span><span class=\"p\">():</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">changed_objects</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">((</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">changed_data</span><span class=\"p\">))</span>\n                <span class=\"n\">saved_instances</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">save_existing</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"p\">,</span> <span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">))</span>\n                <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">commit</span><span class=\"p\">:</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">saved_forms</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">saved_instances</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">save_new_objects</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">new_objects</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">for</span> <span class=\"n\">form</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">extra_forms</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">has_changed</span><span class=\"p\">():</span>\n                <span class=\"k\">continue</span>\n            <span class=\"c1\"># If someone has marked an add form for deletion, don&#39;t save the</span>\n            <span class=\"c1\"># object.</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">can_delete</span> <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_should_delete_form</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"p\">):</span>\n                <span class=\"k\">continue</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">new_objects</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">save_new</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">))</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">commit</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">saved_forms</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">new_objects</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">add_fields</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">form</span><span class=\"p\">,</span> <span class=\"n\">index</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Add a hidden field for the object&#39;s primary key.&quot;&quot;&quot;</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">django.db.models</span> <span class=\"kn\">import</span> <span class=\"n\">AutoField</span><span class=\"p\">,</span> <span class=\"n\">ForeignKey</span><span class=\"p\">,</span> <span class=\"n\">OneToOneField</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_pk_field</span> <span class=\"o\">=</span> <span class=\"n\">pk</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">pk</span>\n        <span class=\"c1\"># If a pk isn&#39;t editable, then it won&#39;t be on the form, so we need to</span>\n        <span class=\"c1\"># add it here so we can tell which object is which when we get the</span>\n        <span class=\"c1\"># data back. Generally, pk.editable should be false, but for some</span>\n        <span class=\"c1\"># reason, auto_created pk fields and AutoField&#39;s editable attribute is</span>\n        <span class=\"c1\"># True, so check for that as well.</span>\n\n        <span class=\"k\">def</span> <span class=\"nf\">pk_is_not_editable</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"p\">(</span>\n                <span class=\"p\">(</span><span class=\"ow\">not</span> <span class=\"n\">pk</span><span class=\"o\">.</span><span class=\"n\">editable</span><span class=\"p\">)</span>\n                <span class=\"ow\">or</span> <span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"o\">.</span><span class=\"n\">auto_created</span> <span class=\"ow\">or</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"p\">,</span> <span class=\"n\">AutoField</span><span class=\"p\">))</span>\n                <span class=\"ow\">or</span> <span class=\"p\">(</span>\n                    <span class=\"n\">pk</span><span class=\"o\">.</span><span class=\"n\">remote_field</span>\n                    <span class=\"ow\">and</span> <span class=\"n\">pk</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">parent_link</span>\n                    <span class=\"ow\">and</span> <span class=\"n\">pk_is_not_editable</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">pk</span><span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">pk_is_not_editable</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"n\">pk</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_bound</span><span class=\"p\">:</span>\n                <span class=\"c1\"># If we&#39;re adding the related instance, ignore its primary key</span>\n                <span class=\"c1\"># as it could be an auto-generated default which isn&#39;t actually</span>\n                <span class=\"c1\"># in the database.</span>\n                <span class=\"n\">pk_value</span> <span class=\"o\">=</span> <span class=\"kc\">None</span> <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">_state</span><span class=\"o\">.</span><span class=\"n\">adding</span> <span class=\"k\">else</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">pk</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"k\">try</span><span class=\"p\">:</span>\n                    <span class=\"k\">if</span> <span class=\"n\">index</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                        <span class=\"n\">pk_value</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_queryset</span><span class=\"p\">()[</span><span class=\"n\">index</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">pk</span>\n                    <span class=\"k\">else</span><span class=\"p\">:</span>\n                        <span class=\"n\">pk_value</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n                <span class=\"k\">except</span> <span class=\"ne\">IndexError</span><span class=\"p\">:</span>\n                    <span class=\"n\">pk_value</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"n\">ForeignKey</span><span class=\"p\">,</span> <span class=\"n\">OneToOneField</span><span class=\"p\">)):</span>\n                <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"n\">pk</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_default_manager</span><span class=\"o\">.</span><span class=\"n\">get_queryset</span><span class=\"p\">()</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_default_manager</span><span class=\"o\">.</span><span class=\"n\">get_queryset</span><span class=\"p\">()</span>\n            <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"n\">qs</span><span class=\"o\">.</span><span class=\"n\">using</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">_state</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">widgets</span><span class=\"p\">:</span>\n                <span class=\"n\">widget</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">widgets</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_pk_field</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">HiddenInput</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">widget</span> <span class=\"o\">=</span> <span class=\"n\">HiddenInput</span>\n            <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_pk_field</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">ModelChoiceField</span><span class=\"p\">(</span>\n                <span class=\"n\">qs</span><span class=\"p\">,</span> <span class=\"n\">initial</span><span class=\"o\">=</span><span class=\"n\">pk_value</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">widget</span><span class=\"o\">=</span><span class=\"n\">widget</span>\n            <span class=\"p\">)</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">add_fields</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"p\">,</span> <span class=\"n\">index</span><span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"modelformset_factory\"><a class=\"viewcode-back\" href=\"../../../../ref/forms/models/#django.forms.modelformset_factory\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">modelformset_factory</span><span class=\"p\">(</span>\n    <span class=\"n\">model</span><span class=\"p\">,</span>\n    <span class=\"n\">form</span><span class=\"o\">=</span><span class=\"n\">ModelForm</span><span class=\"p\">,</span>\n    <span class=\"n\">formfield_callback</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">formset</span><span class=\"o\">=</span><span class=\"n\">BaseModelFormSet</span><span class=\"p\">,</span>\n    <span class=\"n\">extra</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span>\n    <span class=\"n\">can_delete</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n    <span class=\"n\">can_order</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n    <span class=\"n\">max_num</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">exclude</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">widgets</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">validate_max</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n    <span class=\"n\">localized_fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">labels</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">help_texts</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">error_messages</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">min_num</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">validate_min</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n    <span class=\"n\">field_classes</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">absolute_max</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">can_delete_extra</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n    <span class=\"n\">renderer</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">edit_only</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n<span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Return a FormSet class for the given Django model class.&quot;&quot;&quot;</span>\n    <span class=\"n\">meta</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Meta&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span>\n        <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">meta</span><span class=\"p\">,</span> <span class=\"s2\">&quot;fields&quot;</span><span class=\"p\">,</span> <span class=\"n\">fields</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span>\n        <span class=\"ow\">and</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">meta</span><span class=\"p\">,</span> <span class=\"s2\">&quot;exclude&quot;</span><span class=\"p\">,</span> <span class=\"n\">exclude</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span>\n    <span class=\"p\">):</span>\n        <span class=\"k\">raise</span> <span class=\"n\">ImproperlyConfigured</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;Calling modelformset_factory without defining &#39;fields&#39; or &quot;</span>\n            <span class=\"s2\">&quot;&#39;exclude&#39; explicitly is prohibited.&quot;</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"n\">modelform_factory</span><span class=\"p\">(</span>\n        <span class=\"n\">model</span><span class=\"p\">,</span>\n        <span class=\"n\">form</span><span class=\"o\">=</span><span class=\"n\">form</span><span class=\"p\">,</span>\n        <span class=\"n\">fields</span><span class=\"o\">=</span><span class=\"n\">fields</span><span class=\"p\">,</span>\n        <span class=\"n\">exclude</span><span class=\"o\">=</span><span class=\"n\">exclude</span><span class=\"p\">,</span>\n        <span class=\"n\">formfield_callback</span><span class=\"o\">=</span><span class=\"n\">formfield_callback</span><span class=\"p\">,</span>\n        <span class=\"n\">widgets</span><span class=\"o\">=</span><span class=\"n\">widgets</span><span class=\"p\">,</span>\n        <span class=\"n\">localized_fields</span><span class=\"o\">=</span><span class=\"n\">localized_fields</span><span class=\"p\">,</span>\n        <span class=\"n\">labels</span><span class=\"o\">=</span><span class=\"n\">labels</span><span class=\"p\">,</span>\n        <span class=\"n\">help_texts</span><span class=\"o\">=</span><span class=\"n\">help_texts</span><span class=\"p\">,</span>\n        <span class=\"n\">error_messages</span><span class=\"o\">=</span><span class=\"n\">error_messages</span><span class=\"p\">,</span>\n        <span class=\"n\">field_classes</span><span class=\"o\">=</span><span class=\"n\">field_classes</span><span class=\"p\">,</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">FormSet</span> <span class=\"o\">=</span> <span class=\"n\">formset_factory</span><span class=\"p\">(</span>\n        <span class=\"n\">form</span><span class=\"p\">,</span>\n        <span class=\"n\">formset</span><span class=\"p\">,</span>\n        <span class=\"n\">extra</span><span class=\"o\">=</span><span class=\"n\">extra</span><span class=\"p\">,</span>\n        <span class=\"n\">min_num</span><span class=\"o\">=</span><span class=\"n\">min_num</span><span class=\"p\">,</span>\n        <span class=\"n\">max_num</span><span class=\"o\">=</span><span class=\"n\">max_num</span><span class=\"p\">,</span>\n        <span class=\"n\">can_order</span><span class=\"o\">=</span><span class=\"n\">can_order</span><span class=\"p\">,</span>\n        <span class=\"n\">can_delete</span><span class=\"o\">=</span><span class=\"n\">can_delete</span><span class=\"p\">,</span>\n        <span class=\"n\">validate_min</span><span class=\"o\">=</span><span class=\"n\">validate_min</span><span class=\"p\">,</span>\n        <span class=\"n\">validate_max</span><span class=\"o\">=</span><span class=\"n\">validate_max</span><span class=\"p\">,</span>\n        <span class=\"n\">absolute_max</span><span class=\"o\">=</span><span class=\"n\">absolute_max</span><span class=\"p\">,</span>\n        <span class=\"n\">can_delete_extra</span><span class=\"o\">=</span><span class=\"n\">can_delete_extra</span><span class=\"p\">,</span>\n        <span class=\"n\">renderer</span><span class=\"o\">=</span><span class=\"n\">renderer</span><span class=\"p\">,</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">FormSet</span><span class=\"o\">.</span><span class=\"n\">model</span> <span class=\"o\">=</span> <span class=\"n\">model</span>\n    <span class=\"n\">FormSet</span><span class=\"o\">.</span><span class=\"n\">edit_only</span> <span class=\"o\">=</span> <span class=\"n\">edit_only</span>\n    <span class=\"k\">return</span> <span class=\"n\">FormSet</span></div>\n\n\n<span class=\"c1\"># InlineFormSets #############################################################</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">BaseInlineFormSet</span><span class=\"p\">(</span><span class=\"n\">BaseModelFormSet</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;A formset for child objects related to a parent.&quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">data</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">files</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">instance</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">save_as_new</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">queryset</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">instance</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">()</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span> <span class=\"o\">=</span> <span class=\"n\">instance</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">save_as_new</span> <span class=\"o\">=</span> <span class=\"n\">save_as_new</span>\n        <span class=\"k\">if</span> <span class=\"n\">queryset</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_default_manager</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">pk</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"p\">{</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"p\">})</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">none</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">unique_fields</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">}</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">files</span><span class=\"p\">,</span> <span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"n\">prefix</span><span class=\"p\">,</span> <span class=\"n\">queryset</span><span class=\"o\">=</span><span class=\"n\">qs</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Add the generated field to form._meta.fields if it&#39;s defined to make</span>\n        <span class=\"c1\"># sure validation isn&#39;t skipped on that field.</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">fields</span> <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">,</span> <span class=\"nb\">tuple</span><span class=\"p\">):</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">fields</span> <span class=\"o\">=</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">initial_form_count</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">save_as_new</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"mi\">0</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">initial_form_count</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_construct_form</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"n\">form</span> <span class=\"o\">=</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">_construct_form</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">save_as_new</span><span class=\"p\">:</span>\n            <span class=\"n\">mutable</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_mutable&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n            <span class=\"c1\"># Allow modifying an immutable QueryDict.</span>\n            <span class=\"k\">if</span> <span class=\"n\">mutable</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">_mutable</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n            <span class=\"c1\"># Remove the primary key from the form&#39;s data, we are only</span>\n            <span class=\"c1\"># creating new instances</span>\n            <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"p\">[</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">add_prefix</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_pk_field</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n            <span class=\"c1\"># Remove the foreign key from the form&#39;s data</span>\n            <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"p\">[</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">add_prefix</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n            <span class=\"k\">if</span> <span class=\"n\">mutable</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">_mutable</span> <span class=\"o\">=</span> <span class=\"n\">mutable</span>\n\n        <span class=\"c1\"># Set the fk value here so that the form can do its validation.</span>\n        <span class=\"n\">fk_value</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">pk</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">field_name</span> <span class=\"o\">!=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">pk</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">:</span>\n            <span class=\"n\">fk_value</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">field_name</span><span class=\"p\">)</span>\n            <span class=\"n\">fk_value</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">fk_value</span><span class=\"p\">,</span> <span class=\"s2\">&quot;pk&quot;</span><span class=\"p\">,</span> <span class=\"n\">fk_value</span><span class=\"p\">)</span>\n        <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">get_attname</span><span class=\"p\">(),</span> <span class=\"n\">fk_value</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">form</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">get_default_prefix</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">get_accessor_name</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">=</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s2\">&quot;+&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">save_new</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">form</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Ensure the latest copy of the related instance is present on each</span>\n        <span class=\"c1\"># form (it may have been saved after the formset was originally</span>\n        <span class=\"c1\"># instantiated).</span>\n        <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">save_new</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">add_fields</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">form</span><span class=\"p\">,</span> <span class=\"n\">index</span><span class=\"p\">):</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">add_fields</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"p\">,</span> <span class=\"n\">index</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_pk_field</span> <span class=\"o\">==</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"p\">:</span>\n            <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_pk_field</span><span class=\"o\">.</span><span class=\"n\">name</span>\n            <span class=\"n\">kwargs</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s2\">&quot;pk_field&quot;</span><span class=\"p\">:</span> <span class=\"kc\">True</span><span class=\"p\">}</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"c1\"># The foreign key field might not be on the form, so we poke at the</span>\n            <span class=\"c1\"># Model field to get the label, since we need that for error messages.</span>\n            <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">name</span>\n            <span class=\"n\">kwargs</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n                <span class=\"s2\">&quot;label&quot;</span><span class=\"p\">:</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span>\n                    <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">),</span> <span class=\"s2\">&quot;label&quot;</span><span class=\"p\">,</span> <span class=\"n\">capfirst</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">verbose_name</span><span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">}</span>\n\n        <span class=\"c1\"># The InlineForeignKeyField assumes that the foreign key relation is</span>\n        <span class=\"c1\"># based on the parent model&#39;s pk. If this isn&#39;t the case, set to_field</span>\n        <span class=\"c1\"># to correctly resolve the initial form value.</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">field_name</span> <span class=\"o\">!=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">pk</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">:</span>\n            <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;to_field&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">field_name</span>\n\n        <span class=\"c1\"># If we&#39;re adding a new object, ignore a parent&#39;s auto-generated key</span>\n        <span class=\"c1\"># as it will be regenerated on the save request.</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">_state</span><span class=\"o\">.</span><span class=\"n\">adding</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">kwargs</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;to_field&quot;</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"n\">to_field</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span><span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;to_field&quot;</span><span class=\"p\">])</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">to_field</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">pk</span>\n            <span class=\"k\">if</span> <span class=\"n\">to_field</span><span class=\"o\">.</span><span class=\"n\">has_default</span><span class=\"p\">():</span>\n                <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">to_field</span><span class=\"o\">.</span><span class=\"n\">attname</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n\n        <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">[</span><span class=\"n\">name</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">InlineForeignKeyField</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_unique_error_message</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">unique_check</span><span class=\"p\">):</span>\n        <span class=\"n\">unique_check</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">field</span> <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">unique_check</span> <span class=\"k\">if</span> <span class=\"n\">field</span> <span class=\"o\">!=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">]</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">get_unique_error_message</span><span class=\"p\">(</span><span class=\"n\">unique_check</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_get_foreign_key</span><span class=\"p\">(</span><span class=\"n\">parent_model</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">fk_name</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">can_fail</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Find and return the ForeignKey from model to parent if there is one</span>\n<span class=\"sd\">    (return None if can_fail is True and no such field exists). If fk_name is</span>\n<span class=\"sd\">    provided, assume it is the name of the ForeignKey field. Unless can_fail is</span>\n<span class=\"sd\">    True, raise an exception if there isn&#39;t a ForeignKey from model to</span>\n<span class=\"sd\">    parent_model.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"c1\"># avoid circular import</span>\n    <span class=\"kn\">from</span> <span class=\"nn\">django.db.models</span> <span class=\"kn\">import</span> <span class=\"n\">ForeignKey</span>\n\n    <span class=\"n\">opts</span> <span class=\"o\">=</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span>\n    <span class=\"k\">if</span> <span class=\"n\">fk_name</span><span class=\"p\">:</span>\n        <span class=\"n\">fks_to_parent</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">f</span> <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">fields</span> <span class=\"k\">if</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"n\">fk_name</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">fks_to_parent</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n            <span class=\"n\">fk</span> <span class=\"o\">=</span> <span class=\"n\">fks_to_parent</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n            <span class=\"n\">parent_list</span> <span class=\"o\">=</span> <span class=\"n\">parent_model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_parent_list</span><span class=\"p\">()</span>\n            <span class=\"k\">if</span> <span class=\"p\">(</span>\n                <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">fk</span><span class=\"p\">,</span> <span class=\"n\">ForeignKey</span><span class=\"p\">)</span>\n                <span class=\"ow\">or</span> <span class=\"p\">(</span>\n                    <span class=\"c1\"># ForeignKey to proxy models.</span>\n                    <span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">proxy</span>\n                    <span class=\"ow\">and</span> <span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">proxy_for_model</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">parent_list</span>\n                <span class=\"p\">)</span>\n                <span class=\"ow\">or</span> <span class=\"p\">(</span>\n                    <span class=\"c1\"># ForeignKey to concrete models.</span>\n                    <span class=\"ow\">not</span> <span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">proxy</span>\n                    <span class=\"ow\">and</span> <span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">model</span> <span class=\"o\">!=</span> <span class=\"n\">parent_model</span>\n                    <span class=\"ow\">and</span> <span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">model</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">parent_list</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">):</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;fk_name &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; is not a ForeignKey to &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39;.&quot;</span>\n                    <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">fk_name</span><span class=\"p\">,</span> <span class=\"n\">parent_model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">label</span><span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"ow\">not</span> <span class=\"n\">fks_to_parent</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;&#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; has no field named &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39;.&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">label</span><span class=\"p\">,</span> <span class=\"n\">fk_name</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"c1\"># Try to discover what the ForeignKey from model to parent_model is</span>\n        <span class=\"n\">parent_list</span> <span class=\"o\">=</span> <span class=\"n\">parent_model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_parent_list</span><span class=\"p\">()</span>\n        <span class=\"n\">fks_to_parent</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n            <span class=\"n\">f</span>\n            <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">fields</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">,</span> <span class=\"n\">ForeignKey</span><span class=\"p\">)</span>\n            <span class=\"ow\">and</span> <span class=\"p\">(</span>\n                <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">model</span> <span class=\"o\">==</span> <span class=\"n\">parent_model</span>\n                <span class=\"ow\">or</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">model</span> <span class=\"ow\">in</span> <span class=\"n\">parent_list</span>\n                <span class=\"ow\">or</span> <span class=\"p\">(</span>\n                    <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">proxy</span>\n                    <span class=\"ow\">and</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">proxy_for_model</span> <span class=\"ow\">in</span> <span class=\"n\">parent_list</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">fks_to_parent</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n            <span class=\"n\">fk</span> <span class=\"o\">=</span> <span class=\"n\">fks_to_parent</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n        <span class=\"k\">elif</span> <span class=\"ow\">not</span> <span class=\"n\">fks_to_parent</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">can_fail</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;&#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; has no ForeignKey to &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39;.&quot;</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span>\n                    <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">label</span><span class=\"p\">,</span>\n                    <span class=\"n\">parent_model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">label</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;&#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; has more than one ForeignKey to &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39;. You must specify &quot;</span>\n                <span class=\"s2\">&quot;a &#39;fk_name&#39; attribute.&quot;</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span>\n                    <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">label</span><span class=\"p\">,</span>\n                    <span class=\"n\">parent_model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">label</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">fk</span>\n\n\n<div class=\"viewcode-block\" id=\"inlineformset_factory\"><a class=\"viewcode-back\" href=\"../../../../ref/forms/models/#django.forms.inlineformset_factory\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">inlineformset_factory</span><span class=\"p\">(</span>\n    <span class=\"n\">parent_model</span><span class=\"p\">,</span>\n    <span class=\"n\">model</span><span class=\"p\">,</span>\n    <span class=\"n\">form</span><span class=\"o\">=</span><span class=\"n\">ModelForm</span><span class=\"p\">,</span>\n    <span class=\"n\">formset</span><span class=\"o\">=</span><span class=\"n\">BaseInlineFormSet</span><span class=\"p\">,</span>\n    <span class=\"n\">fk_name</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">exclude</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">extra</span><span class=\"o\">=</span><span class=\"mi\">3</span><span class=\"p\">,</span>\n    <span class=\"n\">can_order</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n    <span class=\"n\">can_delete</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n    <span class=\"n\">max_num</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">formfield_callback</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">widgets</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">validate_max</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n    <span class=\"n\">localized_fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">labels</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">help_texts</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">error_messages</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">min_num</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">validate_min</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n    <span class=\"n\">field_classes</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">absolute_max</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">can_delete_extra</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n    <span class=\"n\">renderer</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">edit_only</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n<span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Return an ``InlineFormSet`` for the given kwargs.</span>\n\n<span class=\"sd\">    ``fk_name`` must be provided if ``model`` has more than one ``ForeignKey``</span>\n<span class=\"sd\">    to ``parent_model``.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">fk</span> <span class=\"o\">=</span> <span class=\"n\">_get_foreign_key</span><span class=\"p\">(</span><span class=\"n\">parent_model</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">fk_name</span><span class=\"o\">=</span><span class=\"n\">fk_name</span><span class=\"p\">)</span>\n    <span class=\"c1\"># enforce a max_num=1 when the foreign key to the parent model is unique.</span>\n    <span class=\"k\">if</span> <span class=\"n\">fk</span><span class=\"o\">.</span><span class=\"n\">unique</span><span class=\"p\">:</span>\n        <span class=\"n\">max_num</span> <span class=\"o\">=</span> <span class=\"mi\">1</span>\n    <span class=\"n\">kwargs</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s2\">&quot;form&quot;</span><span class=\"p\">:</span> <span class=\"n\">form</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;formfield_callback&quot;</span><span class=\"p\">:</span> <span class=\"n\">formfield_callback</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;formset&quot;</span><span class=\"p\">:</span> <span class=\"n\">formset</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;extra&quot;</span><span class=\"p\">:</span> <span class=\"n\">extra</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;can_delete&quot;</span><span class=\"p\">:</span> <span class=\"n\">can_delete</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;can_order&quot;</span><span class=\"p\">:</span> <span class=\"n\">can_order</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;fields&quot;</span><span class=\"p\">:</span> <span class=\"n\">fields</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;exclude&quot;</span><span class=\"p\">:</span> <span class=\"n\">exclude</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;min_num&quot;</span><span class=\"p\">:</span> <span class=\"n\">min_num</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;max_num&quot;</span><span class=\"p\">:</span> <span class=\"n\">max_num</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;widgets&quot;</span><span class=\"p\">:</span> <span class=\"n\">widgets</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;validate_min&quot;</span><span class=\"p\">:</span> <span class=\"n\">validate_min</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;validate_max&quot;</span><span class=\"p\">:</span> <span class=\"n\">validate_max</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;localized_fields&quot;</span><span class=\"p\">:</span> <span class=\"n\">localized_fields</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;labels&quot;</span><span class=\"p\">:</span> <span class=\"n\">labels</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;help_texts&quot;</span><span class=\"p\">:</span> <span class=\"n\">help_texts</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;error_messages&quot;</span><span class=\"p\">:</span> <span class=\"n\">error_messages</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;field_classes&quot;</span><span class=\"p\">:</span> <span class=\"n\">field_classes</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;absolute_max&quot;</span><span class=\"p\">:</span> <span class=\"n\">absolute_max</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;can_delete_extra&quot;</span><span class=\"p\">:</span> <span class=\"n\">can_delete_extra</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;renderer&quot;</span><span class=\"p\">:</span> <span class=\"n\">renderer</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;edit_only&quot;</span><span class=\"p\">:</span> <span class=\"n\">edit_only</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"n\">FormSet</span> <span class=\"o\">=</span> <span class=\"n\">modelformset_factory</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n    <span class=\"n\">FormSet</span><span class=\"o\">.</span><span class=\"n\">fk</span> <span class=\"o\">=</span> <span class=\"n\">fk</span>\n    <span class=\"k\">return</span> <span class=\"n\">FormSet</span></div>\n\n\n<span class=\"c1\"># Fields #####################################################################</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">InlineForeignKeyField</span><span class=\"p\">(</span><span class=\"n\">Field</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    A basic integer field that deals with validating the given value to a</span>\n<span class=\"sd\">    given parent instance in an inline.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"n\">widget</span> <span class=\"o\">=</span> <span class=\"n\">HiddenInput</span>\n    <span class=\"n\">default_error_messages</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s2\">&quot;invalid_choice&quot;</span><span class=\"p\">:</span> <span class=\"n\">_</span><span class=\"p\">(</span><span class=\"s2\">&quot;The inline value did not match the parent instance.&quot;</span><span class=\"p\">),</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">parent_instance</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">pk_field</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">to_field</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">parent_instance</span> <span class=\"o\">=</span> <span class=\"n\">parent_instance</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">pk_field</span> <span class=\"o\">=</span> <span class=\"n\">pk_field</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">to_field</span> <span class=\"o\">=</span> <span class=\"n\">to_field</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">parent_instance</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">to_field</span><span class=\"p\">:</span>\n                <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;initial&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">parent_instance</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">to_field</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;initial&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">parent_instance</span><span class=\"o\">.</span><span class=\"n\">pk</span>\n        <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;required&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">clean</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">empty_values</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">pk_field</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span> <span class=\"kc\">None</span>\n            <span class=\"c1\"># if there is no value act as we did before.</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">parent_instance</span>\n        <span class=\"c1\"># ensure the we compare the values as equal types.</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">to_field</span><span class=\"p\">:</span>\n            <span class=\"n\">orig</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">parent_instance</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">to_field</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">orig</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">parent_instance</span><span class=\"o\">.</span><span class=\"n\">pk</span>\n        <span class=\"k\">if</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span> <span class=\"o\">!=</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">orig</span><span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"n\">ValidationError</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">error_messages</span><span class=\"p\">[</span><span class=\"s2\">&quot;invalid_choice&quot;</span><span class=\"p\">],</span> <span class=\"n\">code</span><span class=\"o\">=</span><span class=\"s2\">&quot;invalid_choice&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">parent_instance</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">has_changed</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">initial</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">ModelChoiceIteratorValue</span><span class=\"p\">:</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance</span> <span class=\"o\">=</span> <span class=\"n\">instance</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__str__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__hash__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"nb\">hash</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__eq__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">other</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">ModelChoiceIteratorValue</span><span class=\"p\">):</span>\n            <span class=\"n\">other</span> <span class=\"o\">=</span> <span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">value</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"o\">==</span> <span class=\"n\">other</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">ModelChoiceIterator</span><span class=\"p\">:</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">field</span> <span class=\"o\">=</span> <span class=\"n\">field</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">queryset</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__iter__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">empty_label</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">yield</span> <span class=\"p\">(</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">empty_label</span><span class=\"p\">)</span>\n        <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span>\n        <span class=\"c1\"># Can&#39;t use iterator() when queryset uses prefetch_related()</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span><span class=\"p\">:</span>\n            <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">iterator</span><span class=\"p\">()</span>\n        <span class=\"k\">for</span> <span class=\"n\">obj</span> <span class=\"ow\">in</span> <span class=\"n\">queryset</span><span class=\"p\">:</span>\n            <span class=\"k\">yield</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">choice</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__len__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"c1\"># count() adds a query but uses less memory since the QuerySet results</span>\n        <span class=\"c1\"># won&#39;t be cached. In most cases, the choices will only be iterated on,</span>\n        <span class=\"c1\"># and __len__() won&#39;t be called.</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"p\">(</span><span class=\"mi\">1</span> <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">empty_label</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"k\">else</span> <span class=\"mi\">0</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__bool__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">empty_label</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">or</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">choice</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">obj</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">(</span>\n            <span class=\"n\">ModelChoiceIteratorValue</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">prepare_value</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">),</span> <span class=\"n\">obj</span><span class=\"p\">),</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">label_from_instance</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"ModelChoiceField\"><a class=\"viewcode-back\" href=\"../../../../ref/forms/fields/#django.forms.ModelChoiceField\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">ModelChoiceField</span><span class=\"p\">(</span><span class=\"n\">ChoiceField</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;A ChoiceField whose choices are a model QuerySet.&quot;&quot;&quot;</span>\n\n    <span class=\"c1\"># This class is a subclass of ChoiceField for purity, but it doesn&#39;t</span>\n    <span class=\"c1\"># actually use any of ChoiceField&#39;s implementation.</span>\n    <span class=\"n\">default_error_messages</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s2\">&quot;invalid_choice&quot;</span><span class=\"p\">:</span> <span class=\"n\">_</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;Select a valid choice. That choice is not one of the available choices.&quot;</span>\n        <span class=\"p\">),</span>\n    <span class=\"p\">}</span>\n    <span class=\"n\">iterator</span> <span class=\"o\">=</span> <span class=\"n\">ModelChoiceIterator</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">queryset</span><span class=\"p\">,</span>\n        <span class=\"o\">*</span><span class=\"p\">,</span>\n        <span class=\"n\">empty_label</span><span class=\"o\">=</span><span class=\"s2\">&quot;---------&quot;</span><span class=\"p\">,</span>\n        <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n        <span class=\"n\">widget</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">label</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">initial</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">help_text</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span>\n        <span class=\"n\">to_field_name</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">limit_choices_to</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">blank</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"c1\"># Call Field instead of ChoiceField __init__() because we don&#39;t need</span>\n        <span class=\"c1\"># ChoiceField.__init__().</span>\n        <span class=\"n\">Field</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"p\">,</span>\n            <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"n\">required</span><span class=\"p\">,</span>\n            <span class=\"n\">widget</span><span class=\"o\">=</span><span class=\"n\">widget</span><span class=\"p\">,</span>\n            <span class=\"n\">label</span><span class=\"o\">=</span><span class=\"n\">label</span><span class=\"p\">,</span>\n            <span class=\"n\">initial</span><span class=\"o\">=</span><span class=\"n\">initial</span><span class=\"p\">,</span>\n            <span class=\"n\">help_text</span><span class=\"o\">=</span><span class=\"n\">help_text</span><span class=\"p\">,</span>\n            <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">required</span> <span class=\"ow\">and</span> <span class=\"n\">initial</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"p\">(</span>\n            <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">widget</span><span class=\"p\">,</span> <span class=\"n\">RadioSelect</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">blank</span>\n        <span class=\"p\">):</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">empty_label</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">empty_label</span> <span class=\"o\">=</span> <span class=\"n\">empty_label</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"n\">queryset</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">limit_choices_to</span> <span class=\"o\">=</span> <span class=\"n\">limit_choices_to</span>  <span class=\"c1\"># limit the queryset later.</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">to_field_name</span> <span class=\"o\">=</span> <span class=\"n\">to_field_name</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_limit_choices_to</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return ``limit_choices_to`` for this form field.</span>\n\n<span class=\"sd\">        If it is a callable, invoke it and return the result.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">callable</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">limit_choices_to</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">limit_choices_to</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">limit_choices_to</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">__deepcopy__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">memo</span><span class=\"p\">):</span>\n        <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">ChoiceField</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">__deepcopy__</span><span class=\"p\">(</span><span class=\"n\">memo</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Need to force a new ModelChoiceIterator to be created, bug #11183</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">result</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_get_queryset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_queryset</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_set_queryset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">queryset</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_queryset</span> <span class=\"o\">=</span> <span class=\"kc\">None</span> <span class=\"k\">if</span> <span class=\"n\">queryset</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"k\">else</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">widget</span><span class=\"o\">.</span><span class=\"n\">choices</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">choices</span>\n\n    <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"nb\">property</span><span class=\"p\">(</span><span class=\"n\">_get_queryset</span><span class=\"p\">,</span> <span class=\"n\">_set_queryset</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># this method will be used to create object labels by the QuerySetIterator.</span>\n    <span class=\"c1\"># Override it to customize the label.</span>\n    <span class=\"k\">def</span> <span class=\"nf\">label_from_instance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">obj</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Convert objects into strings and generate the labels for the choices</span>\n<span class=\"sd\">        presented by this object. Subclasses can override this method to</span>\n<span class=\"sd\">        customize the display of the choices.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_get_choices</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"c1\"># If self._choices is set, then somebody must have manually set</span>\n        <span class=\"c1\"># the property self.choices. In this case, just return self._choices.</span>\n        <span class=\"k\">if</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_choices&quot;</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_choices</span>\n\n        <span class=\"c1\"># Otherwise, execute the QuerySet in self.queryset to determine the</span>\n        <span class=\"c1\"># choices dynamically. Return a fresh ModelChoiceIterator that has not been</span>\n        <span class=\"c1\"># consumed. Note that we&#39;re instantiating a new ModelChoiceIterator *each*</span>\n        <span class=\"c1\"># time _get_choices() is called (and, thus, each time self.choices is</span>\n        <span class=\"c1\"># accessed) so that we can ensure the QuerySet has not been consumed. This</span>\n        <span class=\"c1\"># construct might look complicated but it allows for lazy evaluation of</span>\n        <span class=\"c1\"># the queryset.</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">iterator</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n\n    <span class=\"n\">choices</span> <span class=\"o\">=</span> <span class=\"nb\">property</span><span class=\"p\">(</span><span class=\"n\">_get_choices</span><span class=\"p\">,</span> <span class=\"n\">ChoiceField</span><span class=\"o\">.</span><span class=\"n\">_set_choices</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">prepare_value</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_meta&quot;</span><span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">to_field_name</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">serializable_value</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">to_field_name</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">pk</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">prepare_value</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">to_python</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">empty_values</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">key</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">to_field_name</span> <span class=\"ow\">or</span> <span class=\"s2\">&quot;pk&quot;</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">):</span>\n                <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">)</span>\n            <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"p\">{</span><span class=\"n\">key</span><span class=\"p\">:</span> <span class=\"n\">value</span><span class=\"p\">})</span>\n        <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">ValueError</span><span class=\"p\">,</span> <span class=\"ne\">TypeError</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"n\">ValidationError</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">error_messages</span><span class=\"p\">[</span><span class=\"s2\">&quot;invalid_choice&quot;</span><span class=\"p\">],</span>\n                <span class=\"n\">code</span><span class=\"o\">=</span><span class=\"s2\">&quot;invalid_choice&quot;</span><span class=\"p\">,</span>\n                <span class=\"n\">params</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;value&quot;</span><span class=\"p\">:</span> <span class=\"n\">value</span><span class=\"p\">},</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">value</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">validate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">Field</span><span class=\"o\">.</span><span class=\"n\">validate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">has_changed</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">initial</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">disabled</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n        <span class=\"n\">initial_value</span> <span class=\"o\">=</span> <span class=\"n\">initial</span> <span class=\"k\">if</span> <span class=\"n\">initial</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"k\">else</span> <span class=\"s2\">&quot;&quot;</span>\n        <span class=\"n\">data_value</span> <span class=\"o\">=</span> <span class=\"n\">data</span> <span class=\"k\">if</span> <span class=\"n\">data</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"k\">else</span> <span class=\"s2\">&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prepare_value</span><span class=\"p\">(</span><span class=\"n\">initial_value</span><span class=\"p\">))</span> <span class=\"o\">!=</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">data_value</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"ModelMultipleChoiceField\"><a class=\"viewcode-back\" href=\"../../../../ref/forms/fields/#django.forms.ModelMultipleChoiceField\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">ModelMultipleChoiceField</span><span class=\"p\">(</span><span class=\"n\">ModelChoiceField</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;A MultipleChoiceField whose choices are a model QuerySet.&quot;&quot;&quot;</span>\n\n    <span class=\"n\">widget</span> <span class=\"o\">=</span> <span class=\"n\">SelectMultiple</span>\n    <span class=\"n\">hidden_widget</span> <span class=\"o\">=</span> <span class=\"n\">MultipleHiddenInput</span>\n    <span class=\"n\">default_error_messages</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s2\">&quot;invalid_list&quot;</span><span class=\"p\">:</span> <span class=\"n\">_</span><span class=\"p\">(</span><span class=\"s2\">&quot;Enter a list of values.&quot;</span><span class=\"p\">),</span>\n        <span class=\"s2\">&quot;invalid_choice&quot;</span><span class=\"p\">:</span> <span class=\"n\">_</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;Select a valid choice. </span><span class=\"si\">%(value)s</span><span class=\"s2\"> is not one of the available choices.&quot;</span>\n        <span class=\"p\">),</span>\n        <span class=\"s2\">&quot;invalid_pk_value&quot;</span><span class=\"p\">:</span> <span class=\"n\">_</span><span class=\"p\">(</span><span class=\"s2\">&quot;\u201c</span><span class=\"si\">%(pk)s</span><span class=\"s2\">\u201d is not a valid value.&quot;</span><span class=\"p\">),</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">queryset</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"n\">queryset</span><span class=\"p\">,</span> <span class=\"n\">empty_label</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">to_python</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">value</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"p\">[]</span>\n        <span class=\"k\">return</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_check_values</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">))</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">clean</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">):</span>\n        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prepare_value</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">value</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"n\">ValidationError</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">error_messages</span><span class=\"p\">[</span><span class=\"s2\">&quot;required&quot;</span><span class=\"p\">],</span> <span class=\"n\">code</span><span class=\"o\">=</span><span class=\"s2\">&quot;required&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">value</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">none</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nb\">list</span><span class=\"p\">,</span> <span class=\"nb\">tuple</span><span class=\"p\">)):</span>\n            <span class=\"k\">raise</span> <span class=\"n\">ValidationError</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">error_messages</span><span class=\"p\">[</span><span class=\"s2\">&quot;invalid_list&quot;</span><span class=\"p\">],</span>\n                <span class=\"n\">code</span><span class=\"o\">=</span><span class=\"s2\">&quot;invalid_list&quot;</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n        <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_check_values</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Since this overrides the inherited ModelChoiceField.clean</span>\n        <span class=\"c1\"># we run custom validators here</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">run_validators</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">qs</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_check_values</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Given a list of possible PK values, return a QuerySet of the</span>\n<span class=\"sd\">        corresponding objects. Raise a ValidationError if a given value is</span>\n<span class=\"sd\">        invalid (not a valid PK, not in the queryset, etc.)</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">key</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">to_field_name</span> <span class=\"ow\">or</span> <span class=\"s2\">&quot;pk&quot;</span>\n        <span class=\"c1\"># deduplicate given values to avoid creating many querysets or</span>\n        <span class=\"c1\"># requiring the database backend deduplicate efficiently.</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"nb\">frozenset</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"ne\">TypeError</span><span class=\"p\">:</span>\n            <span class=\"c1\"># list of lists isn&#39;t hashable, for example</span>\n            <span class=\"k\">raise</span> <span class=\"n\">ValidationError</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">error_messages</span><span class=\"p\">[</span><span class=\"s2\">&quot;invalid_list&quot;</span><span class=\"p\">],</span>\n                <span class=\"n\">code</span><span class=\"o\">=</span><span class=\"s2\">&quot;invalid_list&quot;</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">pk</span> <span class=\"ow\">in</span> <span class=\"n\">value</span><span class=\"p\">:</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"p\">{</span><span class=\"n\">key</span><span class=\"p\">:</span> <span class=\"n\">pk</span><span class=\"p\">})</span>\n            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">ValueError</span><span class=\"p\">,</span> <span class=\"ne\">TypeError</span><span class=\"p\">):</span>\n                <span class=\"k\">raise</span> <span class=\"n\">ValidationError</span><span class=\"p\">(</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">error_messages</span><span class=\"p\">[</span><span class=\"s2\">&quot;invalid_pk_value&quot;</span><span class=\"p\">],</span>\n                    <span class=\"n\">code</span><span class=\"o\">=</span><span class=\"s2\">&quot;invalid_pk_value&quot;</span><span class=\"p\">,</span>\n                    <span class=\"n\">params</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;pk&quot;</span><span class=\"p\">:</span> <span class=\"n\">pk</span><span class=\"p\">},</span>\n                <span class=\"p\">)</span>\n        <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"p\">{</span><span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\">__in&quot;</span> <span class=\"o\">%</span> <span class=\"n\">key</span><span class=\"p\">:</span> <span class=\"n\">value</span><span class=\"p\">})</span>\n        <span class=\"n\">pks</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">))</span> <span class=\"k\">for</span> <span class=\"n\">o</span> <span class=\"ow\">in</span> <span class=\"n\">qs</span><span class=\"p\">}</span>\n        <span class=\"k\">for</span> <span class=\"n\">val</span> <span class=\"ow\">in</span> <span class=\"n\">value</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">)</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">pks</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"n\">ValidationError</span><span class=\"p\">(</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">error_messages</span><span class=\"p\">[</span><span class=\"s2\">&quot;invalid_choice&quot;</span><span class=\"p\">],</span>\n                    <span class=\"n\">code</span><span class=\"o\">=</span><span class=\"s2\">&quot;invalid_choice&quot;</span><span class=\"p\">,</span>\n                    <span class=\"n\">params</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;value&quot;</span><span class=\"p\">:</span> <span class=\"n\">val</span><span class=\"p\">},</span>\n                <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">qs</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">prepare_value</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"s2\">&quot;__iter__&quot;</span><span class=\"p\">)</span>\n            <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">)</span>\n            <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_meta&quot;</span><span class=\"p\">)</span>\n        <span class=\"p\">):</span>\n            <span class=\"n\">prepare_value</span> <span class=\"o\">=</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">prepare_value</span>\n            <span class=\"k\">return</span> <span class=\"p\">[</span><span class=\"n\">prepare_value</span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">v</span> <span class=\"ow\">in</span> <span class=\"n\">value</span><span class=\"p\">]</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">prepare_value</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">has_changed</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">initial</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">disabled</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n        <span class=\"k\">if</span> <span class=\"n\">initial</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">initial</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">if</span> <span class=\"n\">data</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">initial</span><span class=\"p\">)</span> <span class=\"o\">!=</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"kc\">True</span>\n        <span class=\"n\">initial_set</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prepare_value</span><span class=\"p\">(</span><span class=\"n\">initial</span><span class=\"p\">)}</span>\n        <span class=\"n\">data_set</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"p\">}</span>\n        <span class=\"k\">return</span> <span class=\"n\">data_set</span> <span class=\"o\">!=</span> <span class=\"n\">initial_set</span></div>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">modelform_defines_fields</span><span class=\"p\">(</span><span class=\"n\">form_class</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">form_class</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_meta&quot;</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"p\">(</span>\n        <span class=\"n\">form_class</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">fields</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">or</span> <span class=\"n\">form_class</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">exclude</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n    <span class=\"p\">)</span>\n</pre></div>", "current_page_name": "_modules/django/forms/models", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "favicon_url": null, "logo_url": null, "alabaster_version": "0.7.13", "include_console_assets": false}